---
title: "tcga_pancancer_analysis"
author: "Tao Wu"
date: "`r Sys.Date()`"
output:   
  rmdformats::readthedown:
    highlight: kate
    lightbox: false
    toc_depth: 3
    mathjax: true
---

```{r tcga_pancancer_analysis-setup, include=FALSE}
options(max.print = "75")
knitr::opts_chunk$set(echo = TRUE, comment = "#>", eval = TRUE, collapse = TRUE)
knitr::opts_knit$set(width = 75)
```
```{r lib,echo=TRUE,eval=TRUE,include=FALSE}
library(tidyverse)
library(ggpubr)
library(cowplot)
library(viridis)
library(NeoEnrichment)
```

##  The existence of significant immunoediting signal

From our pan-cancer data, we can get two distributions: mutation counts of samples and IC50 values of neoantigens. 
We randomly selected 10000 counts from the distribution of mutation counts to construct simulated samples which each sample has its own mutation counts. For each mutations in a simulated sample, we randomly selected a IC50 value from IC50 distribution. Now we have 10000 samples, each sample has its mutation counts and each mutations has its IC50 values. Given that CCF or expression is a criterion for ranking, we just used the natural order to rank the simulated mutations. At last, we calculated NES for these simulated samples to get neutral distribution of NES.

The following code do this simulation step for each cancer type:

```{r simulation,eval=FALSE}
pancancer_neoantigen_exp_ccf <- readRDS("~/Immunoediting/data/pancancer_neoantigen_exp_ccf.rds")
pancancer_neoantigen_exp_ccf <- pancancer_neoantigen_exp_ccf %>%
  rename(sample=Tumor_Barcode,chromosome=chr,position=Stop,MT_mean=MT_har_mean) %>% 
  as.data.frame(stringsAsFactors=FALSE)
cancer_type <- names(table(pancancer_neoantigen_exp_ccf$cancer_type))
set.seed(202011104)
for (i in 1:length(cancer_type)){
  cancer <- pancancer_neoantigen_exp_ccf %>% 
    dplyr::filter(cancer_type==.env$cancer_type[i])
  cancer %>% group_by(sample) %>%
    summarise(mutation_counts=n()) -> mutation_counts
  ##sampling mutation counts
  sample_mt <- sample(mutation_counts$mutation_counts,10000,replace = T)
  
  sample <- vector("list",length = 10000)
  names(sample) <- c(1:10000)
  sample <- lapply(sample_mt,
                    function(x){
                      tmp <- data.frame(mutation_id=c(1:x),
                                        IC50=sample(cancer$MT_mean,x),##sample IC50 for mutations
                                        rank=c(x:1))
                      a <- nrow(tmp)
                      tmp <- tmp %>% 
                        mutate(rank=abs((a/2)-rank)+1)
                      return(tmp)
                    })
  
  result <- vector("list",length = 10000)
  names(result) <- c(1:10000)
  cl <- makeCluster(getOption("cl.cores", 12),type="FORK")
  result <- parLapply(cl=cl,sample,
                          function(x){
                            neoantigen_list <- x %>% 
                              filter(IC50<500) %>% 
                              select(mutation_id)
                            neoantigen_list <- neoantigen_list[[1]]
                            if(length(neoantigen_list)==0){
                              return(NA)
                            }else{
                              es <- NeoEnrichment::cales_simulation(x,neoantigen_list)
                              nes <- NeoEnrichment::cal_nes_simulation(es,neoantigen_list,x)
                              return(nes)
                            }
                          })
  stopCluster(cl)
  
  result <- Filter(function(x){length(x)>1},result)
  result_sim <- bind_rows(result)
  saveRDS(result_sim,
          file = paste0("~/Immunoediting/data/simulation/",cancer_type[i],"_simulation.rds"))
}
```
Then we bind all cancer type simulation data:

```{r bind_sim,eval=FALSE}
bind_all <- lapply(list.files("~/Immunoediting/data/simulation/"),
                   function(x){
                     re <- readRDS(paste0("~/Immunoediting/data/simulation/",x)) %>% 
                       mutate(cancer=gsub("_simulation.rds","",x))
                   })
pancancer_simulation_data <- bind_rows(bind_all)
saveRDS(pancancer_simulation_data,file = "~/Immunoediting/data/simulation/pancancer_simulation.rds")
```
This simulation can considered as neutral (or random) nes distribution, so we can compare our TCGA pancancer real nes distribution to this data. If the two distributions are significantly different, then we can conclude that the observed nes in TCGA real data is not random.

```{r compare_nes,eval=TRUE}
pancancer_simulation <- readRDS("~/Immunoediting/data/simulation/pancancer_simulation.rds")
pancancer_nes_exp <- readRDS("~/Immunoediting/data/pancancer_nes_exp.rds")
pancancer_nes_ccf <- readRDS("~/Immunoediting/data/pancancer_nes_ccf.rds")  

dt_ccf <- data.frame(type=c(rep("simulation",nrow(pancancer_simulation)),
                        rep("TCGA pancancer",nrow(pancancer_nes_ccf))),
                     NES=c(pancancer_simulation$nes,pancancer_nes_ccf$nes))
dt_exp <- data.frame(type=c(rep("simulation",nrow(pancancer_simulation)),
                            rep("TCGA pancancer",nrow(pancancer_nes_exp))),
                     NES=c(pancancer_simulation$nes,pancancer_nes_exp$nes))

p1 <- ggplot(dt_ccf, aes(x=type, y=NES, fill=type)) +
  scale_fill_manual(values=c("white", "#FC8D62"))+
  stat_compare_means(aes(x=type, y=NES))+
  geom_violin(width=0.8, alpha=0.2)+
  geom_boxplot(width=0.2) +
  theme(axis.title.x=element_blank())+
  guides(fill=F)+
  labs(title="CCF")

p2 <- ggplot(dt_exp, aes(x=type, y=NES, fill=type)) +
  scale_fill_manual(values=c("white", "#FC8D62"))+
  stat_compare_means(aes(x=type, y=NES))+
  geom_violin(width=0.8, alpha=0.2)+
  geom_boxplot(width=0.2) +
  theme(axis.title.x=element_blank())+
  guides(fill=F)+
  labs(title="EXP")

plot_grid(p1,p2)
```

From the pancancer overview, It has significant difference between neutral simulation and TCGA real data.

Then we can check how many patients have significant neoantigen negative enrichment signal.

```{r p_distribution,eval=TRUE}
###firstly, we adjust p value to FDR q values:
pancancer_nes_ccf$fdr <- p.adjust(pancancer_nes_ccf$p_value,method = "fdr")
pancancer_nes_exp$fdr <- p.adjust(pancancer_nes_exp$p_value,method = "fdr")

p1 <- plot_pie(pancancer_nes_ccf$fdr,expression = "pancancer_nes_ccf$fdr<0.25 & pancancer_nes_ccf$nes<0",label = c("samples with FDR<25% \n and NES(CCF) < 0","others"))
p2 <- plot_pie(pancancer_nes_exp$fdr,expression = "pancancer_nes_exp$fdr<0.25 & pancancer_nes_exp$nes<0",label = c("samples with FDR<25% \n and NES(EXP) < 0","others"))

###FDR 5%
p3 <- plot_pie(pancancer_nes_ccf$fdr,expression = "pancancer_nes_ccf$fdr<0.05 & pancancer_nes_ccf$nes<0",label = c("samples with FDR<5% \n and NES(CCF) < 0","others"))
p4 <- plot_pie(pancancer_nes_exp$fdr,expression = "pancancer_nes_exp$fdr<0.05 & pancancer_nes_exp$nes<0",label = c("samples with FDR<5% \n and NES(EXP) < 0","others"))
```

Thus we conclude that the immunoediting signal is undoubtedly exist, however in majority of cancer patient, this signal is undetectable, and only 2.5% (CCF FDR<0.25) of patient show this significant immunoediting signal.

Then we view the cancer type distribution of NES and compare with cancer type simulation:
```{r view_cancer_type_nes,eval=TRUE}

```



## Neoantigen enrichment score is associated with immune cell infiltration 
NES reflects neoantigen-mediated immune selection, thus we want to check relation between the immune cell infiltration level and our NES score.

```{r immune_cor,eval=TRUE}
pancancer_nes_ccf <- readRDS("~/Immunoediting/data/pancancer_nes_ccf.rds")
pancancer_nes_exp <- readRDS("~/Immunoediting/data/pancancer_nes_exp.rds")

###load all immune data
cibersort_immune <- readRDS("~/Immunoediting/data/immue_estimate.rds")
lf <- readRDS("~/Immunoediting/data/immune_landscape.rds") %>% 
  select(`TCGA Participant Barcode`,`Leukocyte Fraction`,
         `Stromal Fraction`,`Intratumor Heterogeneity`) %>% 
  rename(sample=`TCGA Participant Barcode`)
elife <- readRDS("~/Immunoediting/data/wang_2019_elife.rds")
cyt <- readRDS("~/Immunoediting/data/pancancer_cyt.rds")
```

Firstly, we calculate correlation using spearman method by cancer types

```{r cal_cor_cancertype,eval=TRUE,warning = FALSE}
##bind all data
all_immune <- left_join(elife %>% 
                          rename(sample=Tumor_Sample_Barcode),
                        cibersort_immune,
                        by="sample") %>% 
  left_join(.,cyt %>% 
              mutate(sample=substr(sample,1,15)),
            by="sample") %>% 
  mutate(sample=substr(sample,1,12)) %>% 
  left_join(.,lf,by="sample") %>% 
  distinct(sample,.keep_all = T)

pancancer_nes_ccf <- left_join(pancancer_nes_ccf %>% 
                                 mutate(sample=substr(sample,1,12)),
                               all_immune,by="sample")
pancancer_nes_ccf$cancer <- getcancer_type(pancancer_nes_ccf$sample)
pancancer_nes_ccf <- pancancer_nes_ccf %>%
  select(-c(sample, es, p_value, Project)) %>%
  filter(!is.na(nes)) %>%
  select(cancer, nes, everything())


pancancer_nes_exp <- left_join(pancancer_nes_exp %>% 
                                 mutate(sample=substr(sample,1,12)),
                               all_immune,by="sample")
pancancer_nes_exp$cancer <- getcancer_type(pancancer_nes_exp$sample)
pancancer_nes_exp <- pancancer_nes_exp %>%
  select(-c(sample, es, p_value, Project)) %>%
  filter(!is.na(nes)) %>%
  select(cancer, nes, everything())


summ_ccf <- pancancer_nes_ccf %>% 
  group_by(cancer) %>%
  summarise(across(nes:`Intratumor Heterogeneity`,~median(.x, na.rm = TRUE)))
summ_exp <- pancancer_nes_exp %>% 
  group_by(cancer) %>%
  summarise(across(nes:`Intratumor Heterogeneity`,~median(.x, na.rm = TRUE)))

cor_mat1 <- cor(summ_ccf %>% select(-cancer), 
                method = "spearman", use = "pairwise.complete.obs")
cor_mat1 <- cor_mat1[,1]  %>% as.data.frame()
colnames(cor_mat1) <- "NES(CCF)"
cor_mat2 <- cor(summ_exp %>% select(-cancer), 
                method = "spearman", use = "pairwise.complete.obs")
cor_mat2 <- cor_mat2[,1]  %>% as.data.frame()
colnames(cor_mat2) <- "NES(EXP)"

ccf_exp_cor <- cbind(cor_mat1,cor_mat2)
ccf_exp_cor <- ccf_exp_cor[-1,]
ggcorrplot::ggcorrplot(t(ccf_exp_cor))

##view data
DT::datatable(ccf_exp_cor,
  options = list(scrollX = TRUE, keys = TRUE), rownames = TRUE
)
```
We can see the negative corrlation between nes and most immune score.
Plot LF:

```{r plot_LF,eval=TRUE,warning = FALSE,message=FALSE}
##this code is modified from wang et.al 2019 elife 
###https://xsliulab.github.io/tumor-immunogenicity-score/#strong-association-between-aps-and-immune-cell-infiltration-level
library(ggpubr)
plot_scatter <- function(data, x, y, xlab = "Median NES", ylab = "Median LF", conf.int = TRUE, method = "spearman", label.x = -0.7, label.y = 0.1, label = "cancer", ...) {
  ggscatter(data,
    x = x, y = y,
    xlab = xlab, ylab = ylab,
    shape = 21, size = 3, color = "black",
    add = "reg.line", add.params = list(color = "blue", fill = "lightgray"),
    conf.int = conf.int,
    cor.coef = TRUE,
    cor.coeff.args = list(method = method, label.x = label.x, label.y = label.y, label.sep = "\n"),
    label = label, repel = TRUE, ...
  )
}

plot_scatter(data = summ_ccf %>% mutate(cancer=gsub("TCGA-","",cancer)),
             x="nes",y="Leukocyte Fraction",label.x = -0.8,label.y = 0.1)
plot_scatter(data = summ_exp %>% mutate(cancer=gsub("TCGA-","",cancer)),
             x="nes",y="Leukocyte Fraction",label.x = -0.7,label.y = 0.1)
```

We can see the CCF NES is significantly corrlated with LF, while EXP NES is not.

The negative NES value indicates that samples are under immune negative selection, thus we then consider NES as categorical variable and check the difference between positive and negative NES.

```{r diff_nes,eval=TRUE,message=FALSE,warning=FALSE}

plot_diff_box <- function(data,var,title,laby){
  ggplot(data, aes(x=type, y=get(var), fill=type)) +
  scale_fill_manual(values=c("white", "#FC8D62"))+
  stat_compare_means()+
  geom_violin(width=0.8, alpha=0.2)+
  geom_boxplot(width=0.2) +
  theme(axis.title.x=element_blank())+
  guides(fill=F)+
  labs(title=title,y=laby)
}

pancancer_nes_ccf <- pancancer_nes_ccf %>% 
  mutate(type=ifelse(nes<0,"negative","positive"))
pancancer_nes_exp <- pancancer_nes_exp %>% 
  mutate(type=ifelse(nes<0,"negative","positive"))

pancancer_nes_ccf$type <- factor(pancancer_nes_ccf$type,levels = c("positive","negative"))
pancancer_nes_exp$type <- factor(pancancer_nes_exp$type,levels = c("positive","negative"))  

###LF
plot_diff_box(data = pancancer_nes_ccf,var = "Leukocyte Fraction",title = "CCF",
              laby = "Leukocyte Fraction")
plot_diff_box(data = pancancer_nes_exp,var = "Leukocyte Fraction",title = "EXP",
              laby = "Leukocyte Fraction")

###T_cells_CD8
plot_diff_box(data = pancancer_nes_ccf,var = "T_cells_CD8",title = "CCF",
              laby = "CD8 T Cells")
plot_diff_box(data = pancancer_nes_exp,var = "T_cells_CD8",title = "EXP",
              laby = "CD8 T Cells")

###CYT
ggplot(pancancer_nes_ccf, aes(x=type, y=log(cyt+1), fill=type)) +
  scale_fill_manual(values=c("white", "#FC8D62"))+
  stat_compare_means()+
  geom_violin(width=0.8, alpha=0.2)+
  geom_boxplot(width=0.2) +
  theme(axis.title.x=element_blank())+
  guides(fill=F)+
  labs(title="CCF",y="log(CYT+1)")
ggplot(pancancer_nes_exp, aes(x=type, y=log(cyt+1), fill=type)) +
  scale_fill_manual(values=c("white", "#FC8D62"))+
  stat_compare_means()+
  geom_violin(width=0.8, alpha=0.2)+
  geom_boxplot(width=0.2) +
  theme(axis.title.x=element_blank())+
  guides(fill=F)+
  labs(title="EXP",y="log(CYT+1)")
```




## Neoantigen enrichment score and immune negative selection selection
We use a stochastic branching process model (2020 Nature genetics, Eszter Lakatos et.al) to model tumor growth integrating neoantigen-mediated negative selection. The detailed method please see our paper or the [origin NG paper](https://doi.org/10.1038/s41588-020-0687-1)

The Julia scripts used in this simulation can be found in `code/julia`.





