<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Tao Wu" />
        <meta name="author" content="Xue-Song Liu (Corresponding author)" />
    
        <meta name="date" content="2022-03-24" />
    
    <title>Pan-cancer quantification of neoantigen-mediated immunoediting in cancer evolution</title>

        <script src="report_main_files/header-attrs-2.11/header-attrs.js"></script>
        <script src="report_main_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="report_main_files/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="report_main_files/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="report_main_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
        <script src="report_main_files/navigation-1.1/tabsets.js"></script>
        <link href="report_main_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
        <script src="report_main_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
        <link href="report_main_files/readthedown-0.1/readthedown.css" rel="stylesheet" />
        <link href="report_main_files/readthedown-0.1/readthedown_fonts_embed.css" rel="stylesheet" />
        <script src="report_main_files/readthedown-0.1/readthedown.js"></script>
        <script src="report_main_files/htmlwidgets-1.5.4/htmlwidgets.js"></script>
        <link href="report_main_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
        <script src="report_main_files/datatables-binding-0.20/datatables.js"></script>
        <link href="report_main_files/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
        <link href="report_main_files/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
        <script src="report_main_files/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
        <link href="report_main_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
        <script src="report_main_files/crosstalk-1.2.0/js/crosstalk.min.js"></script>
    
    
        <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #ffffff;
          color: #a0a0a0;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
      div.sourceCode
        { color: #1f1c1b; background-color: #ffffff; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #1f1c1b; } /* Normal */
      code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
      code span.an { color: #ca60ca; } /* Annotation */
      code span.at { color: #0057ae; } /* Attribute */
      code span.bn { color: #b08000; } /* BaseN */
      code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
      code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #924c9d; } /* Char */
      code span.cn { color: #aa5500; } /* Constant */
      code span.co { color: #898887; } /* Comment */
      code span.cv { color: #0095ff; } /* CommentVar */
      code span.do { color: #607880; } /* Documentation */
      code span.dt { color: #0057ae; } /* DataType */
      code span.dv { color: #b08000; } /* DecVal */
      code span.er { color: #bf0303; text-decoration: underline; } /* Error */
      code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
      code span.fl { color: #b08000; } /* Float */
      code span.fu { color: #644a9b; } /* Function */
      code span.im { color: #ff5500; } /* Import */
      code span.in { color: #b08000; } /* Information */
      code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
      code span.op { color: #1f1c1b; } /* Operator */
      code span.ot { color: #006e28; } /* Other */
      code span.pp { color: #006e28; } /* Preprocessor */
      code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #ff5500; } /* SpecialString */
      code span.st { color: #bf0303; } /* String */
      code span.va { color: #0057ae; } /* Variable */
      code span.vs { color: #bf0303; } /* VerbatimString */
      code span.wa { color: #bf0303; } /* Warning */
    </style>
    
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
         <!-- readthedown start -->   
   <div id="content" data-toggle="wy-nav-shift">
     <nav id="nav-top" role="navigation" aria-label="top navigation">
       <a role="button" href="#" data-toggle="wy-nav-top"><span class="glyphicon glyphicon-menu-hamburger"></span></a>
     </nav>
         
   
        
      <h1 class="title">Pan-cancer quantification of neoantigen-mediated immunoediting in cancer evolution</h1>
      
         <!-- readthedown authors -->
   <div id="sidebar">
    <h2><a href="#content">Pan-cancer quantification of neoantigen-mediated immunoediting in cancer evolution</a></h2>
    <div id="toc">
      <ul>
      <li><a href="#dependencies">Dependencies</a></li>
      <li><a href="#data-download-and-preprocessing">Data download and preprocessing</a>
      <ul>
      <li><a href="#tcga-pancancer-data-download-and-clean">TCGA pancancer data download and clean</a>
      <ul>
      <li><a href="#mutation-data">Mutation data</a></li>
      <li><a href="#expression-data">Expression data</a></li>
      <li><a href="#hla-typing-and-immune-cell-infiltration-data">HLA typing and immune cell infiltration data</a></li>
      </ul></li>
      <li><a href="#tcga-pancancer-data-processing">TCGA pancancer data processing</a>
      <ul>
      <li><a href="#hla-typing">HLA typing</a></li>
      <li><a href="#neoantigen-prediction">Neoantigen prediction</a></li>
      </ul></li>
      <li><a href="#immunotherapy-data-download-and-clean">Immunotherapy data download and clean</a></li>
      </ul></li>
      <li><a href="#tcga-pancancer-analysis">TCGA pancancer analysis</a>
      <ul>
      <li><a href="#the-existence-of-significant-immunoediting-signal">The existence of significant immunoediting signal</a></li>
      <li><a href="#neoantigen-enrichment-score-and-immune-negative-selection-strength-quantification">Neoantigen enrichment score and immune negative selection strength quantification</a></li>
      <li><a href="#pan-cancer-features-and-correlations-of-immunoediting-signal">Pan-cancer features and correlations of immunoediting signal</a></li>
      </ul></li>
      <li><a href="#immunotherapy-dataset-analysis">Immunotherapy dataset analysis</a>
      <ul>
      <li><a href="#quantified-immunoediting-elimination-signal-predicts-the-clinical-response-of-cancer-immunotherapy">Quantified immunoediting-elimination signal predicts the clinical response of cancer immunotherapy</a></li>
      </ul></li>
      <li><a href="#supplementary-analyses">Supplementary analyses</a>
      <ul>
      <li><a href="#sample-statistics-and-clinical-features">Sample statistics and clinical features</a></li>
      <li><a href="#robust-of-method">Robust of method</a>
      <ul>
      <li><a href="#minimum-number-of-non-neoantigenic-mutations-to-calculate-significant-p">Minimum number of non-neoantigenic mutations to calculate significant P</a></li>
      <li><a href="#threshold-for-neoantigen-prediction">Threshold for neoantigen prediction</a></li>
      <li><a href="#another-method-for-neoantigen-prediction">Another method for neoantigen prediction</a></li>
      </ul></li>
      <li><a href="#immune-escape-analysis">Immune escape analysis</a></li>
      <li><a href="#ccf-distribution-analysis">CCF distribution analysis</a></li>
      <li><a href="#other-immune-cell-infiltration-quantification-methods">Other immune cell infiltration quantification methods</a></li>
      <li><a href="#comparison-with-other-biomarkers-of-ici">Comparison with other biomarkers of ICI</a></li>
      </ul></li>
      </ul>
    </div>
    <div id="postamble" data-toggle="wy-nav-shift" class="status">
                  <p class="author"><span class="glyphicon glyphicon-user"></span> Tao Wu</p>
                        <p class="author"><span class="glyphicon glyphicon-user"></span> Xue-Song Liu (Corresponding author)</p>
                        <p class="date"><span class="glyphicon glyphicon-calendar"></span> 2022-03-24</p>
          </div>
   </div>
     

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div id="main">
<div id="dependencies" class="section level1">
<h1>Dependencies</h1>
<p>This project is depended on R software, R packages, shell bash, Julia software and some Julia packages :</p>
<ul>
<li><a href="https://github.com/wt12318/NeoEnrichment">NeoEnrichment</a> - do neoantigen enrichment for this project.</li>
<li><a href="https://www.tidyverse.org/">tidyverse</a> - tidy data</li>
<li><a href="https://github.com/Rdatatable/data.table">data.table</a> - read and tidy data</li>
<li><a href="https://github.com/therneau/survival">survival</a> - survival analysis</li>
<li><a href="https://github.com/kassambara/survminer">survminer</a> - plot survival fit</li>
<li><a href="https://cran.r-project.org/web/packages/DT/index.html">DT</a> - show data table as a table in html</li>
<li><a href="https://github.com/thomasp85/patchwork">patchwork</a> - arrange figures into complex compound figures</li>
<li><a href="https://github.com/PoisonAlien/maftools">maftools</a> - summarize, Analyze and Visualize MAF files</li>
<li><a href="https://github.com/jokergoo/ComplexHeatmap">ComplexHeatmap</a> - make heatmap</li>
<li><a href="https://github.com/ShixiangWang/ezcox">ezcox</a> - operate a batch of univariate or multivariate Cox models and return tidy result</li>
<li><a href="https://github.com/thomas-neitmann/ggcharts">ggcharts</a> - plot pyramid bar plot</li>
<li>parallel - Parallel Computing</li>
<li><a href="https://julialang.org/">Julia</a> - do simulation</li>
<li>knitr, rmdformats - used to compile this file</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(NeoEnrichment)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maftools)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ezcox)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcharts)</span></code></pre></div>
</div>
<div id="data-download-and-preprocessing" class="section level1">
<h1>Data download and preprocessing</h1>
<p>This part will describe how and where the data that this project used is downloaded and pre-processed.</p>
<div id="tcga-pancancer-data-download-and-clean" class="section level2">
<h2>TCGA pancancer data download and clean</h2>
<div id="mutation-data" class="section level3">
<h3>Mutation data</h3>
<p>Pre-compiled curated somatic mutations (called by MuTect2) for TCGA cohorts were downloaded from <a href="https://xenabrowser.net/datapages/?dataset=GDC-PANCAN.mutect2_snv.tsv&amp;host=https%3A%2F%2Fgdc.xenahubs.net&amp;removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443">Xena</a> and only keep missense variants for following analysis</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mutect2 <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/useful_data/GDC-PANCAN.mutect2_snv.tsv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(effect<span class="sc">==</span><span class="st">&quot;missense_variant&quot;</span> <span class="sc">&amp;</span> filter<span class="sc">==</span><span class="st">&quot;PASS&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(mutect2,<span class="at">file =</span> <span class="st">&quot;../data/pancancer_mutation.rds&quot;</span>)</span></code></pre></div>
<p>view this file:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pancancer_mutation <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_mutation.rds&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="fu">head</span>(pancancer_mutation),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>, <span class="at">keys =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">&#39;dt-center&#39;</span>, <span class="at">targets =</span> <span class="dv">2</span>))), <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div id="htmlwidget-2293648ee593fbea5236" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2293648ee593fbea5236">{"x":{"filter":"none","vertical":false,"data":[["TCGA-P6-A5OH-01A","TCGA-P6-A5OH-01A","TCGA-P6-A5OH-01A","TCGA-P6-A5OH-01A","TCGA-P6-A5OH-01A","TCGA-P6-A5OH-01A"],["WASF2","MACF1","NFIA","CADM3","DUSP27","RGSL1"],["chr1","chr1","chr1","chr1","chr1","chr1"],[27410171,39455094,61088434,159200836,167126702,182556049],[27410171,39455094,61088434,159200836,167126702,182556049],["G","T","C","G","G","G"],["A","A","T","A","C","C"],["p.A287V","p.H6923Q","p.L105F","p.D371N","p.G524A","p.E1075Q"],["missense_variant","missense_variant","missense_variant","missense_variant","missense_variant","missense_variant"],["PASS","PASS","PASS","PASS","PASS","PASS"],[0.25531914893617,0.0720720720720721,0.152671755725191,0.299479166666667,0.0555555555555556,0.2734375]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Sample_ID<\/th>\n      <th>gene<\/th>\n      <th>chrom<\/th>\n      <th>start<\/th>\n      <th>end<\/th>\n      <th>ref<\/th>\n      <th>alt<\/th>\n      <th>Amino_Acid_Change<\/th>\n      <th>effect<\/th>\n      <th>filter<\/th>\n      <th>dna_vaf<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"keys":true,"columnDefs":[{"className":"dt-center","targets":2},{"className":"dt-right","targets":[3,4,10]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>To predict neoantigen, mutation files were first transformed into single sample VCF format by maf2vcf tools (This Code can be found in <code>code/shell/TCGA_neoantigen</code> folder).</p>
<p>ABSOLUTE-annotated MAF file which contains cancer cell fraction (CCF) information of mutations was downloaded from GDC PanCanAtlas publications (<a href="https://gdc.cancer.gov/node/905/">TCGA_consolidated.abs_mafs_truncated.fixed.txt.gz</a>), and then we used liftover function from R package “rtracklayer” to convert the this hg37 genome coordinates file to hg38 coordinates:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>absolute_maf <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/useful_data/TCGA_consolidated.abs_mafs_truncated.fixed.txt&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>absolute_maf <span class="ot">&lt;-</span> absolute_maf <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Hugo_Symbol,Chromosome,Start_position,End_position,ccf_hat,sample,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>         Protein_Change,Variant_Classification,Variant_Type,Reference_Allele,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>         Tumor_Seq_Allele2,ref,alt,purity)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GenomicRanges)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>absolute_maf<span class="sc">$</span>Chromosome <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;chr&quot;</span>,absolute_maf<span class="sc">$</span>Chromosome)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>absolute_granges <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(absolute_maf,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">keep.extra.columns=</span><span class="cn">TRUE</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">ignore.strand=</span><span class="cn">TRUE</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">seqinfo=</span><span class="cn">NULL</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">seqnames.field=</span><span class="st">&quot;Chromosome&quot;</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">start.field=</span><span class="st">&quot;Start_position&quot;</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">end.field=</span><span class="st">&quot;End_position&quot;</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">starts.in.df.are.0based=</span><span class="cn">FALSE</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rtracklayer)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>chainObject <span class="ot">&lt;-</span> <span class="fu">import.chain</span>(<span class="st">&quot;~/useful_data/hg19ToHg38.over.chain&quot;</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">liftOver</span>(absolute_granges, chainObject))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(width<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Variant_Classification<span class="sc">==</span><span class="st">&quot;Missense_Mutation&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(<span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">16</span>),seqnames,start,Reference_Allele,Tumor_Seq_Allele2,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,index,Hugo_Symbol,Protein_Change,Reference_Allele,Tumor_Seq_Allele2,purity,ccf_hat)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results,<span class="at">file =</span> <span class="st">&quot;../data/all_mut_mis_ccf.rds&quot;</span>)</span></code></pre></div>
<p>Driver mutation data was downloaded from Bailey M H et.al study (<a href="https://gdc.cancer.gov/about-data/publications/pancan-driver">Mutation.CTAT.3D.Scores.txt</a>). This study used three different categories of tools to find driver mutations:</p>
<ol style="list-style-type: decimal">
<li>tools distinguishing benign versus pathogenic mutations using sequence (CTAT population);</li>
<li>tools distinguishing driver versus passenger mutations using sequence (CTAT cancer);</li>
<li>tools discovering statistically significant three-dimensional clusters of missense mutations (structure based).</li>
</ol>
<p>We keep mutations identified by ≥2 approaches as finial high confident driver mutations, including 3437 unique mutations:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/data/Mutation.CTAT.3D.Scores.txt&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nmethod=</span><span class="st">`</span><span class="at">New_Linear (functional) flag</span><span class="st">`</span><span class="sc">+</span><span class="st">`</span><span class="at">New_Linear (cancer-focused) flag</span><span class="st">`</span><span class="sc">+</span><span class="st">`</span><span class="at">New_3D mutational hotspot flag</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(nmethod<span class="sc">&gt;=</span><span class="dv">2</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(driver_mutations,<span class="at">file =</span> <span class="st">&quot;../data/driver_mutations.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="expression-data" class="section level3">
<h3>Expression data</h3>
<p>The normalized gene-level RNA-seq data (TPM, transcripts per million) for 31 TCGA cohorts were downloaded from Xena (<a href="https://xenabrowser.net/datapages/?dataset=tcga_RSEM_gene_tpm&amp;host=https%3A%2F%2Ftoil.xenahubs.net&amp;removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443">tcga_RSEM_gene_tpm</a>) and transformed from log-form to non-log form (This file is too large to store in Github):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>TPM_log2 <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/useful_data/xena_RSEM_TPM/tcga_RSEM_gene_tpm.gz&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/useful_data/xena_RSEM_TPM/mapping_probe&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> mapping[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>TPM_log2_mapping <span class="ot">&lt;-</span> <span class="fu">left_join</span>(TPM_log2 <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">id=</span>sample),mapping) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id,gene,<span class="fu">everything</span>())<span class="do">###log2(tpm+0.001)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>TPM_log2_mapping <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(TPM_log2_mapping)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>tpm_trans <span class="ot">&lt;-</span> TPM_log2_mapping</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>tpm_trans[,<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(tpm_trans)] <span class="ot">&lt;-</span> <span class="fu">apply</span>(TPM_log2_mapping[,<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(TPM_log2_mapping)],<span class="dv">2</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                                       <span class="cf">function</span>(x){(<span class="dv">2</span><span class="sc">^</span>x) <span class="sc">-</span> <span class="fl">0.001</span>})</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tpm_trans,<span class="at">file =</span> <span class="st">&quot;~/useful_data/xena_RSEM_TPM/tpm_trans.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="hla-typing-and-immune-cell-infiltration-data" class="section level3">
<h3>HLA typing and immune cell infiltration data</h3>
<p>HLA typing data was downloaded from Thorsson et.al study and transformed to the format required by the neoantigen prediction tools:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>hla <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;~/useful_data/panCancer_hla.tsv&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>hla <span class="ot">&lt;-</span> hla <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> V2,<span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;HLA-A_1&quot;</span>,<span class="st">&quot;HLA-A_2&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;HLA-B_1&quot;</span>,<span class="st">&quot;HLA-B_2&quot;</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;HLA-C_1&quot;</span>,<span class="st">&quot;HLA-C_2&quot;</span>),<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">###no stars</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>hla <span class="ot">&lt;-</span> <span class="fu">t</span>(base<span class="sc">::</span><span class="fu">apply</span>(hla,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">which</span>(<span class="fu">duplicated</span>(x))] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">*&quot;</span>,<span class="st">&quot;&quot;</span>,x)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>})) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(hla)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Patient&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(hla,<span class="at">file =</span> <span class="st">&quot;~/useful_data/TCGA_HLA_typing.txt&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">quote =</span> F,<span class="at">col.names =</span> T,<span class="at">row.names =</span> F)</span></code></pre></div>
<p>Immune cell infiltration data for all TCGA tumors was downloaded from ImmuneCellAI study (Miao et al., 2020), which estimates the abundance of 24 immune cells comprised of 18 T-cell subtypes and 6 other immune cells. We can only download indivial cancer type data from the web server, so we need combine them all:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;~/test/immune_score/immuneCellAI/&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="fu">length</span>(files))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(re)){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/test/immune_score/immuneCellAI/&quot;</span>,files[i]),<span class="at">data.table =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">sample=</span>V1) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">16</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>,<span class="st">&quot;-&quot;</span>,sample))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> dt</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results,<span class="at">file =</span> <span class="st">&quot;../data/pancancer_subtcells.rds&quot;</span>)</span></code></pre></div>
<p>We can view this file:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pancancer_immune <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_subtcells.rds&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="fu">head</span>(pancancer_immune),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>, <span class="at">keys =</span> <span class="cn">TRUE</span>), <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div id="htmlwidget-a8ea0ae8b4a617a8f978" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a8ea0ae8b4a617a8f978">{"x":{"filter":"none","vertical":false,"data":[["TCGA-OR-A5J1-01A","TCGA-OR-A5J2-01A","TCGA-OR-A5J3-01A","TCGA-OR-A5J5-01A","TCGA-OR-A5J6-01A","TCGA-OR-A5J7-01A"],[0,0,0.089,0.014,0,0.042],[0.115,0.114,0.087,0.218,0,0.069],[0.436,0.427,0.192,0.406,0.537,0.218],[0.035,0.08,0,0.003,0.105,0.02],[0.04,0.104,0.033,0.079,0.123,0.174],[0.048,0.025,0,0,0.11,0.013],[0.065,0.245,0,0,0.156,0.003],[0.158,0.152,0.069,0.004,0.148,0.025],[0.334,0.219,0,0.082,0.325,0],[0.057,0.044,0.253,0.114,0.203,0.112],[0.075,0.115,0,0.055,0.03,0.043],[0,0.087,0.061,0,0,0.041],[0.027,0.012,0,0,0.031,0],[0,0.143,0.07,0.105,0,0.043],[0.278,0.163,0.045,0.173,0.17,0.051],[0.15,0.207,0.149,0.088,0.224,0.13],[0.026,0.068,0.067,0.114,0.038,0.14],[0.104,0.095,0.076,0.148,0.172,0.086],[0.182,0.102,0.085,0.085,0.275,0.112],[0.162,0.003,0.146,0.254,0.377,0.179],[0.115,0.106,0.162,0.122,0.115,0.157],[0.089,0.07,0.13,0.151,0.09,0.06],[0.102,0.084,0.123,0.087,0.058,0.094],[0.201,0.211,0.046,0.156,0.206,0.048],[0.606,0.508,0.496,0.613,0.851,0.549]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>sample<\/th>\n      <th>CD4_naive<\/th>\n      <th>CD8_naive<\/th>\n      <th>Tc<\/th>\n      <th>Tex<\/th>\n      <th>Tr1<\/th>\n      <th>nTreg<\/th>\n      <th>iTreg<\/th>\n      <th>Th1<\/th>\n      <th>Th2<\/th>\n      <th>Th17<\/th>\n      <th>Tfh<\/th>\n      <th>Tcm<\/th>\n      <th>Tem<\/th>\n      <th>NKT<\/th>\n      <th>MAIT<\/th>\n      <th>DC<\/th>\n      <th>B_cell<\/th>\n      <th>Monocyte<\/th>\n      <th>Macrophage<\/th>\n      <th>NK<\/th>\n      <th>Neutrophil<\/th>\n      <th>Tgd<\/th>\n      <th>CD4_T<\/th>\n      <th>CD8_T<\/th>\n      <th>InfiltrationScore<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"keys":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Other Immune cell infiltration data including CIBERSORT (abs mode), Quantiseq were downloaded from the <a href="http://timer.comp-genomics.org/">TIMER2.0</a> study.</p>
</div>
</div>
<div id="tcga-pancancer-data-processing" class="section level2">
<h2>TCGA pancancer data processing</h2>
<p>This part describes HLA typing and neoantigen prediction of TCGA data.</p>
<div id="hla-typing" class="section level3">
<h3>HLA typing</h3>
<p>For samples which don’t have corresponding HLA infromation data in Thorsson et.al study, HLA genotyping was performed with Optitype (Szolek et al., 2014), using default parameters. This corresponding code can be found in <code>code/python/HLA_typing</code> (using snakemake pipeline tools).</p>
</div>
<div id="neoantigen-prediction" class="section level3">
<h3>Neoantigen prediction</h3>
<p>Mutect2 mutation files were first transformed into VCF format by maf2vcf tools, and we used NeoPredPipe to predict neoantigen (Schenck et al., 2019). Single-nucleotide variants leading to a single amino acid change are the focus of this study. From the output results, if the IC50 of a novel peptide is less than 50, the bind level is SB (strong binder, rank is less than 0.5%), and the expression level (TPM) is greater than 1, then this peptide is labeled as neoantigen. A mutation is considered neoantigenic if there is at least one peptide derived from the mutated site is predicted as neoantigen. The neoantigen prediction code using NeoPrePipe can be found in <code>code/shell/TCGA_neoantigen</code>. Then we add CCF and mRNA expression information to neoantigen prediction data:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/public/slst/home/wutao2/TCGA_neopredpipe/batch_results&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;files&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste</span>(files<span class="sc">$</span>V1[i],<span class="st">&quot;/batch_&quot;</span>,files<span class="sc">$</span>V1[i],<span class="st">&quot;.neoantigens.unfiltered.txt&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;&quot;</span>),<span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span><span class="sc">:</span><span class="dv">11</span>,<span class="dv">21</span><span class="sc">:</span><span class="dv">28</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mut) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;position&quot;</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;ref&quot;</span>,<span class="st">&quot;alt&quot;</span>,<span class="st">&quot;gene&quot;</span>,<span class="st">&quot;exp&quot;</span>,<span class="st">&quot;res_pos&quot;</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;hla&quot;</span>,<span class="st">&quot;score_el&quot;</span>,<span class="st">&quot;rank_el&quot;</span>,<span class="st">&quot;score_ba&quot;</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;rank_ba&quot;</span>,<span class="st">&quot;IC50&quot;</span>,<span class="st">&quot;candidate&quot;</span>,<span class="st">&quot;bindlevel&quot;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;novelty&quot;</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">novelty=</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(novelty),<span class="dv">0</span>,novelty)) <span class="sc">%&gt;%</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,ref,alt,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(mut,<span class="at">file =</span> <span class="fu">paste</span>(files<span class="sc">$</span>V1[i],<span class="st">&quot;.rds&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;~/test/data/2021_03_31/&quot;</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">100</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste</span>(<span class="st">&quot;~/test/data/2021_03_31/&quot;</span>,files[i],<span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  neo <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(novelty <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(IC50<span class="sc">&lt;</span><span class="dv">50</span> <span class="sc">&amp;</span> bindlevel<span class="sc">==</span><span class="st">&quot;SB&quot;</span> <span class="sc">&amp;</span> novelty<span class="sc">==</span><span class="dv">1</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo =</span> <span class="fu">ifelse</span>(index <span class="sc">%in%</span> neo<span class="sc">$</span>index , <span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> mut</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,chr,position,ref,alt,neo,gene,exp)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene=</span><span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">:.+&quot;</span>,<span class="st">&quot;&quot;</span>,gene))</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut,<span class="at">file =</span> <span class="st">&quot;~/test/data/2021_04_17/all_mut.rds&quot;</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/useful_data/xena_RSEM_TPM/tpm_trans.rds&quot;</span>)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> tpm[<span class="sc">!</span><span class="fu">duplicated</span>(tpm<span class="sc">$</span>gene),]</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>all_mut<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(sample,gene){</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  tpm[tpm<span class="sc">$</span>gene<span class="sc">==</span>gene,<span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">15</span>)]</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>},all_mut<span class="sc">$</span>sample,all_mut<span class="sc">$</span>gene)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">lengths</span>(tpm_exp)<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>all_mut1<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(all_mut1<span class="sc">$</span>tpm_exp)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut1,<span class="at">file =</span> <span class="st">&quot;../data/all_mut_tpm_not_filter.rds&quot;</span>)<span class="do">##this file is used to calculte EXP-ES</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo2=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span> <span class="sc">&amp;</span> tpm_exp<span class="sc">&gt;</span><span class="dv">1</span>,<span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>neo,<span class="sc">-</span>exp) <span class="sc">%&gt;%</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">neo=</span>neo2)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut1,<span class="at">file =</span> <span class="st">&quot;~/test/all_mut_tpm.rds&quot;</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="do">##add ccf</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/test/data/2021_04_05/all_mut_mis_ccf.rds&quot;</span>)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>all_mut_tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/test/all_mut_tpm.rds&quot;</span>)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co">#all_mut_tpm &lt;- readRDS(&quot;~/test/all_mut_tpm_not_filter.rds&quot;)</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut_tpm <span class="sc">%&gt;%</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,ref,alt,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">ref_allele=</span>ref,<span class="at">alt_allele=</span>alt)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>  all_mut,</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  results <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>sample),</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="st">&quot;index&quot;</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf[<span class="sc">!</span><span class="fu">duplicated</span>(all_mut_ccf<span class="sc">$</span>index),]</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut_ccf,<span class="at">file =</span> <span class="st">&quot;../data/all_mut_ccf_tpm.rds&quot;</span>)<span class="do">##This file is used to calculate CCF-ES</span></span></code></pre></div>
</div>
</div>
<div id="immunotherapy-data-download-and-clean" class="section level2">
<h2>Immunotherapy data download and clean</h2>
<p>We collected three cohorts of immunotherapy datasets for our analysis. <code>The Hugo et al. (2016) dataset</code> was related to anti-PD-1 therapy in metastatic melanoma. This dataset has 37 samples with WES data, 26 were also analyzed by RNA sequencing (RNA-seq). <code>The Riaz et al. (2017) dataset</code> was related to anti-PD-1 therapy in metastatic melanoma. This dataset has 56 samples with WES data, 40 with RNA-seq. <code>The David Liu et.al (2019) cohort</code> has patients with melanoma treated with anti-PD1 ICB, which 119 samples has WES data, 112 with RNA-seq.</p>
<p>Immune therapy response for patients was defined by RECIST v1.1(CR/PR/SD/PD), responding tumors were derived from patients who have complete or partial responses (CR/PR) in response to anti-PD-1 therapy; non-responding tumors were derived from patients who had progressive disease or stable disease (PD/SD).</p>
<p>The details of mutation calling, producing copy number segment file (using GATK4) and RNA_seq process can be found in Methods. Code can be found in <code>code/shell/ICI</code>. The HLA typing and neoantigen prediction was the same as the process in TCGA data as previously described. The code for caculating CCF by ABSOLUTE can be found in <code>code/R/ICI_ABSOLUTE.R</code></p>
<p>After got neoantiogen prediction and ABSOLUTE CCF information, we can combine these data for downstream analysis:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">####combine neoantigen prediction data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;immunetherapy/&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> files[<span class="fu">grepl</span>(<span class="st">&quot;neoantigens.unfiltered.txt&quot;</span>,files)]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">25</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>){</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> <span class="fu">read_table2</span>(<span class="fu">paste</span>(<span class="st">&quot;immunetherapy/&quot;</span>,files[i],<span class="at">sep =</span> <span class="st">&quot;&quot;</span>),<span class="at">col_names =</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="st">&quot;V&quot;</span>,<span class="dv">27</span>),<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">27</span>)))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">10</span>,<span class="dv">20</span><span class="sc">:</span><span class="dv">27</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mut) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;position&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;ref&quot;</span>,<span class="st">&quot;alt&quot;</span>,<span class="st">&quot;gene&quot;</span>,<span class="st">&quot;exp&quot;</span>,<span class="st">&quot;res_pos&quot;</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;hla&quot;</span>,<span class="st">&quot;score_el&quot;</span>,<span class="st">&quot;rank_el&quot;</span>,<span class="st">&quot;score_ba&quot;</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;rank_ba&quot;</span>,<span class="st">&quot;IC50&quot;</span>,<span class="st">&quot;candidate&quot;</span>,<span class="st">&quot;bindlevel&quot;</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;novelty&quot;</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">novelty=</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(novelty),<span class="dv">0</span>,novelty)) <span class="sc">%&gt;%</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,ref,alt,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>))</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  neo <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(IC50<span class="sc">&lt;</span><span class="dv">50</span> <span class="sc">&amp;</span> bindlevel<span class="sc">==</span><span class="st">&quot;SB&quot;</span> <span class="sc">&amp;</span> novelty<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> exp<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo =</span> <span class="fu">ifelse</span>(index <span class="sc">%in%</span> neo<span class="sc">$</span>index , <span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span> </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample,chr,position,gene,exp,neo) <span class="sc">%&gt;%</span> </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gene=</span><span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">:.+&quot;</span>,<span class="st">&quot;&quot;</span>,gene))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  mut<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">gsub</span>(<span class="st">&quot;_.+&quot;</span>,<span class="st">&quot;&quot;</span>,files[i]),mut<span class="sc">$</span>sample,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> mut</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_mut_ici.rds&quot;</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="do">###ccf in maf files of ABSOLUTE output</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="do">##nadeem</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>sample_run <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;immunetherapy/nadeem_absolute/Nad_sample_run&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,<span class="at">stringsAsFactors =</span> F)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;immunetherapy/nadeem_absolute/&quot;</span>)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">57</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">57</span>){</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;immunetherapy/nadeem_absolute/&quot;</span>,files[i]),<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">header =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample,Hugo_Symbol,Chromosome,Start_position,cancer_cell_frac,purity)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  test<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;nadeem&quot;</span>,<span class="fu">as.character</span>(sample_run[<span class="fu">which</span>(sample_run<span class="sc">$</span>V2<span class="sc">==</span><span class="fu">unique</span>(test<span class="sc">$</span>sample)),<span class="st">&quot;V1&quot;</span>]),</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> test</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>nadeem_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="do">##willy</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>sample_run <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;immunetherapy/willy_absolute/clinical.txt&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,<span class="at">stringsAsFactors =</span> F)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;immunetherapy/willy_absolute/&quot;</span>)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">38</span>)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">38</span>){</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;immunetherapy/willy_absolute/&quot;</span>,files[i]),<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">header =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample,Hugo_Symbol,Chromosome,Start_position,cancer_cell_frac,purity)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  test<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;willy&quot;</span>,<span class="fu">as.character</span>(sample_run[<span class="fu">which</span>(sample_run<span class="sc">$</span>V2<span class="sc">==</span><span class="fu">unique</span>(test<span class="sc">$</span>sample)),<span class="st">&quot;V1&quot;</span>]),</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> test</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>willy_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="do">###liu</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>sample_run <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;immunetherapy/liu_absolute/liu_sample_run&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,<span class="at">stringsAsFactors =</span> F)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;immunetherapy/liu_absolute/&quot;</span>)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">121</span>)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">121</span>){</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">paste0</span>(<span class="st">&quot;immunetherapy/liu_absolute/&quot;</span>,files[i]),<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">header =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample,Hugo_Symbol,Chromosome,Start_position,cancer_cell_frac,purity)</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  test<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;liu&quot;</span>,<span class="fu">as.character</span>(sample_run[<span class="fu">which</span>(sample_run<span class="sc">$</span>V2<span class="sc">==</span><span class="fu">unique</span>(test<span class="sc">$</span>sample)),<span class="st">&quot;V1&quot;</span>]),</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> test</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>liu_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>all_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(liu_ccf,nadeem_ccf,willy_ccf)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_ccf,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_ccf.rds&quot;</span>)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a><span class="do">###merge ccf and neoantigen data</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>  all_mut_ici <span class="sc">%&gt;%</span> </span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  all_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Chromosome=</span><span class="fu">paste0</span>(<span class="st">&quot;chr&quot;</span>,Chromosome)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,Chromosome,Start_position,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(index,cancer_cell_frac,purity),</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="st">&quot;index&quot;</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cancer_cell_frac))</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut_ccf,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_mut_ccf_ici.rds&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="tcga-pancancer-analysis" class="section level1">
<h1>TCGA pancancer analysis</h1>
<div id="the-existence-of-significant-immunoediting-signal" class="section level2">
<h2>The existence of significant immunoediting signal</h2>
<p>We investigate the status of this immunoediting signal with the new method developed in this study using TCGA pan-cancer dataset. The method detail showed in Method part of manuscript, and implemented in the package <code>NeoEnrichment</code> which can be found in <a href="https://github.com/wt12318/NeoEnrichment">Github</a></p>
<p>We filterd samples with at least 1 neoantigenic and 1 subclonal mutation (CCF&lt;0.6) and calculated CCF-NES value:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_ccf_tpm.rds&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>samples_has_subclonal <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ccf<span class="sc">&lt;</span><span class="fl">0.6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sample)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>all_mut_ccf  <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> samples_has_subclonal<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">16</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/neo_nes_ccf06_1.rds&quot;</span>)</span></code></pre></div>
<p>For each sample, we permutate the neoantigen labeling (ie. randomly select the same number of mutations as the actual neoantigen number in the selected sample and label them as neoantigenic mutations) and calculate ES value. For pan-cancer or cancer type dataset, we can obtain the same number of simulated samples and corresponding ES values, then calculate the median ES of these simulated samples. This process was repeated many times (usually 2000 times) to get the simulated distribution of median ES. The actual pan-cancer or cancer type median ES values are compared with this simulated ES distribution, and p values are then reported:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;/public/slst/home/wutao2/cal_nes/ccf/neo_nes_ccf06_1.rds&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;/public/slst/home/wutao2/cal_nes/ccf/all_mut_ccf_tpm.rds&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> neo_nes<span class="sc">$</span>sample)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">30</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo)))</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;/public/slst/home/wutao2/cal_nes/ccf/sim_2000_not_filter_driver.rds&quot;</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/test/data/2021_09_26/sim_2000_not_filter.rds&quot;</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim_2000_not_filter)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim_2000_not_filter<span class="sc">$</span>sample,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim_2000_not_filter,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_not_filter_all_ccf.rds&quot;</span>)<span class="do">##this file is too large to push to Github</span></span></code></pre></div>
<p>We can visualize the simulation using <code>WVPlots</code> package :</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1.rds&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_not_filter_all_ccf.rds&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(neo_nes<span class="sc">$</span>sample)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#The following code can be used to plot cancer type simulation which showd in FigS4</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">#res &lt;- vector(&quot;list&quot;,30)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:30){</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt &lt;- sim_all %&gt;% filter(cancer==neo_nes_summ$cancer[i])</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt_summ &lt;- dt %&gt;% </span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     group_by(sim_num) %&gt;%</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarise(median_es=median(es))</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- WVPlots::ShadedDensity(frame = dt_summ, </span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                               xvar = &quot;median_es&quot;,</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                               threshold = neo_nes_summ$median_es[i],</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                               title = neo_nes_summ$cancer[i],</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                               tail = &quot;left&quot;)</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$colour &lt;- &quot;red&quot;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$size &lt;- 1</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[2]]$aes_params$fill &lt;- &quot;blue&quot;     #geom_ribbon</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$colour &lt;- &quot;black&quot; </span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$size &lt;- 1</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   p1 &lt;- p + labs(x=&quot;Simulation median es&quot;)+</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_prism()</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   res[[i]] &lt;- p1</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_grid(plotlist = res)</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes<span class="sc">$</span>es),</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="co">#p$layers[[4]]$aes_params$label &lt;- &quot;Actual median ES&quot; #geom_text</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="report_main_files/figure-html/via1-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">##save</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># neo_nes_summ &lt;- neo_nes_summ %&gt;% </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   rowwise() %&gt;% </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(p=mean(summ2$median_es[summ2$cancer==cancer] &lt;= median_es))</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(neo_nes_summ,file = &quot;neo_nes_summ_ccf_061_not_filter.rds&quot;)</span></span></code></pre></div>
<p>Then we can compare the median actual CCF-ES with median simulation CCF-ES in pan-cancer and cancer-type:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>get_f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(dt,pancancer_p,dt2,median_es){</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>dt,<span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span>,<span class="at">y=</span>es))<span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_violin</span>(<span class="at">alpha=</span><span class="fl">0.7</span>,<span class="at">width=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">width=</span><span class="fl">0.2</span>)<span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste0</span>(<span class="st">&quot;median es = &quot;</span>,<span class="fu">round</span>(median_es,<span class="at">digits =</span> <span class="dv">3</span>),<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> n = &quot;</span>,<span class="fu">nrow</span>(dt)),<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>))<span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">&quot;text&quot;</span>, <span class="at">x=</span><span class="dv">1</span>, <span class="at">y=</span><span class="fl">1.1</span>, <span class="at">label=</span><span class="fu">paste0</span>(<span class="st">&quot;p = &quot;</span>,pancancer_p),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">color=</span><span class="st">&quot;red&quot;</span>,<span class="at">size=</span><span class="dv">4</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  dt <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">median_est=</span><span class="fu">median</span>(es),<span class="at">c=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(median_est) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label=</span><span class="fu">paste0</span>(cancer,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">(n=&quot;</span>,c,<span class="st">&quot;)&quot;</span>))<span class="ot">-&gt;</span> summ1</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  summ1 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(summ1,dt2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(cancer,p))</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  summ1<span class="sc">$</span>p <span class="ot">&lt;-</span> <span class="fu">signif</span>(summ1<span class="sc">$</span>p,<span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  summ1 <span class="ot">&lt;-</span> summ1 <span class="sc">%&gt;%</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sig=</span><span class="fu">case_when</span>(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>      p <span class="sc">&lt;=</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> p <span class="sc">&gt;</span> <span class="fl">0.01</span> <span class="sc">~</span> <span class="st">&quot;*&quot;</span>,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>      p <span class="sc">&lt;</span> <span class="fl">0.01</span> <span class="sc">~</span> <span class="st">&quot;**&quot;</span>,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;ns&quot;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dt,summ1)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>label <span class="ot">&lt;-</span> <span class="fu">factor</span>(dt<span class="sc">$</span>label,<span class="at">levels =</span> summ1<span class="sc">$</span>label)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(summ1), <span class="at">y =</span> <span class="fl">1.1</span>, <span class="at">family =</span> summ1<span class="sc">$</span>sig)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>dt,<span class="fu">aes</span>(<span class="at">x=</span>label,<span class="at">y=</span>es))<span class="sc">+</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>))<span class="sc">+</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="at">data=</span>df2,<span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">label =</span> family))<span class="sc">+</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size=</span><span class="dv">1</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> p2 <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">8</span>))</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>neo_nes4 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1.rds&quot;</span>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_summ_ccf_061_not_filter.rds&quot;</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">get_f1</span>(neo_nes4,<span class="at">pancancer_p =</span> <span class="fl">0.051</span>,<span class="at">dt2 =</span> neo_nes_summ,<span class="at">median_es =</span> <span class="fu">median</span>(neo_nes4<span class="sc">$</span>es))</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-6-1.svg" width="2400" /></p>
<p>The observed ESCCF is -0.017 (p=0.051). In PAAD and LUAD, the observed ESCCF values are significant lower compared with the random simulations, suggesting the existence of immunoediting-elimination signal. Since some neoantigenic mutations can be cancer drivers, which are known to undergo positive selection during the evolution of cancer. Neoantigens that happens to be cancer drivers are not undergoing immune based negative selection, probably because the driving force could override the negative selection, so we compared ES between the samples which neoantigenic and driver lie in the same gene with other samples:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(Hugo_Symbol,Protein_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)<span class="do">##0.01029878</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(Hugo_Symbol[neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>],</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                                 Hugo_Symbol[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##701 samples</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,Hugo_Symbol,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;yes&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>need_samples <span class="ot">&lt;-</span> <span class="fu">intersect</span>(samples_has_subclonal<span class="sc">$</span>sample,summ2<span class="sc">$</span>sample)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>all_mut_ccf  <span class="sc">%&gt;%</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> need_samples) <span class="sc">%&gt;%</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense)<span class="do">##addp</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(neo_nes<span class="sc">$</span>es)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1.rds&quot;</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>neo_nes_remove_drivers <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>neo_nes2 <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sample <span class="sc">%in%</span> neo_nes_remove_drivers<span class="sc">$</span>sample))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">es=</span><span class="fu">c</span>(neo_nes_remove_drivers<span class="sc">$</span>es,neo_nes2<span class="sc">$</span>es),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">type=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;neo not in driver&quot;</span>,<span class="fu">nrow</span>(neo_nes_remove_drivers)),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(<span class="st">&quot;neo in driver&quot;</span>,<span class="fu">nrow</span>(neo_nes2))))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">factor</span>(dt<span class="sc">$</span>type,<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;neo not in driver&quot;</span>,<span class="st">&quot;neo in driver&quot;</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> dt,<span class="fu">aes</span>(<span class="at">x=</span>type,<span class="at">y=</span>es))<span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-8-1.svg" width="2400" /></p>
<p>We can see that samples which neoantigenic and driver mutation lie in the same gene have the higher ES than other samples. So we filtered these sample to remove the effect that driver mutation cound couse.</p>
<p>When samples with neoantigenic and driver mutations lied on same genes are not included, the observed median ESCCF is -0.023 (n=5295, P=0.0055) (the simulation procedure is the same as above):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_not_filter_all_ccf.rds&quot;</span>)<span class="do">##this file is too large to push to Github</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sim_filter_driver <span class="ot">&lt;-</span> sim_all <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> neo_nes_remove_drivers<span class="sc">$</span>sample)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>sim_filter_driver <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>neo_nes_remove_drivers<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(neo_nes_remove_drivers<span class="sc">$</span>sample)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes_remove_drivers <span class="sc">%&gt;%</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#The following code can be used to plot cancer type simulation which showd in FigS6</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#res &lt;- vector(&quot;list&quot;,30)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:30){</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt &lt;- sim_filter_driver %&gt;% filter(cancer==neo_nes_summ$cancer[i])</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt_summ &lt;- dt %&gt;% </span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     group_by(sim_num) %&gt;%</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarise(median_es=median(es))</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- WVPlots::ShadedDensity(frame = dt_summ, </span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                               xvar = &quot;median_es&quot;,</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                               threshold = neo_nes_summ$median_es[i],</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                               title = neo_nes_summ$cancer[i],</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                               tail = &quot;left&quot;)</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$colour &lt;- &quot;red&quot;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$size &lt;- 1</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[2]]$aes_params$fill &lt;- &quot;blue&quot;     #geom_ribbon</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$colour &lt;- &quot;black&quot; </span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$size &lt;- 1</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   p1 &lt;- p + labs(x=&quot;Simulation median es&quot;)+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_prism()</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   res[[i]] &lt;- p1</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_grid(plotlist = res)</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>sim_filter_driver <span class="sc">%&gt;%</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes_remove_drivers<span class="sc">$</span>es),</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="co">#p$layers[[4]]$aes_params$label &lt;- &quot;Actual median ES&quot; #geom_text</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-9-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">##save</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># neo_nes_summ &lt;- neo_nes_summ %&gt;% </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   rowwise() %&gt;% </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(p=mean(summ2$median_es[summ2$cancer==cancer] &lt;= median_es))</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(neo_nes_summ,file = &quot;neo_nes_summ_ccf_061.rds&quot;)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>neo_nes3 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>p)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_summ_ccf_061.rds&quot;</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">get_f1</span>(neo_nes3,<span class="at">pancancer_p =</span> <span class="fl">0.0055</span>,<span class="at">dt2 =</span> neo_nes_summ,<span class="at">median_es =</span> <span class="fu">median</span>(neo_nes3<span class="sc">$</span>es))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-9-2.svg" width="2400" /></p>
<p>Several cancer types including ACC, PAAD, UCEC, LUAD show significant low ESCCF values. This data demonstrates the existence of immunoediting-elimination signal in TCGA dataset.</p>
<p>We then calculated the EXP-ES and corresponding simulation median ES distribution:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_tpm_not_filter.rds&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,tpm_exp,neo,chr,position,gene) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">exp=</span>tpm_exp)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_a=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;not_neo&quot;</span>),<span class="at">n_c=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_a<span class="sc">&gt;=</span><span class="dv">1</span>,n_c<span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>pancancer_mutation <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_mutation.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(Sample_ID,chrom,start,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index,Amino_Acid_Change)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  pancancer_mutation</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,Amino_Acid_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/driver_mutations.rds&quot;</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)<span class="do">##0.004702473</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(gene[neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>],</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                                 gene[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##778 samples</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;neo&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;no&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sample <span class="sc">%in%</span> summ2<span class="sc">$</span>sample))</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> neo_exp <span class="sc">%&gt;%</span> </span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,neo,exp)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">TRUE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>                             <span class="co">#df &lt;- data.frame(sample=x,es=a)</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_exp)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nes_exp,<span class="at">file =</span> <span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample) <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,exp)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_exp)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nes_exp,<span class="at">file =</span> <span class="st">&quot;../data/es_exp_not_filter_driver.rds&quot;</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a><span class="do">##sim</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_not_filter_driver.rds&quot;</span>)</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_tpm_not_filter.rds&quot;</span>)</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> </span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,tpm_exp,neo) <span class="sc">%&gt;%</span> </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">exp=</span>tpm_exp)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> neo_nes<span class="sc">$</span>sample)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(exp))</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">40</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">FALSE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>                             df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>x,<span class="at">es=</span>a)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(df)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo))) <span class="sc">%&gt;%</span> </span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;../data/sim_2000_not_filter_driver_exp.rds&quot;</span>)</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_2000_not_filter_driver_exp.rds&quot;</span>)</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim_2000_not_filter)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>sim_2000_not_filter<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim_2000_not_filter<span class="sc">$</span>sample,</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim_2000_not_filter,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_not_filter_driver_exp_all.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_not_filter_driver_exp_all.rds&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>sim_filter_driver <span class="ot">&lt;-</span> sim_all <span class="sc">%&gt;%</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> nes_exp<span class="sc">$</span>sample)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>sim_filter_driver <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>nes_exp<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(nes_exp<span class="sc">$</span>sample)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> nes_exp <span class="sc">%&gt;%</span> </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">#The following code can be used to plot cancer type simulation which showd in FigS7 </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">#res &lt;- vector(&quot;list&quot;,30)</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:30){</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt &lt;- sim_all %&gt;% filter(cancer==neo_nes_summ$cancer[i])</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   dt_summ &lt;- dt %&gt;% </span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     group_by(sim_num) %&gt;%</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarise(median_es=median(es))</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- WVPlots::ShadedDensity(frame = dt_summ, </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                               xvar = &quot;median_es&quot;,</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                               threshold = neo_nes_summ$median_es[i],</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                               title = neo_nes_summ$cancer[i],</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                               tail = &quot;left&quot;)</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$colour &lt;- &quot;red&quot;</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[1]]$aes_params$size &lt;- 1</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[2]]$aes_params$fill &lt;- &quot;blue&quot;     #geom_ribbon</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$colour &lt;- &quot;black&quot; </span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   p$layers[[3]]$aes_params$size &lt;- 1</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   p1 &lt;- p + labs(x=&quot;Simulation median es&quot;)+</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_prism()</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   res[[i]] &lt;- p1</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_grid(plotlist = res)</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(nes_exp<span class="sc">$</span>es),</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="co">#p$layers[[4]]$aes_params$label &lt;- &quot;Actual median ES&quot; #geom_text</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">75</span>,<span class="dv">100</span>))</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-11-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">##save</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># neo_nes_summ &lt;- neo_nes_summ %&gt;% </span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   rowwise() %&gt;% </span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(p=mean(summ2$median_es[summ2$cancer==cancer] &lt;= median_es))</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(neo_nes_summ,file = &quot;../data/neo_nes_summ_exp.rds&quot;)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_summ_exp.rds&quot;</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">get_f1</span>(nes_exp,<span class="at">pancancer_p =</span> <span class="st">&quot;&lt; 0.0005&quot;</span>,<span class="at">dt2 =</span> neo_nes_summ,<span class="at">median_es =</span> <span class="fu">median</span>(nes_exp<span class="sc">$</span>es))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-11-2.svg" width="2400" /></p>
<p>In majority of cancer types (including KICH, DLBC, CHOL, SARC, LUAD, PAAD, UCS, STAD, LGG, LUSC, HNSC, OV, UCEC, BRCA, LIHC, COAD), a significant low ESRNA values are observed . This study demonstrates that the immunoediting escape through down-regulating the expression of neoantigenic alteration is prevalent in human cancer.</p>
<p>When we compared the median cancer type CCF-ES and EXP-ES, we found the significant negative corrlation between this two type ES value:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">##these add p data can be calculated by change the parameter of need_p to TRUE</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>nes_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>nes_ccf_exp <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  nes_ccf <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf_es=</span>es),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  nes_exp <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">exp_es=</span>es)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>nes_ccf_exp<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(nes_ccf_exp<span class="sc">$</span>sample)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>nes_ccf_exp <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_ccf_es=</span><span class="fu">median</span>(ccf_es),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">median_exp_es=</span><span class="fu">median</span>(exp_es)) <span class="ot">-&gt;</span> summ_ccf_exp</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(summ_ccf_exp<span class="sc">$</span>median_ccf_es,summ_ccf_exp<span class="sc">$</span>median_exp_es)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  Pearson&#39;s product-moment correlation</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; data:  summ_ccf_exp$median_ccf_es and summ_ccf_exp$median_exp_es</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; t = -3.5673, df = 28, p-value = 0.001323</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; alternative hypothesis: true correlation is not equal to 0</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 95 percent confidence interval:</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  -0.7651667 -0.2488362</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; sample estimates:</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        cor </span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -0.5589928</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> summ_ccf_exp,<span class="fu">aes</span>(<span class="at">x=</span>median_ccf_es,<span class="at">y=</span>median_exp_es))<span class="sc">+</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se=</span><span class="cn">FALSE</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> cancer), <span class="at">size =</span> <span class="dv">3</span>,<span class="at">max.overlaps=</span><span class="dv">35</span>)<span class="sc">+</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_cor</span>(<span class="at">label.y =</span> <span class="fl">0.2</span>,<span class="at">label.x =</span> <span class="dv">0</span>,</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(..r.label.., ..p.label.., <span class="at">sep =</span> <span class="st">&quot;~`,`~&quot;</span>)),</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">size=</span><span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Median CCF ES&quot;</span>,<span class="at">y=</span><span class="st">&quot;Median EXP ES&quot;</span>)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-12-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>nes_ccf_exp <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">per_escape=</span><span class="fu">mean</span>(exp_es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value<span class="sc">&lt;</span><span class="fl">0.05</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">median_es=</span><span class="fu">median</span>(ccf_es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(summ<span class="sc">$</span>per_escape,summ<span class="sc">$</span>median_es)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  Pearson&#39;s product-moment correlation</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; data:  summ$per_escape and summ$median_es</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; t = 3.5254, df = 28, p-value = 0.001476</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; alternative hypothesis: true correlation is not equal to 0</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 95 percent confidence interval:</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  0.2426552 0.7624262</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; sample estimates:</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       cor </span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 0.5544535</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> summ,<span class="fu">aes</span>(<span class="at">x=</span>median_es,<span class="at">y=</span>per_escape))<span class="sc">+</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se=</span><span class="cn">FALSE</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> cancer), <span class="at">size =</span> <span class="dv">3</span>,<span class="at">max.overlaps=</span><span class="dv">35</span>)<span class="sc">+</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_cor</span>(<span class="at">label.y =</span> <span class="fl">0.12</span>,<span class="at">label.x =</span> <span class="fl">0.1</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(..r.label.., ..p.label.., <span class="at">sep =</span> <span class="st">&quot;~`,`~&quot;</span>)),</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">size=</span><span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Median CCF ES&quot;</span>,<span class="at">y=</span><span class="st">&quot;Escape sample percent&quot;</span>)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-12-2.svg" width="2400" /></p>
</div>
<div id="neoantigen-enrichment-score-and-immune-negative-selection-strength-quantification" class="section level2">
<h2>Neoantigen enrichment score and immune negative selection strength quantification</h2>
<p>Here we investigate the connections between neoantigen enrichment score (ESCCF) and immune negative selection strength s using a stochastic branching cancer evolution model as previously described (Lakatos et al., 2020). The detail of simulation process was described in the Method part and code can be found in <code>code/julia/simulation.jl</code>.</p>
<p>Mutations harbored in at least 5 cells out of 105 were collected at the end of each simulation and the CCF was calculated. To account for imperfect sequencing measurements, CCF values were computed via a simulated sequencing step introducing noise to these frequencies with the indicated read depth (see method):</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>cal_ccf <span class="ot">&lt;-</span> <span class="cf">function</span>(depth){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(ccf){</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dbl</span>(ccf,<span class="cf">function</span>(x,y){<span class="fu">rbinom</span>(<span class="dv">1</span>,y,x)<span class="sc">/</span>y},depth)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>dep_ccf <span class="ot">&lt;-</span> <span class="fu">cal_ccf</span>(<span class="at">depth =</span> <span class="dv">200</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/merge/&quot;</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="dv">50</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/test/data/merge/&quot;</span>,files[i]))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mut_neo=</span><span class="fu">ifelse</span>(mut_neo<span class="sc">==</span><span class="st">&quot;false&quot;</span>,<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>mut_neo)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  s<span class="sc">$</span>ccf_noise <span class="ot">&lt;-</span> <span class="fu">dep_ccf</span>(s<span class="sc">$</span>ccf)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ccf_noise<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_noise)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  tt <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(s)<span class="do">##calculate ES</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> tt</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;complete &quot;</span>,i))</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>nes_sim <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(res)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>nes_sim <span class="ot">&lt;-</span> nes_sim <span class="sc">%&gt;%</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selection =</span> <span class="fu">substr</span>(sample,<span class="dv">3</span>,<span class="dv">6</span>))</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nes_sim,<span class="at">file =</span> <span class="st">&quot;../data/nes_sim_growth_200_addp.rds&quot;</span>)</span></code></pre></div>
<p>We can plot the distribution of ES of 100 simulated tumors (read depth 200×) across different selection strength and the precent of significant tumors (FDR adjust p value &lt;0.1):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>nes_sim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/nes_sim_growth_200_addp.rds&quot;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>nes_sim<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(nes_sim<span class="sc">$</span>selection)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>need_s <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">0.24</span>,<span class="fl">0.02</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>nes_sim_s <span class="ot">&lt;-</span> nes_sim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(s <span class="sc">%in%</span> need_s)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>nes_sim_s,<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">paste0</span>(<span class="st">&quot;-&quot;</span>,selection),<span class="at">y=</span>es,<span class="at">fill=</span>selection))<span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>()<span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span>(<span class="sc">-</span><span class="fl">0.023</span>),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size=</span><span class="dv">1</span>,<span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>)<span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Selection&quot;</span>,<span class="at">y=</span><span class="st">&quot;ES&quot;</span>)<span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span>F)<span class="sc">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun=</span><span class="st">&quot;median&quot;</span>, <span class="at">geom=</span><span class="st">&quot;point&quot;</span>,<span class="at">color=</span><span class="st">&quot;yellow&quot;</span>,<span class="at">size=</span><span class="dv">2</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &quot;none&quot;)` instead.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-14-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>nes_sim_s <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(selection) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">adj_p=</span><span class="fu">p.adjust</span>(p,<span class="at">method =</span> <span class="st">&quot;fdr&quot;</span>),<span class="at">sig_per=</span><span class="fu">mean</span>(adj_p<span class="sc">&lt;</span><span class="fl">0.1</span>)) <span class="ot">-&gt;</span> summ</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;selection&#39;. You can override using the</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>summ <span class="ot">&lt;-</span> summ <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(selection) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">per=</span><span class="fu">unique</span>(sig_per))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>summ,<span class="fu">aes</span>(<span class="at">x=</span>selection,<span class="at">y=</span>per<span class="sc">*</span><span class="dv">100</span>))<span class="sc">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Selection&quot;</span>,<span class="at">y=</span><span class="st">&quot;Percent of significant samples (%)&quot;</span>)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-14-2.svg" width="2400" /></p>
<p>ES-CCF show near linear correlation with s values. This analysis suggests that the quantified ES-CCF can be used to infer the immune selection strength in patient. The median ES-CCF in TCGA datasets is -0.023, suggesting a median immune negative selection strength s=-0.08.</p>
<p>Using this simulated data, we can also compare our method with other method. To compare the power of our method with method used in this study (Lakatos et al., 2020), we used two side K-S test to detect the difference between the VAF distribution of all mutations and neoantigen-associated mutations and reported K-S D statistic and corresponding p value:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/merge/&quot;</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="dv">50</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>){</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/test/data/merge/&quot;</span>,files[i]))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mut_neo=</span><span class="fu">ifelse</span>(mut_neo<span class="sc">==</span><span class="st">&quot;false&quot;</span>,<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>mut_neo)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  s<span class="sc">$</span>ccf_noise <span class="ot">&lt;-</span> <span class="fu">dep_ccf</span>(s<span class="sc">$</span>ccf)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ccf_noise<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_noise)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(s<span class="sc">$</span>sample)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                             neo <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                             ks_t <span class="ot">&lt;-</span> <span class="fu">ks.test</span>(neo<span class="sc">$</span>ccf,data<span class="sc">$</span>ccf)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>                             ttt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">D=</span>ks_t<span class="sc">$</span>statistic,<span class="at">p=</span>ks_t<span class="sc">$</span>p.value,<span class="at">sample=</span>x)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(ttt)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  res_ones <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> res_ones</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;complete &quot;</span>,i))</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>res_ks <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(res)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>res_ks<span class="sc">$</span>selection <span class="ot">&lt;-</span> <span class="fu">substr</span>(res_ks<span class="sc">$</span>sample,<span class="dv">3</span>,<span class="dv">6</span>)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res_ks,<span class="at">file =</span> <span class="st">&quot;../data/ks_sim_depth200.rds&quot;</span>)</span></code></pre></div>
<p>Plot the distribution of KS D statics of 100 simulated tumors (read depth 200×) across different selection strength and the precent of significant tumors (FDR adjust p value &lt;0.1)</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>res_ks <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/ks_sim_depth200.rds&quot;</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>res_ks<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(res_ks<span class="sc">$</span>selection)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>need_s <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">0.24</span>,<span class="fl">0.02</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>res_ks_s <span class="ot">&lt;-</span> res_ks <span class="sc">%&gt;%</span> <span class="fu">filter</span>(s <span class="sc">%in%</span> need_s)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>res_ks_s,<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">paste0</span>(<span class="st">&quot;-&quot;</span>,selection),<span class="at">y=</span>D,<span class="at">fill=</span>selection))<span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>()<span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Selection&quot;</span>,<span class="at">y=</span><span class="st">&quot;K-S statistic&quot;</span>)<span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span>F)<span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun=</span><span class="st">&quot;median&quot;</span>, <span class="at">geom=</span><span class="st">&quot;point&quot;</span>,<span class="at">color=</span><span class="st">&quot;yellow&quot;</span>,<span class="at">size=</span><span class="dv">1</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &quot;none&quot;)` instead.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-16-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>res_ks_s <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(selection) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">adj_p=</span><span class="fu">p.adjust</span>(p,<span class="at">method =</span> <span class="st">&quot;fdr&quot;</span>),<span class="at">sig_per=</span><span class="fu">mean</span>(adj_p<span class="sc">&lt;</span><span class="fl">0.1</span>)) <span class="ot">-&gt;</span> summ</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;selection&#39;. You can override using the</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>summ,<span class="fu">aes</span>(<span class="at">x=</span>selection,<span class="at">y=</span>sig_per))<span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Selection&quot;</span>,<span class="at">y=</span><span class="st">&quot;Percent of significant samples&quot;</span>)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-16-2.svg" width="2400" /> Of note, no tumors show significant signal under the same simulated conditions.</p>
<p>To futher compare the power of methods, in addition to sequencing limitations, we also added different proportions of false positive neoantigen: we randomly sampled nonantigenic mutations of simulated tumors (varied between 5 and 500% of the number of true neoantigen) that were falsely labeled as neoantigen. Then we calculated the number of significant samples in each read depth and proportions of false positive neoantigen combination as the power of method to detect selection strength:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">###power analysis</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="do">##es</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>cal_ccf <span class="ot">&lt;-</span> <span class="cf">function</span>(depth){</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(ccf){</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dbl</span>(ccf,<span class="cf">function</span>(x,y){<span class="fu">rbinom</span>(<span class="dv">1</span>,y,x)<span class="sc">/</span>y},depth)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>neo_per <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">20</span>,<span class="dv">50</span>,<span class="dv">100</span>,<span class="dv">200</span>,<span class="dv">500</span>)<span class="sc">*</span><span class="fl">0.01</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>depth <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">100</span>,<span class="dv">200</span>,<span class="dv">500</span>,<span class="dv">800</span>,<span class="dv">1000</span>,<span class="dv">2000</span>,<span class="dv">5000</span>,<span class="dv">10000</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">63</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>com <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(neo_per,depth)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>com<span class="sc">$</span>lable <span class="ot">&lt;-</span> <span class="fu">paste</span>(com<span class="sc">$</span>Var1,com<span class="sc">$</span>Var2,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(re) <span class="ot">&lt;-</span> com<span class="sc">$</span>lable</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/test/data/merge/0.24.rds&quot;</span>))</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mut_neo=</span><span class="fu">ifelse</span>(mut_neo<span class="sc">==</span><span class="st">&quot;false&quot;</span>,<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">neo=</span>mut_neo) <span class="sc">%&gt;%</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mut_sample_id=</span><span class="fu">paste</span>(sample,mut,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20211024</span>)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> neo_per){</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> depth){</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    dep_ccf <span class="ot">&lt;-</span> <span class="fu">cal_ccf</span>(<span class="at">depth =</span> j)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    neo <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo <span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    neo_summ <span class="ot">&lt;-</span> neo <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">neo_c=</span><span class="fu">n</span>())</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo <span class="sc">!=</span> <span class="st">&quot;yes&quot;</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> <span class="fu">left_join</span>(not_neo,neo_summ)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    false_neo <span class="ot">&lt;-</span> not_neo <span class="sc">%&gt;%</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">sample_id=</span><span class="fu">sample</span>(mut_sample_id,<span class="fu">unique</span>(neo_c)<span class="sc">*</span>i,<span class="at">replace =</span> F))</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> not_neo <span class="sc">%&gt;%</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">neo =</span> <span class="fu">ifelse</span>(mut_sample_id <span class="sc">%in%</span> false_neo<span class="sc">$</span>sample_id,<span class="st">&quot;yes&quot;</span>,neo))</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> <span class="fu">rbind</span>(neo,not_neo <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>neo_c))</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    s_new<span class="sc">$</span>ccf_noise <span class="ot">&lt;-</span> <span class="fu">dep_ccf</span>(s_new<span class="sc">$</span>ccf)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> s_new <span class="sc">%&gt;%</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(ccf_noise<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> s_new <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_noise)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(s_new)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    re[[<span class="fu">paste</span>(i,j,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)]] <span class="ot">&lt;-</span> a</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">&quot;FP &quot;</span>,i,<span class="st">&quot; &amp; depth &quot;</span>,j,<span class="st">&quot; complted </span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(re,<span class="at">file =</span> <span class="st">&quot;../data/sim_growth_power_alt.rds&quot;</span>)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="do">##KS</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> neo_per){</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> depth){</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    dep_ccf <span class="ot">&lt;-</span> <span class="fu">cal_ccf</span>(<span class="at">depth =</span> j)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    neo <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo <span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    neo_summ <span class="ot">&lt;-</span> neo <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">neo_c=</span><span class="fu">n</span>())</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo <span class="sc">!=</span> <span class="st">&quot;yes&quot;</span>)</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> <span class="fu">left_join</span>(not_neo,neo_summ)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">#false_neo &lt;- sample(not_neo$mut,nrow(neo)*i,replace = F)</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    false_neo <span class="ot">&lt;-</span> not_neo <span class="sc">%&gt;%</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">sample_id=</span><span class="fu">sample</span>(mut_sample_id,<span class="fu">unique</span>(neo_c)<span class="sc">*</span>i,<span class="at">replace =</span> F))</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    not_neo <span class="ot">&lt;-</span> not_neo <span class="sc">%&gt;%</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">neo =</span> <span class="fu">ifelse</span>(mut_sample_id <span class="sc">%in%</span> false_neo<span class="sc">$</span>sample_id,<span class="st">&quot;yes&quot;</span>,neo))</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> <span class="fu">rbind</span>(neo,not_neo <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>neo_c))</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>    s_new<span class="sc">$</span>ccf_noise <span class="ot">&lt;-</span> <span class="fu">dep_ccf</span>(s_new<span class="sc">$</span>ccf)</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> s_new <span class="sc">%&gt;%</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(ccf_noise<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    s_new <span class="ot">&lt;-</span> s_new <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_noise)</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>    results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(s_new<span class="sc">$</span>sample)))</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(s_new<span class="sc">$</span>sample)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>                             <span class="cf">function</span>(x){</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>                               data <span class="ot">&lt;-</span> s_new <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>                               neo <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>                               ks_t <span class="ot">&lt;-</span> <span class="fu">ks.test</span>(neo<span class="sc">$</span>ccf,data<span class="sc">$</span>ccf)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>                               ttt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">D=</span>ks_t<span class="sc">$</span>statistic,<span class="at">p=</span>ks_t<span class="sc">$</span>p.value,<span class="at">sample=</span>x)</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">return</span>(ttt)</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>                             },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopCluster</span>(cl)</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>    res_ones <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>    re[[<span class="fu">paste</span>(i,j,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)]] <span class="ot">&lt;-</span> res_ones</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">&quot;FP &quot;</span>,i,<span class="st">&quot; &amp; depth &quot;</span>,j,<span class="st">&quot; complted </span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(re,<span class="at">file =</span> <span class="st">&quot;../data/sim_growth_power_alt_ks.rds&quot;</span>)</span></code></pre></div>
<p>We used heatmap to display the power:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">##es</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_growth_power_alt.rds&quot;</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">neo_depth=</span><span class="fu">names</span>(re),<span class="at">fre=</span><span class="cn">NA</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)){</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> re[[i]]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>padj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(dt<span class="sc">$</span>p,<span class="at">method =</span> <span class="st">&quot;fdr&quot;</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="fu">names</span>(re)[i],<span class="st">&quot; &quot;</span>,<span class="fu">sum</span>(dt<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span>)))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>fre[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(dt<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_50 38&quot;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_50 33&quot;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_50 21&quot;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_50 0&quot;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_50 7&quot;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_50 0&quot;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_50 0&quot;</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_100 83&quot;</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_100 73&quot;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_100 63&quot;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_100 44&quot;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_100 13&quot;</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_100 0&quot;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_100 4&quot;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_200 90&quot;</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_200 89&quot;</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_200 70&quot;</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_200 53&quot;</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_200 28&quot;</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_200 12&quot;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_200 0&quot;</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_500 99&quot;</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_500 99&quot;</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_500 83&quot;</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_500 71&quot;</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_500 51&quot;</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_500 11&quot;</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_500 1&quot;</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_800 98&quot;</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_800 97&quot;</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_800 92&quot;</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_800 79&quot;</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_800 44&quot;</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_800 19&quot;</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_800 1&quot;</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_1000 100&quot;</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_1000 99&quot;</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_1000 92&quot;</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_1000 75&quot;</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_1000 46&quot;</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_1000 34&quot;</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_1000 7&quot;</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_2000 100&quot;</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_2000 100&quot;</span></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_2000 97&quot;</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_2000 88&quot;</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_2000 70&quot;</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_2000 16&quot;</span></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_2000 0&quot;</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_5000 100&quot;</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_5000 100&quot;</span></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_5000 98&quot;</span></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_5000 95&quot;</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_5000 72&quot;</span></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_5000 31&quot;</span></span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_5000 7&quot;</span></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_10000 100&quot;</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_10000 100&quot;</span></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_10000 98&quot;</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_10000 95&quot;</span></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_10000 79&quot;</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_10000 48&quot;</span></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_10000 9&quot;</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> neo_depth,<span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;neo_per&quot;</span>,<span class="st">&quot;depth&quot;</span>),<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">depth=</span><span class="fu">paste0</span>(<span class="st">&quot;depth&quot;</span>,depth)) <span class="sc">%&gt;%</span></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> depth,<span class="at">values_from =</span> fre) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> mat</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> mat<span class="sc">$</span>neo_per</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>neo_per)</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;#551A8B&quot;</span>, <span class="st">&quot;#8B3A62&quot;</span>, <span class="st">&quot;#FFFF00&quot;</span>)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;depth&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="fu">colnames</span>(mat))</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(<span class="fu">rownames</span>(mat)))</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a><span class="fu">Heatmap</span>(mat,<span class="at">cluster_columns =</span> F,<span class="at">cluster_rows =</span> F,<span class="at">row_names_side =</span> <span class="st">&quot;left&quot;</span>,</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Power(%)&quot;</span>,<span class="at">col =</span> cols,</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_title =</span> <span class="st">&quot;Ratio of false positive </span><span class="sc">\n</span><span class="st"> neoantigens added (%)&quot;</span>,</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">column_title =</span> <span class="st">&quot;Read depth&quot;</span>,<span class="at">column_names_rot =</span> <span class="dv">0</span>,<span class="at">column_title_side =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: The input is a data frame, convert it to a matrix.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-18-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="do">##ks</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_growth_power_alt_ks.rds&quot;</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">neo_depth=</span><span class="fu">names</span>(re),<span class="at">fre=</span><span class="cn">NA</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)){</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> re[[i]]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>padj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(dt<span class="sc">$</span>p,<span class="at">method =</span> <span class="st">&quot;fdr&quot;</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="fu">names</span>(re)[i],<span class="st">&quot; &quot;</span>,<span class="fu">sum</span>(dt<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span>)))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>fre[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(dt<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.1</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_50 0&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_50 0&quot;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_50 0&quot;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_50 0&quot;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_50 0&quot;</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_50 0&quot;</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_50 0&quot;</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_100 0&quot;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_100 0&quot;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_100 0&quot;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_100 0&quot;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_100 0&quot;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_100 0&quot;</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_100 0&quot;</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_200 0&quot;</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_200 0&quot;</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_200 0&quot;</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_200 0&quot;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_200 0&quot;</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_200 0&quot;</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_200 0&quot;</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_500 66&quot;</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_500 62&quot;</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_500 30&quot;</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_500 16&quot;</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_500 1&quot;</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_500 0&quot;</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_500 0&quot;</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_800 95&quot;</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_800 85&quot;</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_800 68&quot;</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_800 47&quot;</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_800 13&quot;</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_800 0&quot;</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_800 0&quot;</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_1000 97&quot;</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_1000 97&quot;</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_1000 95&quot;</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_1000 55&quot;</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_1000 19&quot;</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_1000 0&quot;</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_1000 0&quot;</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_2000 100&quot;</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_2000 100&quot;</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_2000 99&quot;</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_2000 96&quot;</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_2000 73&quot;</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_2000 0&quot;</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_2000 0&quot;</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_5000 100&quot;</span></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_5000 100&quot;</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_5000 100&quot;</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_5000 100&quot;</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_5000 98&quot;</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_5000 65&quot;</span></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_5000 0&quot;</span></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0_10000 100&quot;</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.05_10000 100&quot;</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.2_10000 100&quot;</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0.5_10000 100&quot;</span></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1_10000 100&quot;</span></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;2_10000 96&quot;</span></span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;5_10000 0&quot;</span></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(<span class="at">col =</span> neo_depth,<span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;neo_per&quot;</span>,<span class="st">&quot;depth&quot;</span>),<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">depth=</span><span class="fu">paste0</span>(<span class="st">&quot;depth&quot;</span>,depth)) <span class="sc">%&gt;%</span></span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> depth,<span class="at">values_from =</span> fre) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> mat</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> mat<span class="sc">$</span>neo_per</span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>neo_per)</span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;#551A8B&quot;</span>, <span class="st">&quot;#8B3A62&quot;</span>, <span class="st">&quot;#FFFF00&quot;</span>)</span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;depth&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="fu">colnames</span>(mat))</span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(<span class="fu">rownames</span>(mat)))</span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a><span class="fu">Heatmap</span>(mat,<span class="at">cluster_columns =</span> F,<span class="at">cluster_rows =</span> F,<span class="at">row_names_side =</span> <span class="st">&quot;left&quot;</span>,</span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Power(%)&quot;</span>,<span class="at">col =</span> cols,</span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_title =</span> <span class="st">&quot;Ratio of false positive </span><span class="sc">\n</span><span class="st"> neoantigens added (%)&quot;</span>,</span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">column_title =</span> <span class="st">&quot;Read depth&quot;</span>,<span class="at">column_names_rot =</span> <span class="dv">0</span>,<span class="at">column_title_side =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: The input is a data frame, convert it to a matrix.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-18-2.svg" width="2400" /></p>
</div>
<div id="pan-cancer-features-and-correlations-of-immunoediting-signal" class="section level2">
<h2>Pan-cancer features and correlations of immunoediting signal</h2>
<p>Then we compared the immune cell infiltration level between tumors with detectable immunoediting-elimination signal (ESCCF&lt;0, P&lt;0.05) or immunoediting-escape signal (ESRNA&lt;0, P&lt;0.05) and other samples:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pancancer_subtcells <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_subtcells.rds&quot;</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>nes_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>ccf_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  nes_ccf,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  pancancer_subtcells</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>exp_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  nes_exp ,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  pancancer_subtcells</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_T<span class="sc">+</span>NK))<span class="sc">+</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8 T + NK&quot;</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>iTreg<span class="sc">+</span>nTreg))<span class="sc">+</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span><span class="st">&quot;iTreg + nTreg&quot;</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 70 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 70 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 70 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 70 rows containing non-finite values (stat_compare_means).</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-19-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_T<span class="sc">+</span>NK))<span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8 T + NK&quot;</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>iTreg<span class="sc">+</span>nTreg))<span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span><span class="st">&quot;iTreg + nTreg&quot;</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>p3 <span class="sc">+</span> p4</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 92 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 92 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 92 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 92 rows containing non-finite values (stat_compare_means).</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-19-2.svg" width="2400" /></p>
<p>In tumors with detectable immunoediting-elimination signal, a slightly increased CD8+ T cell infiltration status compared with the remaining samples were observed, but the difference does not reach statistical significance (P=0.2). This data suggests that historically happened immunoediting-elimination process may not be reflected in the current immune cell infiltration status.</p>
<p>The immunoediting-escape signal quantified as ES-RNA also do not show statistically significant difference between samples with detectable immunoediting-escape signal and the remaining samples in CD8+ T cell infiltration. However we observe a significant up-regulated regulatory T cell (Treg) percentage in samples with detectable immunoediting-escape signal, and up-regulated Treg has been reported to stimulate tumor immune escape.</p>
</div>
</div>
<div id="immunotherapy-dataset-analysis" class="section level1">
<h1>Immunotherapy dataset analysis</h1>
<div id="quantified-immunoediting-elimination-signal-predicts-the-clinical-response-of-cancer-immunotherapy" class="section level2">
<h2>Quantified immunoediting-elimination signal predicts the clinical response of cancer immunotherapy</h2>
<p>To investigate the predictive performance of the quantified immunoediting-elimination signal (ESCCF) in ICI response prediction for individual patient, we searched for public ICI datasets with raw WES data and RNA-seq data available, and three melanoma ICI datasets have been identified. Then we calculated the immunoediting-elimination signal (ES-CCF) for each patient:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_mut_ccf_ici.rds&quot;</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="ot">&lt;-</span> all_mut_ccf_ici <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>cancer_cell_frac) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>samples_has_subclonal <span class="ot">&lt;-</span> all_mut_ccf_ici <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ccf<span class="sc">&lt;</span><span class="fl">0.6</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sample)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> samples_has_subclonal<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf_ici <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">18</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>es <span class="ot">&lt;-</span> <span class="fu">round</span>(neo_nes<span class="sc">$</span>es,<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/nes_immunetherapy.rds&quot;</span>)</span></code></pre></div>
<p>In univariate Cox proportional hazards regression analysis, quantified ESCCF value is significantly associated with cancer patients’ survival (p=0.03), and low ESCCF value (suggest the presence of high immunoediting-elimination signal) is associated with improved ICI clinical response (Hazard ratio (HR)=3.74, 95%CI=1.11-12.6) :</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>all_clinical <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_clinical.rds&quot;</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/nes_immunetherapy.rds&quot;</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,all_clinical,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response2))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="do">##cox analysis</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">show_forest</span>(neo_nes,<span class="at">covariates =</span> <span class="st">&quot;es&quot;</span>,<span class="at">time =</span> <span class="st">&quot;OS.time&quot;</span>,<span class="at">status =</span> <span class="st">&quot;OS&quot;</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable es</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Resized limits to included dashed line in forest panel</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-21-1.svg" width="2400" /></p>
<p>Patients are divided into three groups based on ES-CCF value cutoff determined by <code>surv_cutpoint</code> function, patients with lowest ES-CCF values (indicate the presence of immunoediting-elimination signal) show the best survival after ICI:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_mut_ccf_ici.rds&quot;</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="ot">&lt;-</span> all_mut_ccf_ici <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>cancer_cell_frac) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">surv_cutpoint</span>(neo_nes,<span class="st">&quot;OS.time&quot;</span>,<span class="st">&quot;OS&quot;</span>,<span class="st">&quot;es&quot;</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    cutpoint statistic</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; es   -0.222  2.443914</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    es <span class="sc">&lt;=</span> (<span class="sc">-</span><span class="fl">0.222</span>) <span class="sc">~</span> <span class="st">&quot;low&quot;</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    es <span class="sc">&gt;</span> (<span class="sc">-</span><span class="fl">0.222</span>) <span class="sc">~</span> <span class="st">&quot;high&quot;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>low <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(es_type<span class="sc">==</span><span class="st">&quot;low&quot;</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>high <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(es_type<span class="sc">==</span><span class="st">&quot;high&quot;</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>all_clinical <span class="ot">&lt;-</span> all_clinical <span class="sc">%&gt;%</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> all_mut_ccf_ici<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">case_when</span>(</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    sample <span class="sc">%in%</span> low<span class="sc">$</span>sample <span class="sc">~</span> <span class="st">&quot;low&quot;</span>,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    sample <span class="sc">%in%</span> high<span class="sc">$</span>sample <span class="sc">~</span> <span class="st">&quot;high&quot;</span>,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;others&quot;</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">show_km</span>(all_clinical,<span class="st">&quot;type&quot;</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-22-1.svg" width="2400" /></p>
<p>we use logistic regression to compare the efficiency of ESCCF, TMB and neoantigenic mutation count in predicting immunotherapy clinical response. Relationship between prognosis (patients with clinical response or without clinical response) and ESCCF, TMB and neoantigenic mutation count was analyzed. The goodness of fit was performed by Hosmer–Lemeshow test (H-L test):</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">obj=</span><span class="fu">ifelse</span>(response2<span class="sc">==</span><span class="st">&quot;response&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(obj <span class="sc">~</span> es, <span class="at">data =</span> neo_nes, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; glm(formula = obj ~ es, family = &quot;binomial&quot;, data = neo_nes)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Deviance Residuals: </span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -1.1562  -0.8402  -0.7737   1.4243   1.7095  </span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)  -0.8676     0.2247  -3.862 0.000113 ***</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; es           -1.1293     0.9067  -1.246 0.212942    </span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 118.34  on 96  degrees of freedom</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 116.79  on 95  degrees of freedom</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; AIC: 120.79</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">performance_hosmer</span>(model)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Hosmer-Lemeshow Goodness-of-Fit Test</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Chi-squared: 4.874</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;            df: 8    </span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       p-value: 0.771</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Summary: model seems to fit well.</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="sc">%&gt;%</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">tmb=</span><span class="fu">n</span>()<span class="sc">/</span><span class="dv">38</span>,<span class="at">nb=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)<span class="sc">/</span><span class="dv">38</span>) <span class="ot">-&gt;</span> tmb_nb</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,tmb_nb)</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(obj <span class="sc">~</span> tmb, <span class="at">data =</span> neo_nes, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; glm(formula = obj ~ tmb, family = &quot;binomial&quot;, data = neo_nes)</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Deviance Residuals: </span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -1.5311  -0.7640  -0.7319   1.3947   1.7305  </span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept) -1.30753    0.29590  -4.419 9.92e-06 ***</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; tmb          0.06035    0.02584   2.335   0.0195 *  </span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 118.34  on 96  degrees of freedom</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 110.98  on 95  degrees of freedom</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; AIC: 114.98</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">performance_hosmer</span>(model2)</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Hosmer-Lemeshow Goodness-of-Fit Test</span></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Chi-squared: 15.447</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;            df:  8    </span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       p-value:  0.051</span></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Summary: model seems to fit well.</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(obj <span class="sc">~</span> nb, <span class="at">data =</span> neo_nes, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; glm(formula = obj ~ nb, family = &quot;binomial&quot;, data = neo_nes)</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Deviance Residuals: </span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -1.5523  -0.7890  -0.7279   1.1717   1.7284  </span></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Intercept)  -1.2858     0.3006  -4.278 1.89e-05 ***</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; nb            0.8816     0.4001   2.203   0.0276 *  </span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 118.34  on 96  degrees of freedom</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 112.47  on 95  degrees of freedom</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; AIC: 116.47</span></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">performance_hosmer</span>(model3)</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Hosmer-Lemeshow Goodness-of-Fit Test</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Chi-squared: 9.389</span></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;            df: 8    </span></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       p-value: 0.311</span></span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Summary: model seems to fit well.</span></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(neo_nes, <span class="fu">aes</span>(<span class="at">x=</span>es, <span class="at">y=</span>obj)) <span class="sc">+</span></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span>.<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method=</span><span class="st">&quot;glm&quot;</span>, <span class="at">se=</span><span class="cn">FALSE</span>, <span class="at">fullrange=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family=</span>binomial),<span class="at">color=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;ES&quot;</span>,<span class="at">title =</span> <span class="st">&quot;H-L test P value = 0.771&quot;</span>)</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(neo_nes, <span class="fu">aes</span>(<span class="at">x=</span>tmb, <span class="at">y=</span>obj)) <span class="sc">+</span></span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span>.<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method=</span><span class="st">&quot;glm&quot;</span>, <span class="at">se=</span><span class="cn">FALSE</span>, <span class="at">fullrange=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family=</span>binomial),<span class="at">color=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;TMB&quot;</span>,<span class="at">title =</span> <span class="st">&quot;H-L test P value = 0.051&quot;</span>)</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(neo_nes, <span class="fu">aes</span>(<span class="at">x=</span>nb, <span class="at">y=</span>obj)) <span class="sc">+</span></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span>.<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method=</span><span class="st">&quot;glm&quot;</span>, <span class="at">se=</span><span class="cn">FALSE</span>, <span class="at">fullrange=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family=</span>binomial),<span class="at">color=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Neoantigen burden&quot;</span>,<span class="at">title =</span> <span class="st">&quot;H-L test P value = 0.311&quot;</span>)</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> p4 <span class="sc">+</span> p5 <span class="sc">+</span> p6</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a>p7</span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</span></span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</span></span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-23-1.svg" width="2400" /></p>
<p>The H-L test P-value of TMB is 0.051, close to 0.05, implicate the difference between prediction and expectation is close to significant. The H-L test P-value of ESCCF is 0.771 , suggesting that the quantified immunoediting-elimination signal can be biomarker for ICI clinical response prediction.</p>
<p>ICI clinical response are known to be influenced by variables like gender and drug type, so we performed multivariate Cox regression including treament (Nivolumab or Pembrolizumab) and gender as covariate:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>all_tre <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_treatment.rds&quot;</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  neo_nes,all_tre</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">show_forest</span>(neo_nes,<span class="at">covariates =</span> <span class="fu">c</span>(<span class="st">&quot;es&quot;</span>),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> <span class="st">&quot;OS.time&quot;</span>,<span class="at">status =</span> <span class="st">&quot;OS&quot;</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">controls =</span> <span class="st">&quot;Treatment&quot;</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable es</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in recalculate_width_panels(panel_positions, mapped_text =</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; mapped_text, : Unable to resize forest panel to be smaller than its heading;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; consider a smaller text size</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-24-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_forest</span>(neo_nes,<span class="at">covariates =</span> <span class="fu">c</span>(<span class="st">&quot;es&quot;</span>),</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> <span class="st">&quot;OS.time&quot;</span>,<span class="at">status =</span> <span class="st">&quot;OS&quot;</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">controls =</span> <span class="st">&quot;Gender&quot;</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable es</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-24-2.svg" width="2400" /></p>
<p>Based on this analysis, the effects of ESCCF is not influence by ICI type and gender, however more samples are needed to further validated the clinical effects of ESCCF in ICI clinical response prediction.</p>
</div>
</div>
<div id="supplementary-analyses" class="section level1">
<h1>Supplementary analyses</h1>
<div id="sample-statistics-and-clinical-features" class="section level2">
<h2>Sample statistics and clinical features</h2>
<p>Number of the patient with CCF information and number of patient with at least one neoantigenic mutation and subclonal mutation (CCF&lt;0.6) are shown for each cancer type and number of the patient with mRNA expression information and number of patient with at least one neoantigenic mutation and accompanied mRNA expression information are shown for each cancer type:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">###sample statistics</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_ccf_tpm.rds&quot;</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>samples_has_subclonal <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ccf<span class="sc">&lt;</span><span class="fl">0.6</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sample)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(sample <span class="sc">%in%</span> samples_has_subclonal<span class="sc">$</span>sample,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="ot">-&gt;</span> sample_summ</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>sample_summ<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sample_summ<span class="sc">$</span>sample)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>sample_summ <span class="sc">%&gt;%</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sample_counts=</span><span class="fu">n</span>(),</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">sample_with_neoantigen_counts=</span><span class="fu">sum</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)) <span class="ot">-&gt;</span> cancer_summ</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>cancer_summ <span class="ot">&lt;-</span> cancer_summ <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(sample_counts)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>cancer_summ<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">factor</span>(cancer_summ<span class="sc">$</span>cancer,<span class="at">levels =</span> cancer_summ<span class="sc">$</span>cancer)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>cancer_summ <span class="sc">%&gt;%</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">`</span><span class="at">All samples</span><span class="st">`</span><span class="ot">=</span>sample_counts,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Samples with &gt;= 1 neoantigen and have subclonal mutations</span><span class="st">`</span><span class="ot">=</span>sample_with_neoantigen_counts) <span class="sc">%&gt;%</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;All samples&quot;</span>,<span class="st">&quot;Samples with &gt;= 1 neoantigen and have subclonal mutations&quot;</span>),</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">&quot;type&quot;</span>,</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">&quot;counts&quot;</span>) <span class="ot">-&gt;</span> cancer_summ_longer</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">pyramid_chart</span>(<span class="at">data =</span> cancer_summ_longer, <span class="at">x =</span> cancer, <span class="at">y =</span> counts, <span class="at">group =</span> type)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_tpm_not_filter.rds&quot;</span>)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_a=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;not_neo&quot;</span>),<span class="at">n_c=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)) <span class="ot">-&gt;</span> sample_summ</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>sample_summ<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sample_summ<span class="sc">$</span>sample)</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>sample_summ <span class="sc">%&gt;%</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sample_counts=</span><span class="fu">n</span>(),</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">sample_with_neoantigen_counts=</span><span class="fu">sum</span>(n_a<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> n_c <span class="sc">&gt;=</span><span class="dv">1</span>)) <span class="ot">-&gt;</span> cancer_summ</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>cancer_summ <span class="ot">&lt;-</span> cancer_summ <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(sample_counts)</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>cancer_summ<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">factor</span>(cancer_summ<span class="sc">$</span>cancer,<span class="at">levels =</span> cancer_summ<span class="sc">$</span>cancer)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>cancer_summ <span class="sc">%&gt;%</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">`</span><span class="at">All samples</span><span class="st">`</span><span class="ot">=</span>sample_counts,</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Samples with &gt;= 1 neoantigen</span><span class="st">`</span><span class="ot">=</span>sample_with_neoantigen_counts) <span class="sc">%&gt;%</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;All samples&quot;</span>,<span class="st">&quot;Samples with &gt;= 1 neoantigen&quot;</span>),</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">&quot;type&quot;</span>,</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">&quot;counts&quot;</span>) <span class="ot">-&gt;</span> cancer_summ_longer</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">pyramid_chart</span>(<span class="at">data =</span> cancer_summ_longer, <span class="at">x =</span> cancer, <span class="at">y =</span> counts, <span class="at">group =</span> type)</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>p1 </span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-25-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>p2</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-25-2.svg" width="2400" /></p>
<p>We also calculated the significant sample in each cancer type:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>pancancer_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;sig_neg&quot;</span>,<span class="st">&quot;others&quot;</span>))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>pancancer_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;sig_neg&quot;</span>,<span class="st">&quot;others&quot;</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>pancancer_ccf<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(pancancer_ccf<span class="sc">$</span>sample)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>pancancer_exp<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(pancancer_exp<span class="sc">$</span>sample)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>get_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(dt,total_sig_sample){</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(es_type<span class="sc">==</span><span class="st">&quot;sig_neg&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">counts=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(counts) <span class="sc">%&gt;%</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cancer=</span><span class="fu">factor</span>(cancer,<span class="at">levels =</span> cancer)) <span class="sc">%&gt;%</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Sample proportion</span><span class="st">`</span><span class="ot">=</span> counts<span class="sc">/</span>total_sig_sample) <span class="sc">%&gt;%</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">label=</span><span class="fu">paste</span>(<span class="st">&quot;frac(&quot;</span>,counts,<span class="st">&quot;,&quot;</span>,total_sig_sample,<span class="st">&quot;)&quot;</span>,<span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>sig,<span class="fu">aes</span>(<span class="at">x=</span>cancer,<span class="at">y=</span><span class="st">`</span><span class="at">Sample proportion</span><span class="st">`</span>))<span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>cancer,<span class="at">y=</span><span class="st">`</span><span class="at">Sample proportion</span><span class="st">`</span>),<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>)))<span class="sc">+</span><span class="do">##remove blank in the bottom</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>label), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>), <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.25</span>,<span class="at">size=</span><span class="dv">2</span>,<span class="at">parse=</span><span class="cn">TRUE</span>)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p1)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="fu">get_plot</span>(pancancer_ccf,<span class="fu">sum</span>(pancancer_ccf<span class="sc">$</span>es_type<span class="sc">==</span><span class="st">&quot;sig_neg&quot;</span>))</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-26-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_plot</span>(pancancer_exp,<span class="fu">sum</span>(pancancer_exp<span class="sc">$</span>es_type<span class="sc">==</span><span class="st">&quot;sig_neg&quot;</span>))</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-26-2.svg" width="2400" /></p>
<p>Pan-cancer sample distribution in pie plot:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pancancer_ccf <span class="ot">&lt;-</span> pancancer_ccf <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type2=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p<span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;ES &lt; 0 &amp; P &lt; 0.05&quot;</span>,<span class="st">&quot;Others&quot;</span>))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>pancancer_exp <span class="ot">&lt;-</span> pancancer_exp <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type2=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value<span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;ES &lt; 0 &amp; P &lt; 0.05&quot;</span>,<span class="st">&quot;Others&quot;</span>))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>ccf_es <span class="ot">&lt;-</span> pancancer_ccf<span class="sc">$</span>es</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>ccf_es1 <span class="ot">&lt;-</span> pancancer_ccf<span class="sc">$</span>es_type2</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">1</span>))</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pie</span>(ccf_es,<span class="at">expression =</span> <span class="st">&quot;ccf_es&lt;0&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;ES (CCF) &lt; 0&quot;</span>,<span class="st">&quot;ES (CCF) &gt;= 0&quot;</span>))</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; NULL</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pie</span>(ccf_es1,<span class="at">expression =</span> <span class="st">&quot;ccf_es1==&#39;ES &lt; 0 &amp; P &lt; 0.05&#39;&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;ES (CCF) &lt; 0 &amp; P &lt; 0.05&quot;</span>,<span class="st">&quot;Others&quot;</span>))</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; NULL</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>exp_es <span class="ot">&lt;-</span> pancancer_exp<span class="sc">$</span>es</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>exp_es1 <span class="ot">&lt;-</span> pancancer_exp<span class="sc">$</span>es_type2</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pie</span>(exp_es,<span class="at">expression =</span> <span class="st">&quot;exp_es&lt;0&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;ES (EXP) &lt; 0&quot;</span>,<span class="st">&quot;ES (EXP) &gt;= 0&quot;</span>))</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; NULL</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pie</span>(exp_es1,<span class="at">expression =</span> <span class="st">&quot;exp_es1==&#39;ES &lt; 0 &amp; P &lt; 0.05&#39;&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;ES (EXP) &lt; 0 &amp; P &lt; 0.05&quot;</span>,<span class="st">&quot;Others&quot;</span>))</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-27-1.svg" width="2400" /></p>
<pre><code>#&gt; NULL</code></pre>
<p>The immune-thearpy dataset sample distribution and clinical parameters:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>all_sample_exp_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_mut_ccf_ici.rds&quot;</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>ccf <span class="ot">&lt;-</span> all_sample_exp_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cancer_cell_frac))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>exp <span class="ot">&lt;-</span> all_sample_exp_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(exp))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>all_sample <span class="ot">&lt;-</span> <span class="fu">union</span>(<span class="fu">names</span>(<span class="fu">table</span>(ccf<span class="sc">$</span>sample)),<span class="fu">names</span>(<span class="fu">table</span>(exp<span class="sc">$</span>sample)))</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>both <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(<span class="fu">table</span>(ccf<span class="sc">$</span>sample)),<span class="fu">names</span>(<span class="fu">table</span>(exp<span class="sc">$</span>sample)))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>WES <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(<span class="fu">table</span>(ccf<span class="sc">$</span>sample)),<span class="fu">names</span>(<span class="fu">table</span>(exp<span class="sc">$</span>sample)))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>RNA <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(<span class="fu">table</span>(exp<span class="sc">$</span>sample)),<span class="fu">names</span>(<span class="fu">table</span>(ccf<span class="sc">$</span>sample)))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>all_clinical <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_clinical.rds&quot;</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> all_clinical <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response2<span class="sc">==</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>no_response <span class="ot">&lt;-</span> all_clinical <span class="sc">%&gt;%</span> <span class="fu">filter</span>(response2<span class="sc">!=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>willy_tre <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;../data/Immunotherapy/willy_clinical.csv&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Patient ID</span><span class="st">`</span>,Treatment,Gender,Age) <span class="sc">%&gt;%</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample=</span><span class="st">`</span><span class="at">Patient ID</span><span class="st">`</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">paste</span>(<span class="st">&quot;willy_&quot;</span>,sample,<span class="at">sep =</span> <span class="st">&quot;&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="do">##nadeem Nivolumab</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>nadeem_tre <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>all_sample[<span class="fu">grepl</span>(<span class="st">&quot;nadeem_&quot;</span>,all_sample)],<span class="at">Treatment=</span><span class="st">&quot;Nivolumab&quot;</span>,</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Gender=</span><span class="cn">NA</span>,<span class="at">Age=</span><span class="cn">NA</span>,<span class="at">stringsAsFactors =</span> F)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>liu_clinical <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/liu_clinical.rds&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(X,Tx,<span class="st">`</span><span class="at">gender..Male.1..Female.0.</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Gender=</span><span class="fu">ifelse</span>(<span class="st">`</span><span class="at">gender..Male.1..Female.0.</span><span class="st">`</span><span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;M&quot;</span>,<span class="st">&quot;F&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">gender..Male.1..Female.0.</span><span class="st">`</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Age=</span><span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample=</span>X,<span class="at">Treatment=</span>Tx) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">paste0</span>(<span class="st">&quot;liu_&quot;</span>,sample)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">&quot;_Patient&quot;</span>,sample))</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>all_tre <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">list</span>(willy_tre,nadeem_tre,liu_clinical))</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_tre,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_treatment.rds&quot;</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>all_sample,</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>                 <span class="at">stringsAsFactors =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Data type</span><span class="st">`</span><span class="ot">=</span> <span class="fu">case_when</span>(</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    sample <span class="sc">%in%</span> both <span class="sc">~</span> <span class="st">&quot;Both&quot;</span>,</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    sample <span class="sc">%in%</span> WES <span class="sc">~</span> <span class="st">&quot;WES&quot;</span>,</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    sample <span class="sc">%in%</span> RNA <span class="sc">~</span> <span class="st">&quot;RNA-Seq&quot;</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Response=</span><span class="fu">ifelse</span>(sample <span class="sc">%in%</span> response<span class="sc">$</span>sample,<span class="st">&quot;Responder&quot;</span>,<span class="st">&quot;Non-Responder&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort=</span><span class="fu">gsub</span>(<span class="st">&quot;_.*&quot;</span>,<span class="st">&quot;&quot;</span>,sample)) <span class="sc">%&gt;%</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,all_tre,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(sample)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>dt_cli <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dt,all_clinical,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>cohort_col <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Accent&quot;</span>)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>data_type_col <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Dark2&quot;</span>)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>Response_col <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Set1&quot;</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>Treatment_col <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">3</span>,<span class="st">&quot;Paired&quot;</span>)</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">=</span> <span class="fu">HeatmapAnnotation</span>(</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cohort=</span>dt<span class="sc">$</span>cohort,</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Data type</span><span class="st">`</span> <span class="ot">=</span> dt<span class="sc">$</span><span class="st">`</span><span class="at">Data type</span><span class="st">`</span>,</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">Response =</span> dt<span class="sc">$</span>Response,</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment=</span>dt<span class="sc">$</span>Treatment,</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">list</span>(<span class="at">Cohort=</span><span class="fu">c</span>(<span class="st">&quot;liu&quot;</span><span class="ot">=</span>cohort_col[<span class="dv">1</span>],<span class="st">&quot;nadeem&quot;</span><span class="ot">=</span>cohort_col[<span class="dv">2</span>],<span class="st">&quot;willy&quot;</span><span class="ot">=</span>cohort_col[<span class="dv">3</span>]),</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Data type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;WES&quot;</span> <span class="ot">=</span>data_type_col[<span class="dv">1</span>], <span class="st">&quot;RNA-Seq&quot;</span> <span class="ot">=</span> data_type_col[<span class="dv">2</span>],<span class="st">&quot;Both&quot;</span><span class="ot">=</span>data_type_col[<span class="dv">3</span>]),</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>             <span class="at">Response =</span> <span class="fu">c</span>(<span class="st">&quot;Responder&quot;</span><span class="ot">=</span>Response_col[<span class="dv">1</span>],<span class="st">&quot;Non-Responder&quot;</span><span class="ot">=</span>Response_col[<span class="dv">2</span>]),</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>             <span class="at">Treatment=</span><span class="fu">c</span>(<span class="st">&quot;Nivolumab&quot;</span><span class="ot">=</span>Treatment_col[<span class="dv">1</span>],<span class="st">&quot;Pembrolizumab&quot;</span><span class="ot">=</span>Treatment_col[<span class="dv">2</span>])),</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">annotation_name_side=</span><span class="st">&quot;left&quot;</span>,<span class="at">height =</span> <span class="fu">unit</span>(<span class="dv">300</span>, <span class="st">&quot;cm&quot;</span>),<span class="at">width =</span> <span class="fu">unit</span>(<span class="dv">20</span>, <span class="st">&quot;cm&quot;</span>)</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>lgd1 <span class="ot">=</span> <span class="fu">Legend</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;liu&quot;</span>,<span class="st">&quot;nadeem&quot;</span>,<span class="st">&quot;willy&quot;</span>), <span class="at">legend_gp =</span> <span class="fu">gpar</span>(<span class="at">fill=</span><span class="fu">c</span>(cohort_col[<span class="dv">1</span>],cohort_col[<span class="dv">2</span>],cohort_col[<span class="dv">3</span>])),</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">&quot;Cohort&quot;</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>lgd2 <span class="ot">=</span> <span class="fu">Legend</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;WES&quot;</span>,<span class="st">&quot;RNA-Seq&quot;</span>,<span class="st">&quot;Both&quot;</span>), <span class="at">legend_gp =</span> <span class="fu">gpar</span>(<span class="at">fill=</span><span class="fu">c</span>(data_type_col[<span class="dv">1</span>],data_type_col[<span class="dv">2</span>],data_type_col[<span class="dv">3</span>])),</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">&quot;Data type&quot;</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>lgd3 <span class="ot">=</span> <span class="fu">Legend</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Responder&quot;</span>,<span class="st">&quot;Non-Responder&quot;</span>), <span class="at">legend_gp =</span> <span class="fu">gpar</span>(<span class="at">fill=</span><span class="fu">c</span>(Response_col[<span class="dv">1</span>],Response_col[<span class="dv">2</span>])),</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">&quot;Response&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>lgd4 <span class="ot">=</span> <span class="fu">Legend</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Nivolumab&quot;</span>,<span class="st">&quot;Pembrolizumab&quot;</span>), <span class="at">legend_gp =</span> <span class="fu">gpar</span>(<span class="at">fill=</span><span class="fu">c</span>(Treatment_col[<span class="dv">1</span>],Treatment_col[<span class="dv">2</span>],Treatment_col[<span class="dv">3</span>])),</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">title =</span> <span class="st">&quot;Treatment&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(ha, <span class="at">test =</span> T)</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">=</span> <span class="fu">packLegend</span>(lgd1, lgd2,lgd3,lgd4)</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(pd,<span class="at">x =</span> <span class="fu">unit</span>(<span class="dv">14</span>, <span class="st">&quot;cm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">&quot;cm&quot;</span>), <span class="at">just =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;sample_statistics.png&quot;</span>)</span></code></pre></div>
<p><img src="sample_statistics.png" width="565" /></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>all_sample_exp_ccf <span class="ot">&lt;-</span> <span class="fu">left_join</span>(all_sample_exp_ccf,dt_cli,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>all_sample_exp_ccf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">TMB=</span><span class="fu">log</span>((<span class="fu">n</span>()<span class="sc">/</span><span class="dv">38</span>)<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,dt_cli,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cohort)) <span class="ot">-&gt;</span> all_tmb</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>all_tmb <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cohort) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">tmb_median=</span><span class="fu">median</span>(TMB),<span class="at">tmb_min=</span><span class="fu">min</span>(TMB),<span class="at">max_tmb=</span><span class="fu">max</span>(TMB))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>all_sample_exp_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cohort)) <span class="sc">%&gt;%</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">neo_counts=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,dt_cli,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)<span class="ot">-&gt;</span> all_neo</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>all_neo <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cohort) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_neo=</span><span class="fu">median</span>(neo_counts))</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="do">########表格####</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>gt_input <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort=</span><span class="fu">c</span>(<span class="st">&quot;Liu et.al </span><span class="sc">\n</span><span class="st"> (2019)&quot;</span>,<span class="st">&quot;Hogo et.al </span><span class="sc">\n</span><span class="st"> (2016)&quot;</span>,<span class="st">&quot;Riaz et.al </span><span class="sc">\n</span><span class="st"> (2017)&quot;</span>),</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Tumor type</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;melanoma&quot;</span>,<span class="st">&quot;melanoma&quot;</span>,<span class="st">&quot;melanoma&quot;</span>),</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment=</span><span class="fu">c</span>(<span class="st">&quot;monotherapy&quot;</span>,<span class="st">&quot;monotherapy&quot;</span>,<span class="st">&quot;monotherapy&quot;</span>),</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Strategy=</span><span class="fu">c</span>(<span class="st">&quot;WES RNA-seq&quot;</span>,<span class="st">&quot;WES RNA-seq&quot;</span>,<span class="st">&quot;WES RNA-seq&quot;</span>),</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Patients=</span><span class="fu">c</span>(<span class="dv">130</span>,<span class="dv">37</span>,<span class="dv">56</span>),</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of men(%)</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;77(59.2%)&quot;</span>,<span class="st">&quot;26(70.3%)&quot;</span>,<span class="cn">NA</span>),</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of women(%)</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;53(40.8%)&quot;</span>,<span class="st">&quot;11(29.7%)&quot;</span>,<span class="cn">NA</span>),</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Median age, years</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="dv">61</span>,<span class="cn">NA</span>),</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Median survial time(OS,month)</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="fl">19.4</span>,<span class="fl">18.3</span>,<span class="fl">17.4</span>),</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">TMB median</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="fl">1.42</span>,<span class="fl">2.49</span>,<span class="fl">1.86</span>),</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Neoantigen counts median</span><span class="st">`</span><span class="ot">=</span><span class="fu">c</span>(<span class="fl">28.5</span>,<span class="dv">77</span>,<span class="dv">52</span>)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>gt_tbl <span class="ot">&lt;-</span> <span class="fu">gt</span>(<span class="at">data =</span> gt_input)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>gt_input <span class="sc">%&gt;%</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>(<span class="at">rowname_col =</span> <span class="st">&quot;cohort&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_align</span>(</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="st">&quot;center&quot;</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> gt_tbl</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.table</span>(gt_input)</span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;sample_table.png&quot;</span>)</span></code></pre></div>
<p><img src="sample_table.png" width="641" /></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####oncoprint############</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="do">##liu</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>liu_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/liu_mutations.rds&quot;</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>liu_mutations <span class="ot">&lt;-</span> liu_mutations <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">change=</span><span class="fu">str_extract</span>(cDNA_Change,<span class="st">&quot;[A-Z]&gt;[A-Z]&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Tumor_Seq_Allele2=</span><span class="fu">gsub</span>(<span class="st">&quot;&gt;&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="fu">str_extract</span>(change,<span class="st">&quot;&gt;[A-Z]&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Reference_Allele=</span><span class="fu">gsub</span>(<span class="st">&quot;&gt;&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="fu">str_extract</span>(change,<span class="st">&quot;[A-Z]&gt;&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Tumor_Sample_Barcode=</span>Patient)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>liu_clinical <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/liu_clinical.rds&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">&quot;Patient&quot;</span>,X)) <span class="sc">%&gt;%</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(X,OS,dead) <span class="sc">%&gt;%</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Tumor_Sample_Barcode=</span>X,<span class="at">Overall_Survival_time=</span>OS,<span class="at">Overall_Survival_Status=</span>dead)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>liu <span class="ot">&lt;-</span> <span class="fu">read.maf</span>(<span class="at">maf =</span> liu_mutations,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">clinicalData =</span> liu_clinical,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="fu">oncoplot</span>(<span class="at">maf =</span> liu,<span class="at">top=</span><span class="dv">10</span>,<span class="at">draw_titv =</span> <span class="cn">TRUE</span>,<span class="at">showTitle =</span> <span class="cn">FALSE</span>,<span class="at">removeNonMutated=</span>T)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in titv(maf = maf, useSyn = TRUE, plot = FALSE): Non standard Ti/Tv</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; class: 1540TRUE</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-32-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="do">##willy</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;../data/Immunotherapy/willy/&quot;</span>,<span class="at">full.names =</span> T)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>willy_maf <span class="ot">&lt;-</span> <span class="fu">merge_mafs</span>(<span class="at">mafs =</span> files)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Merging 38 MAF files</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Validating</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Silent variants: 225813 </span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Summarizing</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; --Possible FLAGS among top ten genes:</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   TTN</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   MUC16</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   FLG</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Processing clinical data</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; --Missing clinical data</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Finished in 6.436s elapsed (9.020s cpu)</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="fu">oncoplot</span>(<span class="at">maf =</span> willy_maf,<span class="at">top=</span><span class="dv">10</span>,<span class="at">draw_titv =</span> <span class="cn">TRUE</span>,<span class="at">showTitle =</span> <span class="cn">FALSE</span>,<span class="at">removeNonMutated=</span>T)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-32-2.svg" width="2400" /></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="do">###nadeem</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;../data/Immunotherapy/nadeem/&quot;</span>,<span class="at">full.names =</span> T)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>nadeem_maf <span class="ot">&lt;-</span> <span class="fu">merge_mafs</span>(<span class="at">mafs=</span>files)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Merging 66 MAF files</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Validating</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Silent variants: 84078 </span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Summarizing</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; --Possible FLAGS among top ten genes:</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   TTN</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   MUC16</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   OBSCN</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Processing clinical data</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; --Missing clinical data</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -Finished in 4.399s elapsed (6.626s cpu)</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="fu">oncoplot</span>(<span class="at">maf =</span> nadeem_maf,<span class="at">top=</span><span class="dv">10</span>,<span class="at">draw_titv =</span> <span class="cn">TRUE</span>,<span class="at">showTitle =</span> <span class="cn">FALSE</span>,<span class="at">removeNonMutated=</span>T)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-32-3.svg" width="2400" /></p>
</div>
<div id="robust-of-method" class="section level2">
<h2>Robust of method</h2>
<div id="minimum-number-of-non-neoantigenic-mutations-to-calculate-significant-p" class="section level3">
<h3>Minimum number of non-neoantigenic mutations to calculate significant P</h3>
<p>The calculated sample-level specific P values are dependent on the mutation rank, and also the number of total mutations and the number of antigenic mutations. So we done the simulation analysis to get the minimum number of antigenic and non-antigenic mutations to get confident quantification of ES. For each number of neoantigenic mutation, we put the neoantigenic mutations in the position of CCF interval or TPM expression with the smallest rank, and put the non-neoantigenic mutations in the position of CCF interval or TPM expression with the largest rank. Then we can get the minimum number of non-neoantigenic mutations to calculate significant p values in each number of neoantigenic mutation.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">##CCF </span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">202202181</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>neo_mut <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">10</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  neo_c1 <span class="ot">&lt;-</span> i</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  mut_c1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">rep</span>(<span class="st">&quot;sim&quot;</span>,neo_c1<span class="sc">+</span>mut_c1),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">neo=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;yes&quot;</span>,neo_c1),<span class="fu">rep</span>(<span class="st">&quot;no&quot;</span>,mut_c1)),</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ccf=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.005</span>,neo_c1),<span class="fu">rep</span>(<span class="dv">1</span>,mut_c1)))</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> dt,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">need_p =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  dt_current <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">neo_c=</span>neo_c1,<span class="at">mut_c=</span>mut_c1,<span class="at">es=</span>a<span class="sc">$</span>es,<span class="at">p=</span>a<span class="sc">$</span>p)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (a<span class="sc">$</span>p <span class="sc">&gt;=</span> <span class="fl">0.05</span>){</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    mut_c1 <span class="ot">&lt;-</span> mut_c1 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">rep</span>(<span class="st">&quot;sim&quot;</span>,neo_c1<span class="sc">+</span>mut_c1),</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">neo=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;yes&quot;</span>,neo_c1),<span class="fu">rep</span>(<span class="st">&quot;no&quot;</span>,mut_c1)),</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ccf=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.005</span>,neo_c1),<span class="fu">rep</span>(<span class="dv">1</span>,mut_c1)))</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> dt,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">need_p =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    dt_current[j,] <span class="ot">&lt;-</span> <span class="fu">c</span>(neo_c1,mut_c1,a<span class="sc">$</span>es,a<span class="sc">$</span>p)</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(dt_current)</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  neo_mut[[i]] <span class="ot">&lt;-</span> dt_current</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>neo_mut <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(neo_mut)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_mut,<span class="at">file =</span> <span class="st">&quot;../data/ccf_neo_mut_counts.rds&quot;</span>)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="do">###exp</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>neo_mut_exp <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">10</span>)</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>  neo_c1 <span class="ot">&lt;-</span> i</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>  mut_c1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">rep</span>(<span class="st">&quot;sim&quot;</span>,neo_c1<span class="sc">+</span>mut_c1),</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>                   <span class="at">neo=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;neo&quot;</span>,neo_c1),<span class="fu">rep</span>(<span class="st">&quot;not_neo&quot;</span>,mut_c1))) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">exp=</span><span class="fu">row_number</span>())</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> <span class="st">&quot;sim&quot;</span>,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>                              <span class="at">calp =</span> <span class="cn">TRUE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>  dt_current <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">neo_c=</span>neo_c1,<span class="at">mut_c=</span>mut_c1,<span class="at">es=</span>a<span class="sc">$</span>es,<span class="at">p=</span>a<span class="sc">$</span>p_value)</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (a<span class="sc">$</span>p_value <span class="sc">&gt;=</span> <span class="fl">0.05</span>){</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>    mut_c1 <span class="ot">&lt;-</span> mut_c1 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">rep</span>(<span class="st">&quot;sim&quot;</span>,neo_c1<span class="sc">+</span>mut_c1),</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">neo=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;neo&quot;</span>,neo_c1),<span class="fu">rep</span>(<span class="st">&quot;not_neo&quot;</span>,mut_c1))) <span class="sc">%&gt;%</span> </span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">exp=</span><span class="fu">row_number</span>())</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> <span class="st">&quot;sim&quot;</span>,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>                                <span class="at">calp =</span> <span class="cn">TRUE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    dt_current[j,] <span class="ot">&lt;-</span> <span class="fu">c</span>(neo_c1,mut_c1,a<span class="sc">$</span>es,a<span class="sc">$</span>p_value)</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(dt_current)</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>  neo_mut_exp[[i]] <span class="ot">&lt;-</span> dt_current</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>neo_mut_exp <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(neo_mut_exp)</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_mut_exp,<span class="at">file =</span> <span class="st">&quot;../data/exp_neo_mut_counts.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>neo_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/ccf_neo_mut_counts.rds&quot;</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>neo_mut_sig <span class="ot">&lt;-</span> neo_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p<span class="sc">&lt;</span><span class="fl">0.05</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>neo_mut_sig <span class="ot">&lt;-</span> neo_mut_sig <span class="sc">%&gt;%</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">all_mut_counts=</span>neo_c<span class="sc">+</span>mut_c)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>neo_mut_sig,<span class="fu">aes</span>(<span class="at">x=</span>neo_c,<span class="at">y=</span>all_mut_counts))<span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;neoantigen counts&quot;</span>,<span class="at">y=</span><span class="st">&quot;all mutation counts&quot;</span>)<span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span>neo_mut_sig<span class="sc">$</span>neo_c, <span class="at">labels =</span> neo_mut_sig<span class="sc">$</span>neo_c)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>neo_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/exp_neo_mut_counts.rds&quot;</span>)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>neo_mut_exp_sig <span class="ot">&lt;-</span> neo_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p<span class="sc">&lt;</span><span class="fl">0.05</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>neo_mut_sig <span class="ot">&lt;-</span> neo_mut_exp_sig <span class="sc">%&gt;%</span> </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">all_mut_counts=</span>neo_c<span class="sc">+</span>mut_c)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>neo_mut_sig,<span class="fu">aes</span>(<span class="at">x=</span>neo_c,<span class="at">y=</span>all_mut_counts))<span class="sc">+</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>)<span class="sc">+</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;neoantigen counts&quot;</span>,<span class="at">y=</span><span class="st">&quot;all mutation counts&quot;</span>)<span class="sc">+</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span>neo_mut_sig<span class="sc">$</span>neo_c, <span class="at">labels =</span> neo_mut_sig<span class="sc">$</span>neo_c)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>p1<span class="sc">/</span>p2</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-34-1.svg" width="2400" /></p>
<p>For example, if a patient sample only have one neoantigenic mutations, then at least 20 total mutations are required for reliable quantification of the immunoediting signal. This is a bottom line requirement, and indicates that any samples with 1 neoantigenic mutation and less than 20 total mutations will not have the chance to have significant (P&lt;0.05) immunoediting signal.</p>
</div>
<div id="threshold-for-neoantigen-prediction" class="section level3">
<h3>Threshold for neoantigen prediction</h3>
<p>We used the less stringent threshold: IC50 &lt; 500 and %Rank &lt; 2 and TPM &gt; 1 (TPM cutoff only for calculating ESccf) to filter neoantigens. This increases the precent of antigenic mutatoins from 9% to 19% for dataset used to calculate ESccf and from 16% to 31% for dataset used to calculated ESrna:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;~/test/data/2021_03_31/&quot;</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">100</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste</span>(<span class="st">&quot;~/test/data/2021_03_31/&quot;</span>,files[i],<span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  neo <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(novelty <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(IC50 <span class="sc">&lt;</span> <span class="dv">500</span> <span class="sc">&amp;</span> bindlevel<span class="sc">==</span><span class="st">&quot;WB&quot;</span> <span class="sc">&amp;</span> novelty<span class="sc">==</span><span class="dv">1</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo =</span> <span class="fu">ifelse</span>(index <span class="sc">%in%</span> neo<span class="sc">$</span>index , <span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> mut</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,chr,position,ref,alt,neo,gene,exp)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene=</span><span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">:.+&quot;</span>,<span class="st">&quot;&quot;</span>,gene))</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut,<span class="at">file =</span> <span class="st">&quot;../data/all_mut_rank2_IC50.rds&quot;</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a><span class="do">##add tmp</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/useful_data/xena_RSEM_TPM/tpm_trans.rds&quot;</span>)</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> tpm[<span class="sc">!</span><span class="fu">duplicated</span>(tpm<span class="sc">$</span>gene),]</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>all_mut<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(sample,gene){</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>  tpm[tpm<span class="sc">$</span>gene<span class="sc">==</span>gene,<span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">15</span>)]</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>},all_mut<span class="sc">$</span>sample,all_mut<span class="sc">$</span>gene)</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">lengths</span>(tpm_exp)<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>all_mut1<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(all_mut1<span class="sc">$</span>tpm_exp)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut1,<span class="at">file =</span> <span class="st">&quot;data/all_mut_tpm_not_filter_Rank2_IC50.rds&quot;</span>)<span class="do">##this file is used to calculte EXP-ES</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo2=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span> <span class="sc">&amp;</span> tpm_exp<span class="sc">&gt;</span><span class="dv">1</span>,<span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>neo,<span class="sc">-</span>exp) <span class="sc">%&gt;%</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">neo=</span>neo2)</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut1,<span class="at">file =</span> <span class="st">&quot;data/all_mut_tpm_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a><span class="do">##add ccf</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/test/data/2021_04_05/all_mut_mis_ccf.rds&quot;</span>)</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>all_mut_tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/all_mut_tpm_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> all_mut_tpm <span class="sc">%&gt;%</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,ref,alt,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">ref_allele=</span>ref,<span class="at">alt_allele=</span>alt)</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>  all_mut,</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>  results <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>sample),</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="st">&quot;index&quot;</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf[<span class="sc">!</span><span class="fu">duplicated</span>(all_mut_ccf<span class="sc">$</span>index),]</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut_ccf,<span class="at">file =</span> <span class="st">&quot;data/all_mut_ccf_tpm_Rank2_IC50.rds&quot;</span>)<span class="do">##This file is used to calculate CCF-ES</span></span></code></pre></div>
<p>Caculate ESccf and ESrna:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">##cal</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/all_mut_ccf_tpm_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/Immunoediting/data/driver_mutations.rds&quot;</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>samples_has_subclonal <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ccf<span class="sc">&lt;</span><span class="fl">0.6</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sample)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(Hugo_Symbol,Protein_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)<span class="do">##0.01388538</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(Hugo_Symbol[neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>],</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>                                 Hugo_Symbol[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##701 samples</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,Hugo_Symbol,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;yes&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>need_samples <span class="ot">&lt;-</span> <span class="fu">intersect</span>(samples_has_subclonal<span class="sc">$</span>sample,summ2<span class="sc">$</span>sample)</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>all_mut_ccf  <span class="sc">%&gt;%</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> need_samples) <span class="sc">%&gt;%</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample)</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense)</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(neo_nes<span class="sc">$</span>es)<span class="do">##0.19的新抗原</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/neo_es_ccf_IC50_Rank2.rds&quot;</span>)</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a><span class="do">###模拟</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_es_ccf_IC50_Rank2.rds&quot;</span>)</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_ccf_tpm_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> neo_nes<span class="sc">$</span>sample)</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span></span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo))) </span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;../data/sim_2000_filter_driver_IC50_Rank2.rds&quot;</span>)</span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_2000_filter_driver_IC50_Rank2.rds&quot;</span>)</span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim_2000)</span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a>sim_2000<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim_2000<span class="sc">$</span>sample,</span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim_2000,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_filter_driver_IC50_Rank2_all_ccf.rds&quot;</span>)</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a><span class="do">##cal rna</span></span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/tmp/all_mut_tpm_not_filter_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,tpm_exp,neo,chr,position,gene) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">exp=</span>tpm_exp)</span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_a=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;not_neo&quot;</span>),<span class="at">n_c=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_a<span class="sc">&gt;=</span><span class="dv">1</span>,n_c<span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a>pancancer_mutation <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/pancancer_mutation.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(Sample_ID,chrom,start,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index,Amino_Acid_Change)</span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a>  all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)),</span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a>  pancancer_mutation</span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-121"><a href="#cb59-121" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb59-122"><a href="#cb59-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,Amino_Acid_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb59-123"><a href="#cb59-123" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/Immunoediting/data/driver_mutations.rds&quot;</span>)</span>
<span id="cb59-124"><a href="#cb59-124" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb59-125"><a href="#cb59-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb59-126"><a href="#cb59-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-127"><a href="#cb59-127" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb59-128"><a href="#cb59-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb59-129"><a href="#cb59-129" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)<span class="do">##0.01029878</span></span>
<span id="cb59-130"><a href="#cb59-130" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-131"><a href="#cb59-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(gene[neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>],</span>
<span id="cb59-132"><a href="#cb59-132" aria-hidden="true" tabindex="-1"></a>                                 gene[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##1949 samples</span></span>
<span id="cb59-133"><a href="#cb59-133" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb59-134"><a href="#cb59-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb59-135"><a href="#cb59-135" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;neo&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb59-136"><a href="#cb59-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-137"><a href="#cb59-137" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb59-138"><a href="#cb59-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-139"><a href="#cb59-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-140"><a href="#cb59-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-141"><a href="#cb59-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;no&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb59-142"><a href="#cb59-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-143"><a href="#cb59-143" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-144"><a href="#cb59-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sample <span class="sc">%in%</span> summ2<span class="sc">$</span>sample))</span>
<span id="cb59-145"><a href="#cb59-145" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> neo_exp <span class="sc">%&gt;%</span> </span>
<span id="cb59-146"><a href="#cb59-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,neo,exp)</span>
<span id="cb59-147"><a href="#cb59-147" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb59-148"><a href="#cb59-148" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb59-149"><a href="#cb59-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb59-150"><a href="#cb59-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-151"><a href="#cb59-151" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb59-152"><a href="#cb59-152" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb59-153"><a href="#cb59-153" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb59-154"><a href="#cb59-154" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb59-155"><a href="#cb59-155" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">TRUE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb59-156"><a href="#cb59-156" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb59-157"><a href="#cb59-157" aria-hidden="true" tabindex="-1"></a>                             <span class="co">#df &lt;- data.frame(sample=x,es=a)</span></span>
<span id="cb59-158"><a href="#cb59-158" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb59-159"><a href="#cb59-159" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-160"><a href="#cb59-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb59-161"><a href="#cb59-161" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb59-162"><a href="#cb59-162" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb59-163"><a href="#cb59-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb59-164"><a href="#cb59-164" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-165"><a href="#cb59-165" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_exp)</span>
<span id="cb59-166"><a href="#cb59-166" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nes_exp,<span class="at">file =</span> <span class="st">&quot;../data/nes_exp_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-167"><a href="#cb59-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-168"><a href="#cb59-168" aria-hidden="true" tabindex="-1"></a><span class="do">##sim</span></span>
<span id="cb59-169"><a href="#cb59-169" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/nes_exp_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-170"><a href="#cb59-170" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/tmp/all_mut_tpm_not_filter_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-171"><a href="#cb59-171" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> </span>
<span id="cb59-172"><a href="#cb59-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,tpm_exp,neo) <span class="sc">%&gt;%</span> </span>
<span id="cb59-173"><a href="#cb59-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">exp=</span>tpm_exp)</span>
<span id="cb59-174"><a href="#cb59-174" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> neo_nes<span class="sc">$</span>sample)</span>
<span id="cb59-175"><a href="#cb59-175" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(exp))</span>
<span id="cb59-176"><a href="#cb59-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-177"><a href="#cb59-177" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb59-178"><a href="#cb59-178" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb59-179"><a href="#cb59-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb59-180"><a href="#cb59-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-181"><a href="#cb59-181" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">35</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb59-182"><a href="#cb59-182" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb59-183"><a href="#cb59-183" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb59-184"><a href="#cb59-184" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb59-185"><a href="#cb59-185" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">FALSE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb59-186"><a href="#cb59-186" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb59-187"><a href="#cb59-187" aria-hidden="true" tabindex="-1"></a>                             df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>x,<span class="at">es=</span>a)</span>
<span id="cb59-188"><a href="#cb59-188" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(df)</span>
<span id="cb59-189"><a href="#cb59-189" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-190"><a href="#cb59-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb59-191"><a href="#cb59-191" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb59-192"><a href="#cb59-192" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb59-193"><a href="#cb59-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb59-194"><a href="#cb59-194" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-195"><a href="#cb59-195" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb59-196"><a href="#cb59-196" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb59-197"><a href="#cb59-197" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span></span>
<span id="cb59-198"><a href="#cb59-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb59-199"><a href="#cb59-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo))) <span class="sc">%&gt;%</span> </span>
<span id="cb59-200"><a href="#cb59-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb59-201"><a href="#cb59-201" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb59-202"><a href="#cb59-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb59-203"><a href="#cb59-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb59-204"><a href="#cb59-204" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb59-205"><a href="#cb59-205" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb59-206"><a href="#cb59-206" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb59-207"><a href="#cb59-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb59-208"><a href="#cb59-208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-209"><a href="#cb59-209" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;../data/sim_2000_es_exp_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-210"><a href="#cb59-210" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_2000_es_exp_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb59-211"><a href="#cb59-211" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim_2000)</span>
<span id="cb59-212"><a href="#cb59-212" aria-hidden="true" tabindex="-1"></a>sim_2000<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim_2000<span class="sc">$</span>sample,</span>
<span id="cb59-213"><a href="#cb59-213" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb59-214"><a href="#cb59-214" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim_2000,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_es_exp_Rank2_IC50_all.rds&quot;</span>)</span></code></pre></div>
<p>Then we can get the pan-cancer simulation p values:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_es_ccf_IC50_Rank2.rds&quot;</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_filter_driver_IC50_Rank2_all_ccf.rds&quot;</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>cancer <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">get_cancer_type</span>(neo_nes<span class="sc">$</span>sample)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes<span class="sc">$</span>es),</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="do">##rna</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/nes_exp_Rank2_IC50.rds&quot;</span>)</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_es_exp_Rank2_IC50_all.rds&quot;</span>)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>cancer <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">get_cancer_type</span>(neo_nes<span class="sc">$</span>sample)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> </span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes<span class="sc">$</span>es),</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>p1<span class="sc">/</span>p2</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-37-1.svg" width="2400" /></p>
<p>Under this new cutoff, a trend in ESCCF signal (ES=-0.013, P=0.054) can still be observed. The pan-cancer ESRNA signal (ES=-0.056, P&lt;0.005) is still significant.</p>
</div>
<div id="another-method-for-neoantigen-prediction" class="section level3">
<h3>Another method for neoantigen prediction</h3>
<p>We also used MHCfurry implemented in pVACtools to predict neoantigen (cutoff settings: IC50&lt;50 and %Rank &lt;0.5 and TPM &gt;1, and 16% of mutations are predicted as neoantigen), and calculted corresponding ESccf and ESrna. The shell script of predicting neoantigen using pVACseq can be found in <code>code/shell/pVACseq.sh</code>:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="do">##process output</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;/public/slst/home/wutao2/TCGA_pvacseq/out_files_names&quot;</span>,<span class="at">data.table =</span> F,<span class="at">header =</span> F)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> samples<span class="sc">$</span>V1){</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;/public/slst/home/wutao2/TCGA_pvacseq/out_files/&quot;</span>,i),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data.table =</span> F)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">select</span>(Chromosome,Start,Stop,Reference,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                      Variant,<span class="st">`</span><span class="at">Gene Name</span><span class="st">`</span>,<span class="st">`</span><span class="at">HLA Allele</span><span class="st">`</span>,</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">MHCflurry MT Score</span><span class="st">`</span>,<span class="st">`</span><span class="at">MHCflurry MT Percentile</span><span class="st">`</span>,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">MHCnuggetsI MT Score</span><span class="st">`</span>,<span class="st">`</span><span class="at">Sample Name</span><span class="st">`</span>)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(dt,<span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;/public/slst/home/wutao2/TCGA_pvacseq/out_reorganized/&quot;</span>,i),</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">col.names =</span> F,<span class="at">row.names =</span> F,<span class="at">quote =</span> F)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="do">##get neoantigen</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;/public/slst/home/wutao2/TCGA_pvacseq/out_reorganized&quot;</span>,<span class="at">full.names =</span> T)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="fu">length</span>(files))</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)){</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(files[i],<span class="at">data.table =</span> F)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">paste</span>(V1,V2,V3,V4,V5,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  neo_mhcfurry <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(V8<span class="sc">&lt;</span><span class="dv">50</span> <span class="sc">&amp;</span> V9 <span class="sc">&lt;</span><span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T)</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  neo_mhcnuggets <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(V10 <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T)</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>  mut <span class="ot">&lt;-</span> mut <span class="sc">%&gt;%</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_MHCfurry =</span> <span class="fu">ifelse</span>(index <span class="sc">%in%</span> neo_mhcfurry<span class="sc">$</span>index , <span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_MHCnuggets =</span> <span class="fu">ifelse</span>(index <span class="sc">%in%</span> neo_mhcnuggets<span class="sc">$</span>index , <span class="st">&quot;neo&quot;</span>,<span class="st">&quot;not_neo&quot;</span>))</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>  re[[i]] <span class="ot">&lt;-</span> mut</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>all_mut <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(re)</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut,<span class="at">file =</span> <span class="st">&quot;/public/slst/home/wutao2/TCGA_pvacseq/res/all_mut_neo.rds&quot;</span>)</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="do">##add tpm and ccf</span></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(all_mut)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;gene&quot;</span>,<span class="st">&quot;sample&quot;</span>) </span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a><span class="do">##add tpm</span></span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/data/tpm_trans.rds&quot;</span>)</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> tpm[<span class="sc">!</span><span class="fu">duplicated</span>(tpm<span class="sc">$</span>gene),]</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>all_mut<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(sample,gene){</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>  tpm[tpm<span class="sc">$</span>gene<span class="sc">==</span>gene,<span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">15</span>)]</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>},all_mut<span class="sc">$</span>sample,all_mut<span class="sc">$</span>gene)</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut <span class="sc">%&gt;%</span></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">lengths</span>(tpm_exp)<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>all_mut1<span class="sc">$</span>tpm_exp <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(all_mut1<span class="sc">$</span>tpm_exp)</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span> </span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">separate</span>(<span class="at">col =</span> index,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>,<span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;p&quot;</span>,<span class="st">&quot;position&quot;</span>,<span class="st">&quot;ref&quot;</span>,<span class="st">&quot;alt&quot;</span>))</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>p)</span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut1,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/all_mut_neo_exp.rds&quot;</span>)</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_mis_ccf.rds&quot;</span>)</span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>all_mut1 <span class="ot">&lt;-</span> all_mut1 <span class="sc">%&gt;%</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,ref,alt,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">ref_allele=</span>ref,<span class="at">alt_allele=</span>alt)</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>  all_mut1,</span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>  results <span class="sc">%&gt;%</span> <span class="fu">select</span>(index,ccf_hat,Protein_Change),</span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="st">&quot;index&quot;</span></span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(index,<span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>index)</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_mut_ccf,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/all_mut_neo_ccf.rds&quot;</span>)</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a><span class="do">##cal ccf</span></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a><span class="do">##cal es</span></span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a><span class="do">##mhcfurry</span></span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/another_methods/all_mut_neo_ccf.rds&quot;</span>)</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo_MHCfurry<span class="sc">==</span><span class="st">&quot;neo&quot;</span> <span class="sc">&amp;</span> tpm_exp<span class="sc">&gt;</span><span class="dv">1</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,Protein_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/driver_mutations.rds&quot;</span>)</span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_ccf<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)<span class="do">## 0.0134365</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(gene[neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>],</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>                                 gene[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##1560 samples</span></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;yes&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;yes&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a>samples_has_subclonal <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ccf<span class="sc">&lt;</span><span class="fl">0.6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sample)</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>need_samples <span class="ot">&lt;-</span> <span class="fu">intersect</span>(samples_has_subclonal<span class="sc">$</span>sample,summ2<span class="sc">$</span>sample)</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a>all_mut_ccf  <span class="sc">%&gt;%</span></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> need_samples) <span class="sc">%&gt;%</span></span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">c_n=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="at">c_m=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(c_n<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> c_m <span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample)</span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">40</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>                             data <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> x)</span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cal_nes_new_test</span>(<span class="at">dt =</span> data,</span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">need_p =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(a)</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense)</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/es_ccf_mhcfurry_filter_driver.rds&quot;</span>)</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_missense,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/mut_cal_ccf.rds&quot;</span>)</span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a><span class="do">##sim</span></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense <span class="sc">%&gt;%</span></span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo))) <span class="sc">%&gt;%</span> </span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;../data/sim_2000_es_ccf_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sim_2000_es_ccf_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>sim_2000 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim_2000)</span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>sim_2000<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim_2000<span class="sc">$</span>sample,</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim_2000,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_filter_all_ccf_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a><span class="do">##exp</span></span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/another_methods/all_mut_neo_exp.rds&quot;</span>)</span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> </span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">neo=</span>neo_MHCfurry) <span class="sc">%&gt;%</span> </span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">exp=</span>tpm_exp)</span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_a=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;not_neo&quot;</span>),<span class="at">n_c=</span><span class="fu">sum</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_a<span class="sc">&gt;=</span><span class="dv">1</span>,n_c<span class="sc">&gt;=</span><span class="dv">1</span>) <span class="ot">-&gt;</span> summ</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>pancancer_mutation <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_mutation.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(Sample_ID,chrom,start,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index,Amino_Acid_Change)</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>  all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">index=</span><span class="fu">paste</span>(sample,chr,position,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)),</span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>  pancancer_mutation</span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,Amino_Acid_Change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/driver_mutations.rds&quot;</span>)</span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>driver_mutations <span class="ot">&lt;-</span> driver_mutations <span class="sc">%&gt;%</span></span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_protein_change=</span><span class="fu">paste</span>(gene,protein_change,<span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_driver=</span><span class="fu">ifelse</span>(gene_protein_change <span class="sc">%in%</span> driver_mutations<span class="sc">$</span>gene_protein_change,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">&amp;</span> all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>) <span class="sc">/</span> <span class="fu">sum</span>(all_mut_exp<span class="sc">$</span>neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>)<span class="do">##0.006262794</span></span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inter_gene=</span><span class="fu">intersect</span>(gene[neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>],</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>                                 gene[is_driver<span class="sc">==</span><span class="st">&quot;yes&quot;</span>])) <span class="ot">-&gt;</span> aaa<span class="do">##1707 samples</span></span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,neo,gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>aaa <span class="ot">&lt;-</span> aaa <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample_neo_index=</span><span class="fu">paste</span>(sample,<span class="st">&quot;neo&quot;</span>,inter_gene,<span class="at">sep =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a>all_mut_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_aaa =</span> <span class="fu">ifelse</span>(sample_neo_index <span class="sc">%in%</span> aaa<span class="sc">$</span>sample_neo_index,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">need_sample=</span><span class="fu">ifelse</span>(<span class="fu">any</span>(in_aaa<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(need_sample<span class="sc">==</span><span class="st">&quot;no&quot;</span>) <span class="ot">-&gt;</span> summ2</span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> all_mut_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">%in%</span> summ<span class="sc">$</span>sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sample <span class="sc">%in%</span> summ2<span class="sc">$</span>sample))</span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> neo_exp <span class="sc">%&gt;%</span> </span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,neo,exp)</span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb61-200"><a href="#cb61-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb61-201"><a href="#cb61-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">FALSE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>                             df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>x,<span class="at">es=</span>a)</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(df)</span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_exp)</span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nes_exp,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/es_exp_filter_driver_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_exp,<span class="at">file =</span> <span class="st">&quot;../data/another_methods/mut_call_exp_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a><span class="do">##sim</span></span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a>neo_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/another_methods/mut_call_exp_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a>cal_nes_warp <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(dt<span class="sc">$</span>sample)))</span>
<span id="cb61-224"><a href="#cb61-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results_ccf) <span class="ot">&lt;-</span> <span class="fu">unique</span>(dt<span class="sc">$</span>sample)</span>
<span id="cb61-225"><a href="#cb61-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-226"><a href="#cb61-226" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">getOption</span>(<span class="st">&quot;cl.cores&quot;</span>, <span class="dv">20</span>),<span class="at">type=</span><span class="st">&quot;FORK&quot;</span>)</span>
<span id="cb61-227"><a href="#cb61-227" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">parSapply</span>(<span class="at">cl=</span>cl,<span class="fu">names</span>(results_ccf),</span>
<span id="cb61-228"><a href="#cb61-228" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">function</span>(x){</span>
<span id="cb61-229"><a href="#cb61-229" aria-hidden="true" tabindex="-1"></a>                             a <span class="ot">&lt;-</span> NeoEnrichment<span class="sc">::</span><span class="fu">cales_t</span>(<span class="at">data =</span> dt,<span class="at">barcode =</span> x,<span class="at">type =</span> <span class="st">&quot;II&quot;</span>,</span>
<span id="cb61-230"><a href="#cb61-230" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">calp =</span> <span class="cn">FALSE</span>,<span class="at">sample_counts =</span> <span class="dv">1000</span>,</span>
<span id="cb61-231"><a href="#cb61-231" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">cal_type =</span> <span class="st">&quot;exp&quot;</span>)</span>
<span id="cb61-232"><a href="#cb61-232" aria-hidden="true" tabindex="-1"></a>                             df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span>x,<span class="at">es=</span>a)</span>
<span id="cb61-233"><a href="#cb61-233" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>(df)</span>
<span id="cb61-234"><a href="#cb61-234" aria-hidden="true" tabindex="-1"></a>                           },<span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-235"><a href="#cb61-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb61-236"><a href="#cb61-236" aria-hidden="true" tabindex="-1"></a>  results_ccf <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="cf">function</span>(x){<span class="fu">length</span>(x)<span class="sc">&gt;</span><span class="dv">1</span>},results_ccf)</span>
<span id="cb61-237"><a href="#cb61-237" aria-hidden="true" tabindex="-1"></a>  pancancer_nes_ccf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_ccf)</span>
<span id="cb61-238"><a href="#cb61-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pancancer_nes_ccf)</span>
<span id="cb61-239"><a href="#cb61-239" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-240"><a href="#cb61-240" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="dv">2000</span>)</span>
<span id="cb61-241"><a href="#cb61-241" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>){</span>
<span id="cb61-242"><a href="#cb61-242" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_exp <span class="sc">%&gt;%</span></span>
<span id="cb61-243"><a href="#cb61-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb61-244"><a href="#cb61-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">neo_sim=</span><span class="fu">sample</span>(neo,<span class="fu">length</span>(neo))) <span class="sc">%&gt;%</span> </span>
<span id="cb61-245"><a href="#cb61-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb61-246"><a href="#cb61-246" aria-hidden="true" tabindex="-1"></a>  neo_missense_sim <span class="ot">&lt;-</span> neo_missense_sim <span class="sc">%&gt;%</span></span>
<span id="cb61-247"><a href="#cb61-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>neo) <span class="sc">%&gt;%</span></span>
<span id="cb61-248"><a href="#cb61-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">neo=</span>neo_sim)</span>
<span id="cb61-249"><a href="#cb61-249" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim <span class="ot">&lt;-</span> <span class="fu">cal_nes_warp</span>(neo_missense_sim)</span>
<span id="cb61-250"><a href="#cb61-250" aria-hidden="true" tabindex="-1"></a>  neo_nes_sim<span class="sc">$</span>sim_num <span class="ot">&lt;-</span> i</span>
<span id="cb61-251"><a href="#cb61-251" aria-hidden="true" tabindex="-1"></a>  res[[i]] <span class="ot">&lt;-</span> neo_nes_sim</span>
<span id="cb61-252"><a href="#cb61-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Complete &quot;</span>,i,<span class="st">&quot; sim. &quot;</span>))</span>
<span id="cb61-253"><a href="#cb61-253" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-254"><a href="#cb61-254" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(res,<span class="at">file =</span> <span class="st">&quot;data/sim_2000_filter_driver_exp_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-255"><a href="#cb61-255" aria-hidden="true" tabindex="-1"></a>sim2000 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/sim_2000_filter_driver_exp_mhcfurry.rds&quot;</span>)</span>
<span id="cb61-256"><a href="#cb61-256" aria-hidden="true" tabindex="-1"></a>sim2000 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sim2000)</span>
<span id="cb61-257"><a href="#cb61-257" aria-hidden="true" tabindex="-1"></a>sim2000<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(sim2000<span class="sc">$</span>sample,<span class="at">parallel =</span> T,<span class="at">cores =</span> <span class="dv">20</span>)</span>
<span id="cb61-258"><a href="#cb61-258" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sim2000,<span class="at">file =</span> <span class="st">&quot;../../tmp/sim_2000_filter_all_exp_mhcfurry.rds&quot;</span>)</span></code></pre></div>
<p>Then we can get the simulation p values for MHCfurry dataset:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">##ccf mhcfurry</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/another_methods/es_ccf_mhcfurry_filter_driver.rds&quot;</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_filter_all_ccf_mhcfurry.rds&quot;</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(neo_nes<span class="sc">$</span>sample)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes<span class="sc">$</span>es),</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="do">###exp mhcfurry</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/another_methods/es_exp_filter_driver_mhcfurry.rds&quot;</span>)</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_filter_all_exp_mhcfurry.rds&quot;</span>)</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(neo_nes<span class="sc">$</span>sample)</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>neo_nes_summ <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> </span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>sim_all <span class="sc">%&gt;%</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ, </span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(neo_nes<span class="sc">$</span>es),</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>p1<span class="sc">/</span>p2</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-39-1.svg" width="2400" /></p>
<p>With this new neoantigen prediction tool, we still see a trends of immunoediting signal (ESCCF=-0.017, P=0.015). Similarly a significant ESRNA signal can also been detected (ES=-0.029, P&lt;0.005). This data further demonstrate the original conclusion of this study.</p>
</div>
</div>
<div id="immune-escape-analysis" class="section level2">
<h2>Immune escape analysis</h2>
<p>We consider the following immune escape mechanisms:</p>
<ol style="list-style-type: decimal">
<li>Suppress the transcription of genome alterations encoding high antigenicity (quantified as ESRNA);</li>
<li>Antigen presentation pathway gene alterations;</li>
<li>PD-L1 or CTLA-4 overexpression.</li>
<li>HLA LOH</li>
</ol>
<p>Antigen presentation pathway genes were selected based on the list of antigen processing and presentation machinery (APM) from the Gene Ontology Consortium (<a href="GO:0002474" class="uri">GO:0002474</a>). Gene level non-silent mutation file was downloaded from UCSC Xena. If one sample has non-silent mutations in APM genes, then this sample was labled as escape by APM mutation.</p>
<p>Immune checkpoint gene overexpression was assessed using RNA-seq data. Normal expression values (in transcripts per million mapped reads (TPM)) of PD-L1 and CTLA-4 were established from the TCGA based on RNA-seq expression of the two proteins in normal samples. Checkpoint overexpression was called if either PD-L1 or CTLA-4 expression in the tumor was higher than the mean plus two standard deviations of normal expression.</p>
<p>The HLA LOH status data was obtained from Xiangyong Li et al. If at least one HLA allele is subject to loss by LOHHLA, then the sample is labled as HLA LOH.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="do">####apm</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>apm_gene <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/ap_pathway.rds&quot;</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>non_slient_mutation <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;../data/mc3.v0.2.8.PUBLIC.nonsilentGene.xena&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>apm_gene <span class="ot">&lt;-</span> apm_gene<span class="sc">$</span>V1</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(<span class="sc">!</span>(apm_gene <span class="sc">%in%</span> non_slient_mutation<span class="sc">$</span>sample))</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>non_slient_mutation <span class="ot">&lt;-</span> non_slient_mutation <span class="sc">%&gt;%</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sample <span class="sc">%in%</span> apm_gene) </span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>check <span class="ot">&lt;-</span> <span class="fu">apply</span>(non_slient_mutation[,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(non_slient_mutation)],<span class="dv">2</span>,<span class="cf">function</span>(x){<span class="fu">any</span>(x<span class="sc">==</span><span class="dv">1</span>)}) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(check) <span class="ot">&lt;-</span> <span class="st">&quot;apm_mut&quot;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>check<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(check)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(check,<span class="at">file =</span> <span class="st">&quot;../data/apm_mut_sample.rds&quot;</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="do">###checkpoint over expression CD274 CTLA-4</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>tpm_gene <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/tpm_trans.rds&quot;</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>CD274 <span class="ot">&lt;-</span> tpm_gene <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene <span class="sc">==</span> <span class="st">&quot;CD274&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(tpm_gene))) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>CD274<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(CD274)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CD274)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;PDL1&quot;</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>CTLA4 <span class="ot">&lt;-</span> tpm_gene <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene <span class="sc">==</span> <span class="st">&quot;CTLA4&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(tpm_gene))) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>CTLA4<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(CTLA4)</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CTLA4)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;CTLA4&quot;</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>check_point <span class="ot">&lt;-</span> <span class="fu">left_join</span>(CD274,CTLA4,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(check_point,<span class="at">file =</span> <span class="st">&quot;../data/checkpoint_exp.rds&quot;</span>)</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">substr</span>(check_point<span class="sc">$</span>sample,<span class="dv">14</span>,<span class="dv">15</span>))</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>normal <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">colnames</span>(tpm_gene)[<span class="fu">which</span>(<span class="fu">substr</span>(<span class="fu">colnames</span>(tpm_gene),<span class="dv">14</span>,<span class="dv">15</span>)<span class="sc">==</span><span class="dv">11</span>)])</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>normal <span class="ot">&lt;-</span> <span class="fu">left_join</span>(normal,check_point,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>normal<span class="sc">$</span>cancer <span class="ot">&lt;-</span> EasyBioinfo<span class="sc">::</span><span class="fu">get_cancer_type</span>(normal<span class="sc">$</span>sample)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>normal <span class="sc">%&gt;%</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_pdl1 =</span> <span class="fu">mean</span>(PDL1),</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_pdl1 =</span> <span class="fu">sd</span>(PDL1),</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_ctla4 =</span> <span class="fu">mean</span>(CTLA4),</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_ctla4 =</span> <span class="fu">sd</span>(CTLA4)) <span class="ot">-&gt;</span> mean_sd</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>cancer <span class="ot">&lt;-</span> check_point <span class="sc">%&gt;%</span> </span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.numeric</span>(<span class="fu">substr</span>(sample,<span class="dv">14</span>,<span class="dv">15</span>)) <span class="sc">&lt;</span> <span class="dv">11</span>)</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>cancer<span class="sc">$</span>cancer <span class="ot">&lt;-</span> EasyBioinfo<span class="sc">::</span><span class="fu">get_cancer_type</span>(cancer<span class="sc">$</span>sample)</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>cancer <span class="ot">&lt;-</span> <span class="fu">left_join</span>(cancer,mean_sd,<span class="at">by=</span><span class="st">&quot;cancer&quot;</span>)</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>cancer <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(cancer)</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>cancer <span class="ot">&lt;-</span> cancer <span class="sc">%&gt;%</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PDL1_over =</span> <span class="fu">ifelse</span>(PDL1 <span class="sc">&gt;</span> (mean_pdl1<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>sd_pdl1),<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>),</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">CTLA4_over =</span> <span class="fu">ifelse</span>(CTLA4 <span class="sc">&gt;</span> (mean_ctla4<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>sd_ctla4),<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) </span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(cancer,<span class="at">file =</span> <span class="st">&quot;../data/checkpoint_over.rds&quot;</span>)</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>loh <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">&quot;../data/TCGA_HLA_benchmark_20200810.xlsx&quot;</span>,<span class="at">sheet =</span> <span class="dv">2</span>)</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>loh <span class="ot">&lt;-</span> loh <span class="sc">%&gt;%</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(LOH_cal <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LOH_status =</span> <span class="fu">ifelse</span>(<span class="fu">nchar</span>(LossAllele)<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;no&quot;</span>,<span class="st">&quot;yes&quot;</span>))</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(loh<span class="sc">$</span>LOH_status)</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>loh <span class="ot">&lt;-</span> loh <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sample_Barcode,LOH_status)</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(loh,<span class="at">file =</span> <span class="st">&quot;../data/HLA_loh.rds&quot;</span>)</span></code></pre></div>
<p>We can show the percentage of samples that have differnet escape mechanisms in each cancer type:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>nes_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>checkpoint_over <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/checkpoint_over.rds&quot;</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>apm_mut_sample <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/apm_mut_sample.rds&quot;</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>LOH <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/HLA_loh.rds&quot;</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>apm_mut_sample <span class="ot">&lt;-</span> apm_mut_sample <span class="sc">%&gt;%</span> </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">12</span>))</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>checkpoint_over <span class="ot">&lt;-</span> checkpoint_over <span class="sc">%&gt;%</span> </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">12</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">over_exp=</span><span class="fu">ifelse</span>(PDL1_over <span class="sc">==</span> <span class="st">&quot;yes&quot;</span> <span class="sc">|</span> CTLA4_over <span class="sc">==</span> <span class="st">&quot;yes&quot;</span> ,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,cancer,over_exp) <span class="sc">%&gt;%</span> </span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct_all</span>(<span class="at">.keep_all =</span> T)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>checkpoint_over <span class="ot">&lt;-</span> checkpoint_over[<span class="sc">!</span><span class="fu">duplicated</span>(checkpoint_over<span class="sc">$</span>sample),]</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> nes_exp <span class="sc">%&gt;%</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">12</span>))</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>LOH <span class="ot">&lt;-</span> LOH <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">sample=</span>Sample_Barcode)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>all_escape <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(left_join,<span class="fu">list</span>(apm_mut_sample,checkpoint_over,nes_exp,LOH))</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>all_escape <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(all_escape)</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>all_escape <span class="ot">&lt;-</span> all_escape <span class="sc">%&gt;%</span> </span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_down=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value<span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_escape,<span class="at">file =</span> <span class="st">&quot;../data/escape_all.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>all_escape <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/escape_all.rds&quot;</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> all_escape <span class="sc">%&gt;%</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">`</span><span class="at">APM mutation</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(apm_mut <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Checkpoint over-expression</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(over_exp<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Rna downregulation</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(es_down<span class="sc">==</span><span class="st">&quot;yes&quot;</span>),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">LOH</span><span class="st">`</span><span class="ot">=</span><span class="fu">mean</span>(LOH_status<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dt) <span class="ot">&lt;-</span> dt<span class="sc">$</span>cancer</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>cancer)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(circlize)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ========================================</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; circlize version 0.4.14</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; CRAN page: https://cran.r-project.org/package=circlize</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Github page: https://github.com/jokergoo/circlize</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Documentation: https://jokergoo.github.io/circlize_book/book/</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; If you use it in published research, please cite:</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Gu, Z. circlize implements and enhances circular visualization</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   in R. Bioinformatics 2014.</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; This message can be suppressed by:</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   suppressPackageStartupMessages(library(circlize))</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ========================================</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>col_fun <span class="ot">=</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>,<span class="dv">100</span>), <span class="fu">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="fu">Heatmap</span>(dt, <span class="at">name =</span> <span class="st">&quot;Sample proportion (%)&quot;</span>,</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>          <span class="fu">grid.text</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, dt[i, j]), x, y, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>        },<span class="at">cluster_rows =</span> F,<span class="at">cluster_columns =</span> F)</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: The input is a data frame, convert it to a matrix.</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-42-1.svg" width="2400" /></p>
<p>Then we can compare the ESccf between escape samples and no escape samples:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>checkpoint_over <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/checkpoint_over.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(PDL1_over<span class="sc">==</span><span class="st">&quot;yes&quot;</span> <span class="sc">|</span> CTLA4_over<span class="sc">==</span><span class="st">&quot;yes&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>checkpoint_over_escape <span class="ot">&lt;-</span> checkpoint_over <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>apm_mut_sample <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/apm_mut_sample.rds&quot;</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>apm_mut_escape <span class="ot">&lt;-</span> apm_mut_sample <span class="sc">%&gt;%</span> <span class="fu">filter</span>(apm_mut)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>LOH <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/HLA_loh.rds&quot;</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>LOH_escape <span class="ot">&lt;-</span> LOH <span class="sc">%&gt;%</span> <span class="fu">filter</span>(LOH_status<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>es_escape <span class="ot">&lt;-</span> nes_exp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value<span class="sc">&lt;</span><span class="fl">0.05</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>escape_samples <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(union,<span class="fu">list</span>(<span class="fu">substr</span>(checkpoint_over_escape<span class="sc">$</span>sample,<span class="dv">1</span>,<span class="dv">12</span>),</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">substr</span>(apm_mut_escape<span class="sc">$</span>sample,<span class="dv">1</span>,<span class="dv">12</span>),</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">substr</span>(LOH_escape<span class="sc">$</span>Sample_Barcode,<span class="dv">1</span>,<span class="dv">12</span>),</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">substr</span>(es_escape<span class="sc">$</span>sample,<span class="dv">1</span>,<span class="dv">12</span>)))</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>es_ccf <span class="ot">&lt;-</span> nes_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">escape=</span><span class="fu">ifelse</span>(<span class="fu">substr</span>(sample,<span class="dv">1</span>,<span class="dv">12</span>) <span class="sc">%in%</span> escape_samples,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(es_ccf<span class="sc">$</span>escape)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   no  yes </span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1704 3591</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>es_ccf<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(es_ccf<span class="sc">$</span>sample)</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>escape <span class="ot">&lt;-</span> es_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(escape<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>no_escape <span class="ot">&lt;-</span> es_ccf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(escape<span class="sc">==</span><span class="st">&quot;no&quot;</span>)</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>es_ccf,<span class="fu">aes</span>(<span class="at">x=</span>escape,<span class="at">y=</span>es))<span class="sc">+</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-43-1.svg" width="2400" /></p>
<p>We can get the simulation p value for pancancer and cancer types as previously described:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>sim_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/sim_2000_not_filter_all_ccf.rds&quot;</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>sim_escape <span class="ot">&lt;-</span> sim_all <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> escape<span class="sc">$</span>sample)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>sim_no_escape <span class="ot">&lt;-</span> sim_all <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> no_escape<span class="sc">$</span>sample)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>sim_escape <span class="sc">%&gt;%</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ1</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>escape_summ <span class="ot">&lt;-</span> escape <span class="sc">%&gt;%</span> </span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>sim_escape <span class="sc">%&gt;%</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ2</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ2, </span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(escape<span class="sc">$</span>es),</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;Density&quot;</span>)</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-44-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>noescape_summ <span class="ot">&lt;-</span> no_escape <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es))</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>sim_no_escape <span class="sc">%&gt;%</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ3</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> WVPlots<span class="sc">::</span><span class="fu">ShadedDensity</span>(<span class="at">frame =</span> summ3, </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">xvar =</span> <span class="st">&quot;median_es&quot;</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">threshold =</span> <span class="fu">median</span>(no_escape<span class="sc">$</span>es),</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">tail =</span> <span class="st">&quot;left&quot;</span>)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">1</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">2</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>fill <span class="ot">&lt;-</span> <span class="st">&quot;blue&quot;</span>     <span class="co">#geom_ribbon</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>colour <span class="ot">&lt;-</span> <span class="st">&quot;black&quot;</span> </span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>layers[[<span class="dv">3</span>]]<span class="sc">$</span>aes_params<span class="sc">$</span>size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Simulation median es&quot;</span>)<span class="sc">+</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;Density&quot;</span>)</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>p2</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-44-2.svg" width="2400" /></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>sim_no_escape <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cancer,sim_num) <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_es=</span><span class="fu">median</span>(es)) <span class="ot">-&gt;</span> summ4</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `summarise()` has grouped output by &#39;cancer&#39;. You can override using the</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `.groups` argument.</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>noescape_summ <span class="ot">&lt;-</span> noescape_summ <span class="sc">%&gt;%</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p=</span><span class="fu">mean</span>(summ4<span class="sc">$</span>median_es[summ4<span class="sc">$</span>cancer<span class="sc">==</span>cancer] <span class="sc">&lt;=</span> median_es))</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>escape_summ <span class="ot">&lt;-</span> escape_summ <span class="sc">%&gt;%</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p=</span><span class="fu">mean</span>(summ1<span class="sc">$</span>median_es[summ1<span class="sc">$</span>cancer<span class="sc">==</span>cancer] <span class="sc">&lt;=</span> median_es))</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>escape <span class="ot">&lt;-</span> escape <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>p)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>no_escape <span class="ot">&lt;-</span> no_escape <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>p)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">get_f1</span>(escape,<span class="at">pancancer_p =</span> <span class="fl">0.13</span>,<span class="at">dt2 =</span> escape_summ,<span class="at">median_es =</span> <span class="fu">median</span>(escape<span class="sc">$</span>es))</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>p3</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-44-3.svg" width="2400" /></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">get_f1</span>(no_escape,<span class="at">pancancer_p =</span> <span class="fl">0.034</span>,<span class="at">dt2 =</span> noescape_summ,<span class="at">median_es =</span> <span class="fu">median</span>(no_escape<span class="sc">$</span>es))</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;cancer&quot;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>p4</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-44-4.svg" width="2400" /></p>
<p>The result shows that immune elimination signal can be detected in samples without escape signal, while in samples with immunoediting escape mechanisms this signal is much weaker. ESCCF values of patients without immune escape mechanisms are significantly lower than patients with immune escape mechanisms. This data is consistent with our previous observation that there is anti-correlation between immunoediting elimination and escape signal.</p>
</div>
<div id="ccf-distribution-analysis" class="section level2">
<h2>CCF distribution analysis</h2>
<p>As our method is relied on the distribution of CCF, we can show the CCF distribution of pancancer and all cancer types, plotting as well the CCF of neoantigen and non-neoantigens:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/all_mut_ccf_tpm.rds&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>all_mut_ccf <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ccf=</span>ccf_hat) <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">neo=</span><span class="fu">ifelse</span>(neo<span class="sc">==</span><span class="st">&quot;neo&quot;</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>es <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>neo_missense <span class="ot">&lt;-</span> all_mut_ccf <span class="sc">%&gt;%</span> </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> es<span class="sc">$</span>sample) <span class="sc">%&gt;%</span> </span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,neo,ccf) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ccf))</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>neo_missense<span class="sc">$</span>cancer <span class="ot">&lt;-</span> <span class="fu">get_cancer_type</span>(neo_missense<span class="sc">$</span>sample)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> neo_missense,<span class="fu">aes</span>(<span class="at">x=</span>ccf,..scaled..,<span class="at">color=</span>neo))<span class="sc">+</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;Density&quot;</span>,<span class="at">x=</span><span class="st">&quot;CCF&quot;</span>)<span class="sc">+</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> cancer)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-45-1.svg" width="2400" /></p>
<p>It is apparent that in many cancer types there are clear shift of CCF curves of neoantigenic mutations compared with non-neoantigenic mutations, and this difference highlight the immunoediting elimination signal quantified in this study.</p>
</div>
<div id="other-immune-cell-infiltration-quantification-methods" class="section level2">
<h2>Other immune cell infiltration quantification methods</h2>
<p>Comparisons between TCGA cancer patients with detectable immunoediting-elimination or escape signal (ES&lt;0, P&lt;0.05) and the remaining patients in infiltration status quantified by using CD8 T cells puls NK cells, the ratio CD8/Treg and NK/Treg cells. We use two other methods: cibersort and quantiseq:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>es_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/es_exp_filter_driver.rds&quot;</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>es_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/neo_nes_ccf06_1_remove_driver_samples_addp.rds&quot;</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>pancancer_subtcells <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/pancancer_subtcells.rds&quot;</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>exp_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  es_exp,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  pancancer_subtcells</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">escape=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>(.)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>ccf_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  es_ccf,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  pancancer_subtcells</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>(.)</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span><span class="fu">exp</span>(CD8_T)<span class="sc">/</span><span class="fu">exp</span>(iTreg<span class="sc">+</span>nTreg)))<span class="sc">+</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8_T / Treg&quot;</span>)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span><span class="fu">exp</span>(NK)<span class="sc">/</span><span class="fu">exp</span>(iTreg<span class="sc">+</span>nTreg)))<span class="sc">+</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span><span class="st">&quot;NK / Treg&quot;</span>)</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>escape,<span class="at">y=</span><span class="fu">exp</span>(CD8_T)<span class="sc">/</span><span class="fu">exp</span>(iTreg<span class="sc">+</span>nTreg)))<span class="sc">+</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8_T / Treg&quot;</span>)</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>escape,<span class="at">y=</span><span class="fu">exp</span>(NK)<span class="sc">/</span><span class="fu">exp</span>(iTreg<span class="sc">+</span>nTreg)))<span class="sc">+</span></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span><span class="st">&quot;NK / Treg&quot;</span>)</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span>p2)<span class="sc">/</span>(p3<span class="sc">+</span>p4)</span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-46-1.svg" width="2400" /></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>immune <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;../data/infiltration_estimation_for_tcga.csv&quot;</span>,<span class="at">check.names =</span> F,<span class="at">data.table =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample=</span>cell_type)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>cibersort <span class="ot">&lt;-</span> immune <span class="sc">%&gt;%</span> </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,<span class="fu">ends_with</span>(<span class="st">&quot;CIBERSORT-ABS&quot;</span>))</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(immune)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;sample&quot;                                        </span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [2] &quot;B cell_TIMER&quot;                                  </span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [3] &quot;T cell CD4+_TIMER&quot;                             </span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;T cell CD8+_TIMER&quot;                             </span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;Neutrophil_TIMER&quot;                              </span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [6] &quot;Macrophage_TIMER&quot;                              </span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;Myeloid dendritic cell_TIMER&quot;                  </span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [8] &quot;B cell naive_CIBERSORT&quot;                        </span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;B cell memory_CIBERSORT&quot;                       </span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] &quot;B cell plasma_CIBERSORT&quot;                       </span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [11] &quot;T cell CD8+_CIBERSORT&quot;                         </span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [12] &quot;T cell CD4+ naive_CIBERSORT&quot;                   </span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] &quot;T cell CD4+ memory resting_CIBERSORT&quot;          </span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [14] &quot;T cell CD4+ memory activated_CIBERSORT&quot;        </span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [15] &quot;T cell follicular helper_CIBERSORT&quot;            </span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [16] &quot;T cell regulatory (Tregs)_CIBERSORT&quot;           </span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] &quot;T cell gamma delta_CIBERSORT&quot;                  </span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [18] &quot;NK cell resting_CIBERSORT&quot;                     </span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [19] &quot;NK cell activated_CIBERSORT&quot;                   </span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [20] &quot;Monocyte_CIBERSORT&quot;                            </span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [21] &quot;Macrophage M0_CIBERSORT&quot;                       </span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [22] &quot;Macrophage M1_CIBERSORT&quot;                       </span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [23] &quot;Macrophage M2_CIBERSORT&quot;                       </span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [24] &quot;Myeloid dendritic cell resting_CIBERSORT&quot;      </span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] &quot;Myeloid dendritic cell activated_CIBERSORT&quot;    </span></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [26] &quot;Mast cell activated_CIBERSORT&quot;                 </span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [27] &quot;Mast cell resting_CIBERSORT&quot;                   </span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [28] &quot;Eosinophil_CIBERSORT&quot;                          </span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [29] &quot;Neutrophil_CIBERSORT&quot;                          </span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [30] &quot;B cell naive_CIBERSORT-ABS&quot;                    </span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [31] &quot;B cell memory_CIBERSORT-ABS&quot;                   </span></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [32] &quot;B cell plasma_CIBERSORT-ABS&quot;                   </span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [33] &quot;T cell CD8+_CIBERSORT-ABS&quot;                     </span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [34] &quot;T cell CD4+ naive_CIBERSORT-ABS&quot;               </span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [35] &quot;T cell CD4+ memory resting_CIBERSORT-ABS&quot;      </span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [36] &quot;T cell CD4+ memory activated_CIBERSORT-ABS&quot;    </span></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [37] &quot;T cell follicular helper_CIBERSORT-ABS&quot;        </span></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [38] &quot;T cell regulatory (Tregs)_CIBERSORT-ABS&quot;       </span></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [39] &quot;T cell gamma delta_CIBERSORT-ABS&quot;              </span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [40] &quot;NK cell resting_CIBERSORT-ABS&quot;                 </span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [41] &quot;NK cell activated_CIBERSORT-ABS&quot;               </span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [42] &quot;Monocyte_CIBERSORT-ABS&quot;                        </span></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [43] &quot;Macrophage M0_CIBERSORT-ABS&quot;                   </span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [44] &quot;Macrophage M1_CIBERSORT-ABS&quot;                   </span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [45] &quot;Macrophage M2_CIBERSORT-ABS&quot;                   </span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [46] &quot;Myeloid dendritic cell resting_CIBERSORT-ABS&quot;  </span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [47] &quot;Myeloid dendritic cell activated_CIBERSORT-ABS&quot;</span></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [48] &quot;Mast cell activated_CIBERSORT-ABS&quot;             </span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [49] &quot;Mast cell resting_CIBERSORT-ABS&quot;               </span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [50] &quot;Eosinophil_CIBERSORT-ABS&quot;                      </span></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [51] &quot;Neutrophil_CIBERSORT-ABS&quot;                      </span></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [52] &quot;B cell_QUANTISEQ&quot;                              </span></span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [53] &quot;Macrophage M1_QUANTISEQ&quot;                       </span></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [54] &quot;Macrophage M2_QUANTISEQ&quot;                       </span></span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [55] &quot;Monocyte_QUANTISEQ&quot;                            </span></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [56] &quot;Neutrophil_QUANTISEQ&quot;                          </span></span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [57] &quot;NK cell_QUANTISEQ&quot;                             </span></span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [58] &quot;T cell CD4+ (non-regulatory)_QUANTISEQ&quot;        </span></span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [59] &quot;T cell CD8+_QUANTISEQ&quot;                         </span></span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [60] &quot;T cell regulatory (Tregs)_QUANTISEQ&quot;           </span></span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [61] &quot;Myeloid dendritic cell_QUANTISEQ&quot;              </span></span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [62] &quot;uncharacterized cell_QUANTISEQ&quot;                </span></span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [63] &quot;T cell_MCPCOUNTER&quot;                             </span></span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [64] &quot;T cell CD8+_MCPCOUNTER&quot;                        </span></span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [65] &quot;cytotoxicity score_MCPCOUNTER&quot;                 </span></span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [66] &quot;NK cell_MCPCOUNTER&quot;                            </span></span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [67] &quot;B cell_MCPCOUNTER&quot;                             </span></span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [68] &quot;Monocyte_MCPCOUNTER&quot;                           </span></span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [69] &quot;Macrophage/Monocyte_MCPCOUNTER&quot;                </span></span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [70] &quot;Myeloid dendritic cell_MCPCOUNTER&quot;             </span></span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [71] &quot;Neutrophil_MCPCOUNTER&quot;                         </span></span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [72] &quot;Endothelial cell_MCPCOUNTER&quot;                   </span></span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [73] &quot;Cancer associated fibroblast_MCPCOUNTER&quot;       </span></span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [74] &quot;Myeloid dendritic cell activated_XCELL&quot;        </span></span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [75] &quot;B cell_XCELL&quot;                                  </span></span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [ reached getOption(&quot;max.print&quot;) -- omitted 45 entries ]</span></span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>get_immune_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(ccf_es_dt,exp_es_dt,immune_dt,sample_len,cd8_nk_names,treg_names){</span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a>  ccf_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a>    ccf_es_dt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,sample_len)),</span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a>    immune_dt</span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>  exp_immune <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a>    exp_es_dt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">substr</span>(sample,<span class="dv">1</span>,sample_len)),</span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a>    immune_dt</span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">es_type=</span><span class="fu">ifelse</span>(es<span class="sc">&lt;</span><span class="dv">0</span> <span class="sc">&amp;</span> p_value <span class="sc">&lt;</span><span class="fl">0.05</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_NK))<span class="sc">+</span></span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-100"><a href="#cb73-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span>cd8_nk_names)</span>
<span id="cb73-101"><a href="#cb73-101" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>Treg))<span class="sc">+</span></span>
<span id="cb73-102"><a href="#cb73-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-103"><a href="#cb73-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-104"><a href="#cb73-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-105"><a href="#cb73-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span>treg_names)</span>
<span id="cb73-106"><a href="#cb73-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-107"><a href="#cb73-107" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_NK))<span class="sc">+</span></span>
<span id="cb73-108"><a href="#cb73-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-109"><a href="#cb73-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-110"><a href="#cb73-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-111"><a href="#cb73-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span>cd8_nk_names)</span>
<span id="cb73-112"><a href="#cb73-112" aria-hidden="true" tabindex="-1"></a>  p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>Treg))<span class="sc">+</span></span>
<span id="cb73-113"><a href="#cb73-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-114"><a href="#cb73-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-115"><a href="#cb73-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-116"><a href="#cb73-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span>treg_names)</span>
<span id="cb73-117"><a href="#cb73-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-118"><a href="#cb73-118" aria-hidden="true" tabindex="-1"></a>  p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>ccf_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_treg))<span class="sc">+</span></span>
<span id="cb73-119"><a href="#cb73-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-120"><a href="#cb73-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-121"><a href="#cb73-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-122"><a href="#cb73-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Elimination&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8/Treg&quot;</span>)</span>
<span id="cb73-123"><a href="#cb73-123" aria-hidden="true" tabindex="-1"></a>  p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>exp_immune,<span class="fu">aes</span>(<span class="at">x=</span>es_type,<span class="at">y=</span>CD8_treg))<span class="sc">+</span></span>
<span id="cb73-124"><a href="#cb73-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()<span class="sc">+</span></span>
<span id="cb73-125"><a href="#cb73-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_compare_means</span>()<span class="sc">+</span></span>
<span id="cb73-126"><a href="#cb73-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_prism</span>()<span class="sc">+</span></span>
<span id="cb73-127"><a href="#cb73-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Escape&quot;</span>,<span class="at">y=</span><span class="st">&quot;CD8/Treg&quot;</span>)</span>
<span id="cb73-128"><a href="#cb73-128" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">list</span>(p1,p2,p3,p4,p5,p6)</span>
<span id="cb73-129"><a href="#cb73-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb73-130"><a href="#cb73-130" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-131"><a href="#cb73-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-132"><a href="#cb73-132" aria-hidden="true" tabindex="-1"></a>cibersort <span class="ot">&lt;-</span> cibersort <span class="sc">%&gt;%</span> </span>
<span id="cb73-133"><a href="#cb73-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CD8_NK=</span><span class="st">`</span><span class="at">T cell CD8+_CIBERSORT-ABS</span><span class="st">`</span><span class="sc">+</span><span class="st">`</span><span class="at">NK cell activated_CIBERSORT-ABS</span><span class="st">`</span>,</span>
<span id="cb73-134"><a href="#cb73-134" aria-hidden="true" tabindex="-1"></a>         <span class="at">Treg=</span><span class="st">`</span><span class="at">T cell regulatory (Tregs)_CIBERSORT-ABS</span><span class="st">`</span>,</span>
<span id="cb73-135"><a href="#cb73-135" aria-hidden="true" tabindex="-1"></a>         <span class="at">CD8_treg=</span><span class="fu">exp</span>(<span class="st">`</span><span class="at">T cell CD8+_CIBERSORT-ABS</span><span class="st">`</span>)<span class="sc">/</span><span class="fu">exp</span>(<span class="st">`</span><span class="at">T cell regulatory (Tregs)_CIBERSORT-ABS</span><span class="st">`</span>))</span>
<span id="cb73-136"><a href="#cb73-136" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">get_immune_plot</span>(es_ccf,es_exp,cibersort,<span class="at">sample_len =</span> <span class="dv">15</span>,<span class="at">cd8_nk_names =</span> <span class="st">&quot;CD8 T + NK&quot;</span>,<span class="at">treg_names =</span> <span class="st">&quot;Treg&quot;</span>)</span>
<span id="cb73-137"><a href="#cb73-137" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb73-138"><a href="#cb73-138" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb73-139"><a href="#cb73-139" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]] <span class="sc">+</span> res[[<span class="dv">2</span>]] <span class="sc">+</span> res[[<span class="dv">3</span>]] <span class="sc">+</span> res[[<span class="dv">4</span>]] <span class="sc">+</span> res[[<span class="dv">5</span>]] <span class="sc">+</span> res[[<span class="dv">6</span>]] <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>,<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb73-140"><a href="#cb73-140" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-141"><a href="#cb73-141" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb73-142"><a href="#cb73-142" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-143"><a href="#cb73-143" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb73-144"><a href="#cb73-144" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-145"><a href="#cb73-145" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb73-146"><a href="#cb73-146" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-147"><a href="#cb73-147" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb73-148"><a href="#cb73-148" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-149"><a href="#cb73-149" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb73-150"><a href="#cb73-150" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb73-151"><a href="#cb73-151" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-46-2.svg" width="2400" /></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>quantiseq <span class="ot">&lt;-</span> immune <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,<span class="fu">ends_with</span>(<span class="st">&quot;QUANTISEQ&quot;</span>))</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(quantiseq)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;sample&quot;                                </span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [2] &quot;B cell_QUANTISEQ&quot;                      </span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [3] &quot;Macrophage M1_QUANTISEQ&quot;               </span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;Macrophage M2_QUANTISEQ&quot;               </span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;Monocyte_QUANTISEQ&quot;                    </span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [6] &quot;Neutrophil_QUANTISEQ&quot;                  </span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;NK cell_QUANTISEQ&quot;                     </span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [8] &quot;T cell CD4+ (non-regulatory)_QUANTISEQ&quot;</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;T cell CD8+_QUANTISEQ&quot;                 </span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] &quot;T cell regulatory (Tregs)_QUANTISEQ&quot;   </span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [11] &quot;Myeloid dendritic cell_QUANTISEQ&quot;      </span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [12] &quot;uncharacterized cell_QUANTISEQ&quot;</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>quantiseq <span class="ot">&lt;-</span> quantiseq <span class="sc">%&gt;%</span> </span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CD8_NK=</span><span class="st">`</span><span class="at">T cell CD8+_QUANTISEQ</span><span class="st">`</span><span class="sc">+</span><span class="st">`</span><span class="at">NK cell_QUANTISEQ</span><span class="st">`</span>,</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">Treg=</span><span class="st">`</span><span class="at">T cell regulatory (Tregs)_QUANTISEQ</span><span class="st">`</span>,</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">CD8_treg=</span><span class="fu">exp</span>(<span class="st">`</span><span class="at">T cell CD8+_QUANTISEQ</span><span class="st">`</span>)<span class="sc">/</span><span class="fu">exp</span>(<span class="st">`</span><span class="at">T cell regulatory (Tregs)_QUANTISEQ</span><span class="st">`</span>))</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">get_immune_plot</span>(es_ccf,es_exp,quantiseq,<span class="at">sample_len =</span> <span class="dv">15</span>,<span class="at">cd8_nk_names =</span> <span class="st">&quot;CD8 T + NK&quot;</span>,<span class="at">treg_names =</span> <span class="st">&quot;Treg&quot;</span>)</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Joining, by = &quot;sample&quot;</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]] <span class="sc">+</span> res[[<span class="dv">2</span>]] <span class="sc">+</span> res[[<span class="dv">3</span>]] <span class="sc">+</span> res[[<span class="dv">4</span>]] <span class="sc">+</span> res[[<span class="dv">5</span>]] <span class="sc">+</span> res[[<span class="dv">6</span>]] <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>,<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 65 rows containing non-finite values (stat_compare_means).</span></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_boxplot).</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning: Removed 88 rows containing non-finite values (stat_compare_means).</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-46-3.svg" width="2400" /></p>
</div>
<div id="comparison-with-other-biomarkers-of-ici" class="section level2">
<h2>Comparison with other biomarkers of ICI</h2>
<p>The performance of ESCCF has been compared with 15 biomarkers reported to have significant association with immune checkpoint inhibitor (ICI) response, including tumor mutation burden (TMB), clonal TMB, indel mutation burden, burden of indels escaping nonsense mediated decay (NMD), SERPINB3 mutations, CD274 (PD-L1) expression, CD38 expression, CD8A expression, CXCL13 expression, CXCL9 expression, T cell inflamed gene expression signature, IMPRES, CD8 T effector from the POPLAR trial, cytolytic score, and UV signature. The detail of calculation of these biomarkers can refer to the methods part of our manuscript or corresponding reference:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">####Indel mutation</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>liu_indel <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;data/Immunotherapy/liu_indel_counts&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>liu_indel <span class="ot">&lt;-</span> liu_indel <span class="sc">%&gt;%</span> </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">gsub</span>(<span class="st">&quot;_pass.vcf&quot;</span>,<span class="st">&quot;&quot;</span>,V1)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">paste0</span>(<span class="st">&quot;liu_&quot;</span>,sample)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indel_counts=</span>V2<span class="sc">+</span>V3) <span class="sc">%&gt;%</span> </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,indel_counts)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>nadeem_indel <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;data/Immunotherapy/nadeem_indel_counts&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>nadeem_indel <span class="ot">&lt;-</span> nadeem_indel <span class="sc">%&gt;%</span> </span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">gsub</span>(<span class="st">&quot;_pass.vcf&quot;</span>,<span class="st">&quot;&quot;</span>,V1)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">paste0</span>(<span class="st">&quot;nadeem_&quot;</span>,sample)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indel_counts=</span>V2<span class="sc">+</span>V3) <span class="sc">%&gt;%</span> </span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,indel_counts)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>willy_indel <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;data/Immunotherapy/willy_hugo_indel_counts&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>willy_indel <span class="ot">&lt;-</span> willy_indel <span class="sc">%&gt;%</span> </span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">gsub</span>(<span class="st">&quot;_pass.vcf&quot;</span>,<span class="st">&quot;&quot;</span>,V1)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample=</span><span class="fu">paste0</span>(<span class="st">&quot;willy_&quot;</span>,sample)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indel_counts=</span>V2<span class="sc">+</span>V3) <span class="sc">%&gt;%</span> </span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,indel_counts)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>all_indel <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(liu_indel,nadeem_indel,willy_indel)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_indel,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_indel_counts.rds&quot;</span>)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="do">##NMD-escape indel TMB</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/nes_immunetherapy.rds&quot;</span>)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>gtf <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/tmp/hg38_NMDetectiveA_Lindeboom_et_al.v2.gtf&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>gtf <span class="ot">&lt;-</span> gtf <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">start=</span>V4,<span class="at">end=</span>V5)</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>gtf <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">setDT</span>(gtf)</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">setkey</span>(gtf, V1,start, end)</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>neo_nes<span class="sc">$</span>escape_nmd_indels <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(neo_nes)){</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;_.+&quot;</span>,<span class="st">&quot;&quot;</span>,neo_nes<span class="sc">$</span>sample[i]) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(.)</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>  pt <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;.+_&quot;</span>,<span class="st">&quot;&quot;</span>,neo_nes<span class="sc">$</span>sample[i])</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>  t_s <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;~/immune_thearpy/&quot;</span>,cohort,<span class="st">&quot;_indel/&quot;</span>,pt),<span class="at">data.table =</span> F,<span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>  t_s <span class="ot">&lt;-</span> t_s <span class="sc">%&gt;%</span> </span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(<span class="fu">nchar</span>(V6)<span class="sc">&lt;</span><span class="fu">nchar</span>(V7),<span class="st">&quot;In&quot;</span>,<span class="st">&quot;Del&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">start=</span>V2<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>           <span class="at">end=</span><span class="fu">ifelse</span>(type<span class="sc">==</span><span class="st">&quot;Del&quot;</span>,V3<span class="sc">+</span><span class="dv">1</span>,V2<span class="sc">+</span><span class="dv">1</span><span class="sc">+</span>(<span class="fu">nchar</span>(V7)<span class="sc">-</span><span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(V1,start,end)</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>  t_s <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">setDT</span>(t_s)</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">foverlaps</span>(t_s, gtf, <span class="at">type=</span><span class="st">&quot;any&quot;</span>) <span class="ot">-&gt;</span> a</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>  a<span class="sc">$</span>is_nmd <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(a)){</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(a<span class="sc">$</span>V9[j],<span class="at">split =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>    nmd_score <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot; nmd_score &quot;</span>,<span class="st">&quot;&quot;</span>,b[[<span class="dv">1</span>]][<span class="fu">length</span>(b[[<span class="dv">1</span>]])]) <span class="sc">%&gt;%</span> <span class="fu">strsplit</span>(.,<span class="at">split =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>    a<span class="sc">$</span>is_nmd[j] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">sum</span>(nmd_score<span class="sc">&gt;</span><span class="fl">0.52</span>,<span class="at">na.rm =</span> T) <span class="sc">&gt;=</span> <span class="dv">1</span>,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>)</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>  a<span class="sc">$</span>index <span class="ot">&lt;-</span> <span class="fu">paste</span>(a<span class="sc">$</span>V1,a<span class="sc">$</span>i.start,a<span class="sc">$</span>i.end,<span class="at">sep =</span> <span class="st">&quot;:&quot;</span>)</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> a <span class="sc">%&gt;%</span> </span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(index) <span class="sc">%&gt;%</span> </span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">NMD_escape=</span><span class="fu">ifelse</span>(<span class="fu">all</span>(is_nmd<span class="sc">==</span><span class="st">&quot;no&quot;</span>),<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>  neo_nes<span class="sc">$</span>escape_nmd_indels[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(a<span class="sc">$</span>NMD_escape<span class="sc">==</span><span class="st">&quot;yes&quot;</span>)</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/nes_ici_escapeNMD_indel.rds&quot;</span>)</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a><span class="do">###TPM</span></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>RNA_seq_TPM <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/immune_thearpy/TPM/liu/RNA_seq_TPM.rds&quot;</span>)</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(RNA_seq_TPM) <span class="ot">&lt;-</span> RNA_seq_TPM[,<span class="dv">1</span>]</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>RNA_seq_TPM <span class="ot">&lt;-</span> RNA_seq_TPM[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>liu_tpm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(RNA_seq_TPM))</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>liu_tpm<span class="sc">$</span>gene <span class="ot">&lt;-</span> <span class="fu">rownames</span>(liu_tpm)</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(liu_tpm)[<span class="dv">1</span><span class="sc">:</span><span class="dv">121</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;liu_&quot;</span>,<span class="fu">colnames</span>(liu_tpm)[<span class="dv">1</span><span class="sc">:</span><span class="dv">121</span>])</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(liu_tpm,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/liu_tpm.rds&quot;</span>)</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">&quot;~/immune_thearpy/TPM/gencode.v29.annotation.gtf&quot;</span>,<span class="at">data.table =</span> F)</span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> anno <span class="sc">%&gt;%</span> <span class="fu">select</span>(V9) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(V9)</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> anno <span class="sc">%&gt;%</span> </span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_id=</span><span class="fu">strsplit</span>(V9,<span class="at">split =</span> <span class="st">&quot;;&quot;</span>)[[<span class="dv">1</span>]]  <span class="sc">%&gt;%</span>  </span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>           <span class="fu">grep</span>(<span class="st">&quot;gene_id&quot;</span>,.,<span class="at">value =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a>           <span class="fu">strsplit</span>(.,<span class="at">split =</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[[</span><span class="st">`</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[</span><span class="st">`</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">&quot;[.].+&quot;</span>,<span class="st">&quot;&quot;</span>,.))</span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> anno <span class="sc">%&gt;%</span> </span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(gene_id,<span class="at">.keep_all =</span> T)</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> anno <span class="sc">%&gt;%</span> </span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_name=</span><span class="fu">strsplit</span>(V9,<span class="at">split =</span> <span class="st">&quot;;&quot;</span>)[[<span class="dv">1</span>]]  <span class="sc">%&gt;%</span>  </span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a>           <span class="fu">grep</span>(<span class="st">&quot;gene_name&quot;</span>,.,<span class="at">value =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a>           <span class="fu">strsplit</span>(.,<span class="at">split =</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[[</span><span class="st">`</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">[</span><span class="st">`</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">&quot;[.].+&quot;</span>,<span class="st">&quot;&quot;</span>,.))</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>anno <span class="ot">&lt;-</span> anno <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_id,gene_name) <span class="sc">%&gt;%</span> <span class="fu">distinct_all</span>()</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(anno,<span class="at">file =</span> <span class="st">&quot;../tmp/ici_gene_anno.rds&quot;</span>)</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>get_tpm <span class="ot">&lt;-</span> <span class="cf">function</span>(path,cohort){</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> path)</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(path,files[<span class="dv">1</span>]),<span class="at">data.table =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">gene_id=</span>V1,<span class="at">tpm=</span>V2)</span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>    dt,anno</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,tpm) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(gene_name,<span class="at">.keep_all =</span> T)</span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(dt)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(cohort,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;.tsv&quot;</span>,<span class="st">&quot;&quot;</span>,files[<span class="dv">1</span>]))</span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(files)){</span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true" tabindex="-1"></a>    dt1 <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(path,files[i]),<span class="at">data.table =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">gene_id=</span>V1,<span class="at">tpm=</span>V2)</span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true" tabindex="-1"></a>    dt1 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true" tabindex="-1"></a>      dt1,anno</span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,tpm) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(gene_name,<span class="at">.keep_all =</span> T)</span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(dt1)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(cohort,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;.tsv&quot;</span>,<span class="st">&quot;&quot;</span>,files[i]))</span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dt,dt1,<span class="at">by =</span> <span class="st">&quot;gene_name&quot;</span>)</span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#re_tpm &lt;- bind_rows(res)</span></span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt)</span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a>willy_tpm <span class="ot">&lt;-</span> <span class="fu">get_tpm</span>(<span class="st">&quot;~/immune_thearpy/TPM/willy/&quot;</span>,<span class="at">cohort =</span> <span class="st">&quot;willy&quot;</span>)</span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(willy_tpm,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/willy_tpm.rds&quot;</span>)</span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true" tabindex="-1"></a>nadeem_tpm <span class="ot">&lt;-</span> <span class="fu">get_tpm</span>(<span class="st">&quot;~/immune_thearpy/TPM/nadeem/&quot;</span>,<span class="at">cohort =</span> <span class="st">&quot;nadeem&quot;</span>)</span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(nadeem_tpm,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/nadeem_tpm.rds&quot;</span>)</span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a>all_gene <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(intersect,<span class="fu">list</span>(liu_tpm<span class="sc">$</span>gene,willy_tpm<span class="sc">$</span>gene_name,nadeem_tpm<span class="sc">$</span>gene_name))</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a>all_tpm <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a>  liu_tpm <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene <span class="sc">%in%</span> all_gene),</span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a>  willy_tpm <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_name <span class="sc">%in%</span> all_gene) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">gene=</span>gene_name)</span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(.,nadeem_tpm <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_name <span class="sc">%in%</span> all_gene) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">gene=</span>gene_name)) <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene,<span class="fu">everything</span>())</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(all_tpm,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_tpm_ici.rds&quot;</span>)</span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true" tabindex="-1"></a><span class="do">###cal_cyt</span></span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a>all_tpm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_tpm_ici.rds&quot;</span>)</span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a>gm_mean <span class="ot">=</span> <span class="cf">function</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>, <span class="at">zero.propagate =</span> <span class="cn">FALSE</span>){</span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(x <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NaN</span>)</span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(zero.propagate){</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(x <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>(<span class="fu">mean</span>(<span class="fu">log</span>(x), <span class="at">na.rm =</span> na.rm))</span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>(<span class="fu">sum</span>(<span class="fu">log</span>(x[x <span class="sc">&gt;</span> <span class="dv">0</span>]), <span class="at">na.rm=</span>na.rm) <span class="sc">/</span> <span class="fu">length</span>(x))</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a>two_gene <span class="ot">&lt;-</span> all_tpm <span class="sc">%&gt;%</span></span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gene <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;GZMA&quot;</span>,<span class="st">&quot;PRF1&quot;</span>))</span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true" tabindex="-1"></a>two_gene <span class="sc">%&gt;%</span></span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gene) <span class="sc">%&gt;%</span></span>
<span id="cb75-137"><a href="#cb75-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> two_gene</span>
<span id="cb75-138"><a href="#cb75-138" aria-hidden="true" tabindex="-1"></a>two_gene<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(two_gene)</span>
<span id="cb75-139"><a href="#cb75-139" aria-hidden="true" tabindex="-1"></a>two_gene<span class="sc">$</span>cyt <span class="ot">&lt;-</span> <span class="fu">apply</span>(two_gene[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="dv">1</span>,gm_mean)</span>
<span id="cb75-140"><a href="#cb75-140" aria-hidden="true" tabindex="-1"></a>two_gene <span class="ot">&lt;-</span> two_gene <span class="sc">%&gt;%</span> </span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,cyt)</span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(two_gene,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/cyt_ici.rds&quot;</span>)</span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true" tabindex="-1"></a><span class="do">###Ayers gene exp signature</span></span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">&quot;CD3D&quot;</span>,<span class="st">&quot;IDO1&quot;</span>,<span class="st">&quot;CIITA&quot;</span>,<span class="st">&quot;CD3E&quot;</span>,</span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;GZMK&quot;</span>,<span class="st">&quot;CD2&quot;</span>,<span class="st">&quot;HLA-DRA&quot;</span>,<span class="st">&quot;CXCL13&quot;</span>,</span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;IL2RG&quot;</span>,<span class="st">&quot;NKG7&quot;</span>,<span class="st">&quot;HLA-E&quot;</span>,<span class="st">&quot;CXCR6&quot;</span>,<span class="st">&quot;LAG3&quot;</span>,<span class="st">&quot;TAGAP&quot;</span>,<span class="st">&quot;CXCL10&quot;</span>,<span class="st">&quot;STAT1&quot;</span>,<span class="st">&quot;GZMB&quot;</span>) <span class="sc">%in%</span> all_tpm<span class="sc">$</span>gene</span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true" tabindex="-1"></a>ayer_gene <span class="ot">&lt;-</span> all_tpm <span class="sc">%&gt;%</span></span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gene <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;CD3D&quot;</span>,<span class="st">&quot;IDO1&quot;</span>,<span class="st">&quot;CIITA&quot;</span>,<span class="st">&quot;CD3E&quot;</span>,</span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;GZMK&quot;</span>,<span class="st">&quot;CD2&quot;</span>,<span class="st">&quot;HLA-DRA&quot;</span>,<span class="st">&quot;CXCL13&quot;</span>,</span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;IL2RG&quot;</span>,<span class="st">&quot;NKG7&quot;</span>,<span class="st">&quot;HLA-E&quot;</span>,<span class="st">&quot;CXCR6&quot;</span>,<span class="st">&quot;LAG3&quot;</span>,<span class="st">&quot;TAGAP&quot;</span>,<span class="st">&quot;CXCL10&quot;</span>,<span class="st">&quot;STAT1&quot;</span>,<span class="st">&quot;GZMB&quot;</span>))</span>
<span id="cb75-153"><a href="#cb75-153" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ayer_gene) <span class="ot">&lt;-</span> ayer_gene<span class="sc">$</span>gene</span>
<span id="cb75-154"><a href="#cb75-154" aria-hidden="true" tabindex="-1"></a>ayer_gene <span class="sc">%&gt;%</span></span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gene) <span class="sc">%&gt;%</span></span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> ayer_gene</span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true" tabindex="-1"></a>ayer_gene<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(ayer_gene)</span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true" tabindex="-1"></a>ayer_gene<span class="sc">$</span>ayer_score <span class="ot">&lt;-</span> <span class="fu">apply</span>(ayer_gene[,<span class="dv">1</span><span class="sc">:</span><span class="dv">17</span>],<span class="dv">1</span>,mean)</span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true" tabindex="-1"></a>ayer_gene <span class="ot">&lt;-</span> ayer_gene <span class="sc">%&gt;%</span> </span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,ayer_score)</span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ayer_gene,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/ayer_score_ici.rds&quot;</span>)</span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true" tabindex="-1"></a><span class="do">###IMPRES</span></span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample=</span><span class="fu">colnames</span>(all_tpm)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(all_tpm)],</span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true" tabindex="-1"></a>                 <span class="at">PDCD1_TNFSF4=</span><span class="cn">NA</span>,<span class="at">CD27_PDCD1=</span><span class="cn">NA</span>,<span class="at">CTLA4_TNFSF4=</span><span class="cn">NA</span>,</span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CD40_CD28=</span><span class="cn">NA</span>, <span class="at">CD86_TNFSF4=</span><span class="cn">NA</span>, <span class="at">CD28_CD86=</span><span class="cn">NA</span>, <span class="at">CD80_TNFSF9=</span><span class="cn">NA</span>,</span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CD274_VSIR=</span><span class="cn">NA</span>, <span class="at">CD86_HAVCR2=</span><span class="cn">NA</span>, <span class="at">CD40_PDCD1=</span><span class="cn">NA</span>, <span class="at">CD86_CD200=</span><span class="cn">NA</span>, <span class="at">CD40_CD80=</span><span class="cn">NA</span>,</span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CD28_CD276=</span><span class="cn">NA</span>, <span class="at">CD40_CD274=</span><span class="cn">NA</span>,<span class="at">TNFRSF14_CD86=</span><span class="cn">NA</span>)</span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> dt<span class="sc">$</span>sample){</span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">colnames</span>(dt)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(dt)]){</span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true" tabindex="-1"></a>    genes <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(j,<span class="at">split =</span> <span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> all_tpm <span class="sc">%&gt;%</span> </span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(gene <span class="sc">%in%</span> genes) <span class="sc">%&gt;%</span> </span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(i,gene)</span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true" tabindex="-1"></a>    dt[dt<span class="sc">$</span>sample<span class="sc">==</span>i,j] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df[df<span class="sc">$</span>gene<span class="sc">==</span>genes[<span class="dv">1</span>],<span class="dv">1</span>] <span class="sc">&lt;</span> df[df<span class="sc">$</span>gene<span class="sc">==</span>genes[<span class="dv">2</span>],<span class="dv">1</span>],<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb75-177"><a href="#cb75-177" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-178"><a href="#cb75-178" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>IMPRES <span class="ot">&lt;-</span> <span class="fu">apply</span>(dt[,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(dt)],<span class="dv">1</span>,sum)</span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,IMPRES)</span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/IMPRES_ici.rds&quot;</span>)</span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true" tabindex="-1"></a><span class="do">##POPLAR</span></span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true" tabindex="-1"></a>POPLAR_gene <span class="ot">&lt;-</span> all_tpm <span class="sc">%&gt;%</span></span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gene <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;CD8A&quot;</span>, <span class="st">&quot;GZMA&quot;</span>, <span class="st">&quot;GZMB&quot;</span>,<span class="st">&quot;IFNG&quot;</span>, <span class="st">&quot;EOMES&quot;</span>, <span class="st">&quot;CXCL9&quot;</span>, <span class="st">&quot;CXCL10&quot;</span>,  <span class="st">&quot;TBX21&quot;</span>))</span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(POPLAR_gene) <span class="ot">&lt;-</span> POPLAR_gene<span class="sc">$</span>gene</span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true" tabindex="-1"></a>POPLAR_gene <span class="sc">%&gt;%</span></span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gene) <span class="sc">%&gt;%</span></span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> POPLAR_gene</span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true" tabindex="-1"></a>POPLAR_gene<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(POPLAR_gene)</span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true" tabindex="-1"></a>POPLAR_gene<span class="sc">$</span>POPLAR_score <span class="ot">&lt;-</span> <span class="fu">apply</span>(POPLAR_gene[,<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>],<span class="dv">1</span>,mean)</span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true" tabindex="-1"></a>POPLAR_gene <span class="ot">&lt;-</span> POPLAR_gene <span class="sc">%&gt;%</span> </span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample,POPLAR_score)</span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(POPLAR_gene,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/POPLAR_score_ici.rds&quot;</span>)</span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-198"><a href="#cb75-198" aria-hidden="true" tabindex="-1"></a><span class="do">##some gene</span></span>
<span id="cb75-199"><a href="#cb75-199" aria-hidden="true" tabindex="-1"></a>gene_exp <span class="ot">&lt;-</span> all_tpm <span class="sc">%&gt;%</span></span>
<span id="cb75-200"><a href="#cb75-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gene <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;CXCL9&quot;</span>,<span class="st">&quot;CD8A&quot;</span>,<span class="st">&quot;CD274&quot;</span>,<span class="st">&quot;CD38&quot;</span>,<span class="st">&quot;CXCL13&quot;</span>,<span class="st">&quot;PDCD1&quot;</span>))</span>
<span id="cb75-201"><a href="#cb75-201" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(gene_exp) <span class="ot">&lt;-</span> gene_exp<span class="sc">$</span>gene</span>
<span id="cb75-202"><a href="#cb75-202" aria-hidden="true" tabindex="-1"></a>gene_exp <span class="sc">%&gt;%</span></span>
<span id="cb75-203"><a href="#cb75-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>gene) <span class="sc">%&gt;%</span></span>
<span id="cb75-204"><a href="#cb75-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="ot">-&gt;</span> gene_exp</span>
<span id="cb75-205"><a href="#cb75-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-206"><a href="#cb75-206" aria-hidden="true" tabindex="-1"></a>gene_exp<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(gene_exp)</span>
<span id="cb75-207"><a href="#cb75-207" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gene_exp,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/need_gene_exp_ici.rds&quot;</span>)</span>
<span id="cb75-208"><a href="#cb75-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-209"><a href="#cb75-209" aria-hidden="true" tabindex="-1"></a><span class="do">##bind all</span></span>
<span id="cb75-210"><a href="#cb75-210" aria-hidden="true" tabindex="-1"></a>all_clinical <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_clinical.rds&quot;</span>)</span>
<span id="cb75-211"><a href="#cb75-211" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/nes_immunetherapy.rds&quot;</span>)</span>
<span id="cb75-212"><a href="#cb75-212" aria-hidden="true" tabindex="-1"></a>all_mut_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../../tmp/all_mut_ici_withrefalt.rds&quot;</span>)</span>
<span id="cb75-213"><a href="#cb75-213" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,all_clinical,<span class="at">by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb75-214"><a href="#cb75-214" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> neo_nes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response2))</span>
<span id="cb75-215"><a href="#cb75-215" aria-hidden="true" tabindex="-1"></a>all_ccf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_ccf.rds&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-216"><a href="#cb75-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cancer_cell_frac))</span>
<span id="cb75-217"><a href="#cb75-217" aria-hidden="true" tabindex="-1"></a><span class="co">#clonal TMB</span></span>
<span id="cb75-218"><a href="#cb75-218" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_mut_ccf_ici.rds&quot;</span>)</span>
<span id="cb75-219"><a href="#cb75-219" aria-hidden="true" tabindex="-1"></a>all_mut_ccf_ici <span class="sc">%&gt;%</span></span>
<span id="cb75-220"><a href="#cb75-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb75-221"><a href="#cb75-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">all_tmb=</span><span class="fu">n</span>()<span class="sc">/</span><span class="dv">38</span>,<span class="at">clonal_tmb=</span><span class="fu">sum</span>(cancer_cell_frac<span class="sc">&gt;=</span><span class="fl">0.9</span>)<span class="sc">/</span><span class="dv">38</span>) <span class="ot">-&gt;</span> tmb</span>
<span id="cb75-222"><a href="#cb75-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-223"><a href="#cb75-223" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,tmb)</span>
<span id="cb75-224"><a href="#cb75-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-225"><a href="#cb75-225" aria-hidden="true" tabindex="-1"></a><span class="do">##indel tmb</span></span>
<span id="cb75-226"><a href="#cb75-226" aria-hidden="true" tabindex="-1"></a>all_indel_counts <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_indel_counts.rds&quot;</span>)</span>
<span id="cb75-227"><a href="#cb75-227" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,all_indel_counts)</span>
<span id="cb75-228"><a href="#cb75-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-229"><a href="#cb75-229" aria-hidden="true" tabindex="-1"></a><span class="do">##escape NMD indel TMB</span></span>
<span id="cb75-230"><a href="#cb75-230" aria-hidden="true" tabindex="-1"></a>nes_ici_escapeNMD_indel <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/nes_ici_escapeNMD_indel.rds&quot;</span>)</span>
<span id="cb75-231"><a href="#cb75-231" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(neo_nes,nes_ici_escapeNMD_indel <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>es))</span>
<span id="cb75-232"><a href="#cb75-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-233"><a href="#cb75-233" aria-hidden="true" tabindex="-1"></a><span class="do">##signature</span></span>
<span id="cb75-234"><a href="#cb75-234" aria-hidden="true" tabindex="-1"></a><span class="co">#smoke sig4</span></span>
<span id="cb75-235"><a href="#cb75-235" aria-hidden="true" tabindex="-1"></a>sigs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/sig_ici_need.rds&quot;</span>)</span>
<span id="cb75-236"><a href="#cb75-236" aria-hidden="true" tabindex="-1"></a>sigs <span class="ot">&lt;-</span> sigs <span class="sc">%&gt;%</span> </span>
<span id="cb75-237"><a href="#cb75-237" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">smoke=</span>Signature<span class="fl">.4</span>,<span class="at">UV=</span>Signature<span class="fl">.7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-238"><a href="#cb75-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">APOBEC=</span>Signature<span class="fl">.2</span><span class="sc">+</span>Signature<span class="fl">.13</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-239"><a href="#cb75-239" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Signature<span class="fl">.13</span>,<span class="sc">-</span>Signature<span class="fl">.2</span>)</span>
<span id="cb75-240"><a href="#cb75-240" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-241"><a href="#cb75-241" aria-hidden="true" tabindex="-1"></a>  neo_nes,</span>
<span id="cb75-242"><a href="#cb75-242" aria-hidden="true" tabindex="-1"></a>  sigs</span>
<span id="cb75-243"><a href="#cb75-243" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-244"><a href="#cb75-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-245"><a href="#cb75-245" aria-hidden="true" tabindex="-1"></a><span class="do">###SERPINB3 mut</span></span>
<span id="cb75-246"><a href="#cb75-246" aria-hidden="true" tabindex="-1"></a>SERPINB3_mut <span class="ot">&lt;-</span> all_mut_ici <span class="sc">%&gt;%</span></span>
<span id="cb75-247"><a href="#cb75-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> </span>
<span id="cb75-248"><a href="#cb75-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">SERPINB3_mut=</span><span class="fu">ifelse</span>(<span class="st">&quot;SERPINB3&quot;</span> <span class="sc">%in%</span> gene,<span class="st">&quot;yes&quot;</span>,<span class="st">&quot;no&quot;</span>))</span>
<span id="cb75-249"><a href="#cb75-249" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-250"><a href="#cb75-250" aria-hidden="true" tabindex="-1"></a>  neo_nes,</span>
<span id="cb75-251"><a href="#cb75-251" aria-hidden="true" tabindex="-1"></a>  SERPINB3_mut</span>
<span id="cb75-252"><a href="#cb75-252" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-253"><a href="#cb75-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-254"><a href="#cb75-254" aria-hidden="true" tabindex="-1"></a><span class="do">##gene exp</span></span>
<span id="cb75-255"><a href="#cb75-255" aria-hidden="true" tabindex="-1"></a>need_gene_exp_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/need_gene_exp_ici.rds&quot;</span>)</span>
<span id="cb75-256"><a href="#cb75-256" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-257"><a href="#cb75-257" aria-hidden="true" tabindex="-1"></a>  neo_nes,</span>
<span id="cb75-258"><a href="#cb75-258" aria-hidden="true" tabindex="-1"></a>  need_gene_exp_ici</span>
<span id="cb75-259"><a href="#cb75-259" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-260"><a href="#cb75-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-261"><a href="#cb75-261" aria-hidden="true" tabindex="-1"></a><span class="do">###gene exp signature</span></span>
<span id="cb75-262"><a href="#cb75-262" aria-hidden="true" tabindex="-1"></a><span class="co">#Ayers IMPRES POPLAR CYT</span></span>
<span id="cb75-263"><a href="#cb75-263" aria-hidden="true" tabindex="-1"></a>ayer_score_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/ayer_score_ici.rds&quot;</span>)</span>
<span id="cb75-264"><a href="#cb75-264" aria-hidden="true" tabindex="-1"></a>IMPRES_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/IMPRES_ici.rds&quot;</span>)</span>
<span id="cb75-265"><a href="#cb75-265" aria-hidden="true" tabindex="-1"></a>POPLAR_score_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/POPLAR_score_ici.rds&quot;</span>)</span>
<span id="cb75-266"><a href="#cb75-266" aria-hidden="true" tabindex="-1"></a>cyt_ici <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/cyt_ici.rds&quot;</span>)</span>
<span id="cb75-267"><a href="#cb75-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-268"><a href="#cb75-268" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-269"><a href="#cb75-269" aria-hidden="true" tabindex="-1"></a>  neo_nes,ayer_score_ici</span>
<span id="cb75-270"><a href="#cb75-270" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(.,IMPRES_ici) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(.,POPLAR_score_ici) <span class="sc">%&gt;%</span> </span>
<span id="cb75-271"><a href="#cb75-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(.,cyt_ici)</span>
<span id="cb75-272"><a href="#cb75-272" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(neo_nes)</span>
<span id="cb75-273"><a href="#cb75-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-274"><a href="#cb75-274" aria-hidden="true" tabindex="-1"></a><span class="do">##add rna</span></span>
<span id="cb75-275"><a href="#cb75-275" aria-hidden="true" tabindex="-1"></a>neo_nes_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/nes_immunetherapy_exp.rds&quot;</span>)</span>
<span id="cb75-276"><a href="#cb75-276" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb75-277"><a href="#cb75-277" aria-hidden="true" tabindex="-1"></a>  neo_nes,</span>
<span id="cb75-278"><a href="#cb75-278" aria-hidden="true" tabindex="-1"></a>  neo_nes_exp <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,es) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">es_exp=</span>es)</span>
<span id="cb75-279"><a href="#cb75-279" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb75-280"><a href="#cb75-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-281"><a href="#cb75-281" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(neo_nes,<span class="at">file =</span> <span class="st">&quot;../data/Immunotherapy/all_factors_ici.rds&quot;</span>)</span></code></pre></div>
<p>Univariate Cox regression analysis was performed to estimate the hazard ratio (HR) associated with different factors:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>neo_nes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;../data/Immunotherapy/all_factors_ici.rds&quot;</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">show_forest</span>(neo_nes,<span class="at">covariates =</span> <span class="fu">c</span>(<span class="st">&quot;es&quot;</span>,<span class="st">&quot;es_exp&quot;</span>,<span class="fu">colnames</span>(neo_nes)[<span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">colnames</span>(neo_nes)[<span class="dv">14</span><span class="sc">:</span><span class="dv">19</span>],</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">colnames</span>(neo_nes)[<span class="dv">21</span><span class="sc">:</span><span class="dv">24</span>],<span class="st">&quot;UV&quot;</span>),</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> <span class="st">&quot;OS.time&quot;</span>,<span class="at">status =</span> <span class="st">&quot;OS&quot;</span>,<span class="at">merge_models =</span> T)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable es</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable es_exp</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable all_tmb</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable clonal_tmb</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable indel_counts</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable escape_nmd_indels</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable SERPINB3_mut</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable CD274</span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable CD38</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable CD8A</span></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable CXCL13</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable CXCL9</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable ayer_score</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable IMPRES</span></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable POPLAR_score</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable cyt</span></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; =&gt; Processing variable UV</span></span>
<span id="cb76-71"><a href="#cb76-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Surv object...</span></span>
<span id="cb76-72"><a href="#cb76-72" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Building Cox model...</span></span>
<span id="cb76-73"><a href="#cb76-73" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ==&gt; Done.</span></span>
<span id="cb76-74"><a href="#cb76-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Warning in recalculate_width_panels(panel_positions, mapped_text =</span></span>
<span id="cb76-75"><a href="#cb76-75" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; mapped_text, : Unable to resize forest panel to be smaller than its heading;</span></span>
<span id="cb76-76"><a href="#cb76-76" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; consider a smaller text size</span></span></code></pre></div>
<p><img src="report_main_files/figure-html/unnamed-chunk-48-1.svg" width="2400" /></p>
<p>In this melanoma dataset, only ESCCF and UV signature show significant HR. These new data further validate the performance of ESCCF in immune checkpoint inhibitor therapy clinical response prediction.</p>
</div>
</div>
</div>

   
   
            
      

  <script>
    $(document).ready(function () {

			
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
